<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Receiving Entry â€” Coil Purchase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Sortable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      font-size: 13px;
      color: #333;
    }

    .top-bar {
      height: 54px;
      display: flex;
      align-items: center;
      padding: 0 48px;
      background: #fff;
      border-bottom: 1px solid #e3e6ea;
    }
    .brand-main { font-size: 18px; font-weight: 600; margin-right: 6px; }
    .brand-sub { font-size: 13px; color: #7a8699; }

    .page {
      max-width: 1180px;
      margin: 32px auto;
      padding: 0 20px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 32px 40px;
      box-shadow: 0 0 0 1px rgba(15,23,42,.04), 0 14px 30px rgba(15,23,42,.08);
    }
    .card-title {
      font-size: 21px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #1f2933;
    }

    .row-flex {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
      align-items: end;
      margin-bottom: 12px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      color: #445;
    }

    .input-box {
      height: 34px !important;
      padding: 6px 10px !important;
      font-size: 13px !important;
      border: 1px solid #d3d7e3 !important;
      border-radius: 6px !important;
      background: white !important;
      width: 100%;
      box-sizing: border-box;
    }

    .choices {
      margin-bottom: 0 !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }
    .choices__inner {
      height: 34px !important;
      min-height: 34px !important;
      padding: 6px 10px !important;
      border: 1px solid #d3d7e3 !important;
      border-radius: 6px !important;
      background: white !important;
      box-shadow: none !important;
      display: flex !important;
      align-items: center !important;
      font-size: 13px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }
    .choices__placeholder { opacity: 0.6 !important; }
    .choices__list--dropdown {
      border-radius: 6px !important;
      border: 1px solid #d3d7e3 !important;
      margin-top: 4px !important;
    }
    .choices__list--dropdown .choices__item {
      padding: 7px 10px !important;
      font-size: 13px;
    }
    .choices__list--single { padding: 0 !important; }
    .choices[data-type*="select-one"]::after {
      top: 14px !important;
      right: 12px !important;
      border-color: #777 transparent transparent transparent !important;
    }
    .row-flex > div {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      background: #f5f7ff;
      border: 1px solid #dbe2ff;
      border-radius: 8px;
      padding: 18px 20px;
      margin: 16px 0 24px;
    }
    .summary-label { font-size: 12px; font-weight: 600; color: #55627a; }
    .summary-value { font-size: 13px; font-weight: 500; }

    .lock-warning {
      display: none;
      margin-bottom: 16px;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #f6c86a;
      background: #fff7e0;
      color: #8a5a19;
      font-size: 12.5px;
    }

    .table-wrapper { width: 100%; overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border: 1px solid #dde3ef;
      border-radius: 8px;
      table-layout: auto;
    }
    th {
      background: #eef2f7;
      padding: 8px;
      font-size: 12.5px;
      font-weight: 600;
      color: #445;
      text-align: left;
      white-space: nowrap;
    }
    td {
      padding: 7px;
      border-bottom: 1px solid #f1f3f6;
      vertical-align: top;
    }

    .table-input {
      width: 100%;
      padding: 6px;
      font-size: 12.5px;
      border: 1px solid #cfd7e3;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .readonly-field {
      background: #f3f4f6 !important;
      border-color: #d3d7e3 !important;
      color: #555 !important;
    }

    .row-handle { cursor: grab; color: #bbb; text-align: center; }
    .delete-btn { cursor: pointer; color: #d33; font-size: 15px; text-align: center; }

    .split-btn {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid #cfd7e3;
      background: #ecf1f8;
      cursor: pointer;
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      font-size: 13px;
      background: #f9fafb;
      border: 1px solid #ced4e1;
      border-radius: 8px;
      margin-top: 6px;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 14px;
      margin-top: 24px;
    }
    .secondary-btn {
      padding: 8px 16px;
      background: #ecf1f8;
      border: 1px solid #cfd7e3;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    .submit-btn {
      padding: 10px 26px;
      background: #0077e4;
      border-radius: 6px;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 13.5px;
      cursor: pointer;
    }
    .submit-btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(2px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 4px solid #d0d7e2;
      border-top-color: #1a73e8;
      animation: spin .85s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>

<div id="loadingOverlay"><div class="loading-spinner"></div></div>

<div class="top-bar">
  <span class="brand-main">UXILIUM</span>
  <span class="brand-sub">Receiving Entry â€” Coil Purchase</span>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">Receiving Entry (Based on PO - Purchase Coil)</div>

    <div class="row-flex">
      <div>
        <label>Receiving Date</label>
        <input type="date" id="receivingDate" class="input-box">
      </div>

      <div>
        <label>Inv Number</label>
        <select id="invSelect" class="input-box"></select>
      </div>

      <div>
        <label>Receiving ID</label>
        <input type="text" id="receivingId" class="input-box" readonly>
      </div>

      <div>
        <label>Edit Existing Receiving (Optional)</label>
        <select id="editSelect" class="input-box">
          <option value="">â€” New Receiving Entry â€”</option>
        </select>
      </div>
    </div>

    <div id="lockWarning" class="lock-warning">
      âš  This Receiving Entry is <strong>LOCKED</strong> by period closing and cannot be edited.
    </div>

    <div class="summary-grid">
      <div><div class="summary-label">Supplier</div><div id="summarySupplier" class="summary-value">-</div></div>
      <div><div class="summary-label">Invoice Date</div><div id="summaryDate" class="summary-value">-</div></div>
      <div><div class="summary-label">Status</div><div id="summaryStatus" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Ordered</div><div id="summaryTotalOrdered" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Received</div><div id="summaryTotalReceived" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Remaining</div><div id="summaryTotalRemaining" class="summary-value">-</div></div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>PO Number</th>
            <th>KPC</th>
            <th>KPC Optional</th>
            <th>Description</th>
            <th>Ordered</th>
            <th>Received</th>
            <th>Remaining</th>
            <th>Qty This Receipt</th>
            <th>UoM</th>
            <th>Split</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <label style="margin-top:18px;">Additional Notes</label>
    <textarea id="notes"></textarea>

    <div class="actions-row">
      <button class="secondary-btn" type="button" onclick="reloadINV()">Reload INV</button>
      <button id="submitBtn" class="submit-btn" type="button" onclick="submitReceiving()">Submit Receiving</button>
    </div>

  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrEmzOPogSkovEcNSQ0Va3TivzeyZ3HxNFIQOuRtb7MaYJVtgEdj1mqjBCEoU7TCJQtg/exec";

let currentINV = "";
let invChoices = null;
let editChoices = null;
let isLocked = false;
let isEditMode = false;

function showLoading(){ loadingOverlay.style.display="flex"; }
function hideLoading(){ loadingOverlay.style.display="none"; }

/* ------------ ID GENERATOR ------------ */
async function loadNextReceivingId() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getlastreceivingid`);
    const data = await res.json();

    const now = new Date();
    const yy = String(now.getFullYear()).slice(2);
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const prefix = `RCV${yy}${mm}`;

    const lastId = data.lastId;
    let nextId;

    if (!lastId || !lastId.startsWith(prefix)) {
      nextId = prefix + "0000001";
    } else {
      const lastSeq = parseInt(lastId.substring(7), 10) || 0;
      const newSeq = lastSeq + 1;
      nextId = prefix + String(newSeq).padStart(7, "0");
    }

    receivingId.value = nextId;

  } catch (e) {
    const now = new Date();
    receivingId.value = `RCV${String(now.getFullYear()).slice(2)}${String(now.getMonth()+1).padStart(2,"0")}0000001`;
  }
}

/* ------------ SUMMARY ------------ */
function renderSummary(header){
  summarySupplier.textContent       = header.supplier || "-";
  summaryDate.textContent           = header.invoiceDate || "-";
  summaryStatus.textContent         = header.status || "-";
  summaryTotalOrdered.textContent   = header.totalOrdered ?? "-";
  summaryTotalReceived.textContent  = header.totalReceived ?? "-";
  summaryTotalRemaining.textContent = header.totalRemaining ?? "-";
}

function renderSummaryFromLines(lines, supplier, lockedFlag){
  let tOrd=0, tRec=0, tRem=0;
  lines.forEach(ln=>{
    const ord = Number(ln.orderedQty) || 0;
    const recBefore = Number(ln.receivedToDate) || 0;
    const qtyThis = Number(ln.qtyThisReceipt) || 0;
    const rem = Number(ln.remainingQty) || 0;
    tOrd += ord;
    tRec += recBefore + qtyThis;
    tRem += rem;
  });

  summarySupplier.textContent = supplier || "-";
  summaryDate.textContent = "-";
  let status = "-";
  if (lockedFlag) status = "LOCKED";
  else if (tRem === 0) status = "Selesai";
  else if (tRec === 0) status = "Belum Diterima";
  else status = "Sebagian";

  summaryStatus.textContent = status;
  summaryTotalOrdered.textContent   = tOrd || (tOrd === 0 ? 0 : "-");
  summaryTotalReceived.textContent  = tRec || (tRec === 0 ? 0 : "-");
  summaryTotalRemaining.textContent = tRem || (tRem === 0 ? 0 : "-");
}

/* ------------ LOCK STATE ------------ */
function applyLockState(locked){
  isLocked = !!locked;
  const disabled = !!locked;

  document.querySelectorAll(".qty-receipt").forEach(el => el.disabled = disabled);
  document.querySelectorAll(".kpc-new").forEach(el => el.disabled = disabled);
  receivingDate.disabled = disabled;
  notes.disabled = disabled;
  submitBtn.disabled = disabled;
  lockWarning.style.display = locked ? "block" : "none";
}

/* ------------ MODE ------------ */
function enterNewMode(){
  isEditMode = false;
  if (editChoices) editChoices.setChoiceByValue("");
  invSelect.disabled = false;
  invChoices && invChoices.enable && invChoices.enable();
  applyLockState(false);
  loadNextReceivingId();
}

function enterEditMode(){
  isEditMode = true;
  invSelect.disabled = true;
  invChoices && invChoices.disable && invChoices.disable();
}

/* ------------ RENDER LINES ------------ */
function attachRowEvents(tr){
  const qtyInput = tr.querySelector(".qty-receipt");
  if (qtyInput) {
    qtyInput.addEventListener("input", e => {
      const rem = Number(tr.querySelector(".remaining").value) || 0;
      let val = Number(e.target.value || 0);
      if (val < 0) val = 0;
      if (val > rem) val = rem;
      e.target.value = val || "";
    });
  }

  const del = tr.querySelector(".delete-btn");
  if (del) {
    del.addEventListener("click", e => {
      e.target.closest("tr").remove();
    });
  }

  const splitBtn = tr.querySelector(".split-btn");
  if (splitBtn) {
    splitBtn.addEventListener("click", () => addSplitRow(tr));
  }
}

function renderLines(lines, useExistingQty){
  tableBody.innerHTML = "";

  lines.forEach(ln=>{
    const tr = document.createElement("tr");
    tr.dataset.rowIndex = ln.rowIndex;

    const remaining = Number(ln.remainingQty) || 0;
    const defaultQty = useExistingQty ? (Number(ln.qtyThisReceipt) || 0) : remaining;

    tr.innerHTML = `
      <td class="row-handle">â‹®â‹®</td>
      <td>${ln.poNumber}</td>
      <td><strong class="kpc-original">${ln.kpc}</strong></td>
      <td><input class="table-input kpc-new" placeholder="(optional)"></td>
      <td>${ln.description}</td>
      <td><input class="table-input readonly-field ordered" value="${ln.orderedQty}" readonly></td>
      <td><input class="table-input readonly-field received" value="${ln.receivedToDate}" readonly></td>
      <td><input class="table-input readonly-field remaining" value="${remaining}" readonly></td>
      <td><input type="number" class="table-input qty-receipt" value="${defaultQty}" min="0"></td>
      <td><input class="table-input readonly-field" value="${ln.uom || 'Meter'}" readonly></td>
      <td style="text-align:center;"><button type="button" class="split-btn">ï¼‹</button></td>
      <td class="delete-btn">ðŸ—‘</td>
    `;

    tableBody.appendChild(tr);
    attachRowEvents(tr);
  });

  Sortable.create(tableBody,{handle:".row-handle",animation:150});
  applyLockState(isLocked);
}

/* ------------ SPLIT ROW ------------ */
function addSplitRow(baseTr){
  const clone = baseTr.cloneNode(true);
  clone.dataset.rowIndex = baseTr.dataset.rowIndex;

  // clear KPC optional & qty
  const newKpcInput = clone.querySelector(".kpc-new");
  if (newKpcInput) newKpcInput.value = "";
  const qtyInput = clone.querySelector(".qty-receipt");
  if (qtyInput) qtyInput.value = "";

  tableBody.insertBefore(clone, baseTr.nextSibling);
  attachRowEvents(clone);
}

/* ------------ LOAD INV LIST ------------ */
async function loadInvList(){
  const res = await fetch(`${SCRIPT_URL}?action=getinvlist`);
  const list = await res.json();

  if (invChoices) invChoices.destroy();
  invSelect.innerHTML = `<option value="">â€” Select INV â€”</option>`;

  list.forEach(x => {
    const op = document.createElement("option");
    op.value = op.textContent = x.invNumber;
    invSelect.appendChild(op);
  });

  invChoices = new Choices("#invSelect",{
    searchEnabled:true,
    itemSelectText:"",
    shouldSort:false
  });

  invSelect.addEventListener("change",()=>{
    if(!isEditMode && invSelect.value){
      currentINV = invSelect.value;
      loadInvDetail(invSelect.value);
      loadEditableReceivingList(); // refresh edit list juga
    }
  });
}

/* ------------ EDITABLE RECEIVING LIST (GLOBAL) ------------ */
async function loadEditableReceivingList(){
  const res = await fetch(`${SCRIPT_URL}?action=geteditablelist`);
  if (!res.ok) return; // jika belum ada endpoint ini, diamkan saja
  const list = await res.json();

  if (editChoices) editChoices.destroy();
  editSelect.innerHTML = `<option value="">â€” New Receiving Entry â€”</option>`;

  list.forEach(item=>{
    const op = document.createElement("option");
    op.value = item.receivingId;
    op.textContent = `${item.receivingId} â€” ${item.invNumber || ''}`;
    editSelect.appendChild(op);
  });

  editChoices = new Choices("#editSelect",{
    searchEnabled:true,
    itemSelectText:"",
    shouldSort:false
  });

  editSelect.addEventListener("change",()=>{
    const id = editSelect.value;
    if(!id){
      enterNewMode();
      if (invSelect.value) {
        currentINV = invSelect.value;
        loadInvDetail(invSelect.value);
      } else {
        tableBody.innerHTML = "";
        renderSummary({supplier:"-",invoiceDate:"-",status:"-",totalOrdered:"-",totalReceived:"-",totalRemaining:"-"});
      }
      return;
    }
    loadReceivingEntry(id);
  });
}

/* ------------ LOAD INV DETAIL (NEW MODE) ------------ */
async function loadInvDetail(inv){
  if (!inv) return;
  showLoading();
  try{
    const res = await fetch(`${SCRIPT_URL}?action=getinvdetail&invNumber=${encodeURIComponent(inv)}`);
    const data = await res.json();
    currentINV = inv;

    renderSummary(data.header);
    renderLines(data.lines, false);
    applyLockState(false);
  } finally {
    hideLoading();
  }
}

/* ------------ LOAD EXISTING RECEIVING (EDIT MODE) ------------ */
async function loadReceivingEntry(rcvId){
  if(!rcvId) return;
  showLoading();
  try{
    const res = await fetch(`${SCRIPT_URL}?action=loadreceiving&id=${encodeURIComponent(rcvId)}`);
    const data = await res.json();

    enterEditMode();
    currentINV = data.invNumber || "";

    receivingId.value   = data.receivingId;
    if (data.receivingDate) receivingDate.value = data.receivingDate;
    notes.value         = data.notes || "";

    renderLines(data.lines, true);
    renderSummaryFromLines(data.lines, data.header && data.header.supplier, data.locked);
    applyLockState(data.locked);
  } finally {
    hideLoading();
  }
}

/* ------------ RELOAD ------------ */
function reloadINV(){
  if(isEditMode && editSelect.value){
    loadReceivingEntry(editSelect.value);
  } else if (invSelect.value){
    loadInvDetail(invSelect.value);
  }
}

/* ------------ VALIDATION & SUBMIT ------------ */
function validateForm(){
  if(isLocked) return "This Receiving Entry is locked and cannot be edited.";
  if(!receivingDate.value) return "Receiving Date required.";

  if(!isEditMode && !invSelect.value) {
    return "Inv Number required.";
  }

  const rows=[...document.querySelectorAll("#tableBody tr")];
  if(rows.length===0) return "No line items found.";

  // basic per-row check
  let anyQty = false;
  for(const r of rows){
    const qty = +r.querySelector(".qty-receipt").value || 0;
    const rem = +r.querySelector(".remaining").value || 0;
    if(qty > rem) return "Qty cannot exceed remaining.";
    if(qty > 0) anyQty = true;
  }
  if(!anyQty) return "At least one line must have Qty > 0.";

  // group check by rowIndex
  const groups = {};
  rows.forEach(r=>{
    const idx = r.dataset.rowIndex || "";
    const qty = +r.querySelector(".qty-receipt").value || 0;
    const rem = +r.querySelector(".remaining").value || 0;
    if (!groups[idx]) groups[idx] = {sum:0, remaining:rem, rows:[]};
    groups[idx].sum += qty;
    groups[idx].rows.push(r);
  });

  for (const key in groups){
    const g = groups[key];
    if (g.sum > g.remaining){
      return `Total Qty for one PO line exceeds Remaining (${g.sum} > ${g.remaining}).`;
    }
    if (g.rows.length > 1){
      // splitted lines: each line with qty > 0 must have new KPC
      for (const r of g.rows){
        const qty = +r.querySelector(".qty-receipt").value || 0;
        if (qty > 0) {
          const newKpc = r.querySelector(".kpc-new").value.trim();
          if (!newKpc) {
            return "Split lines: every line with Qty must have KPC Optional filled.";
          }
        }
      }
    }
  }

  return null;
}

function submitReceiving(){
  const err = validateForm();
  if(err) return alert(err);

  showLoading();

  const rows = [...document.querySelectorAll("#tableBody tr")];

  const lines = rows.map(r=>{
    const poNumber = r.children[1].textContent.trim();
    const kpcOriginal = r.querySelector(".kpc-original").textContent.trim();
    const newKpc = r.querySelector(".kpc-new").value.trim();
    const kpcFinal = newKpc || kpcOriginal;

    return {
      rowIndex: r.dataset.rowIndex,
      poNumber: poNumber,
      kpc: kpcFinal,
      description: r.children[4].textContent.trim(),
      orderedQty: r.querySelector(".ordered").value,
      receivedToDate: r.querySelector(".received").value,
      remainingQty: r.querySelector(".remaining").value,
      qtyThisReceipt: r.querySelector(".qty-receipt").value,
      uom: "Meter"
    };
  });

  const payload = {
    receivingId: receivingId.value,
    receivingDate: receivingDate.value,
    invNumber: currentINV || invSelect.value || "",
    header: { supplier: summarySupplier.textContent || "" },
    notes: notes.value,
    lines: lines
  };

  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(async res=>{
    hideLoading();
    if(res.status==="success"){
      alert("Receiving saved.\nReceiving ID: "+payload.receivingId);

      // refresh editable list
      await loadEditableReceivingList().catch(()=>{});

      // back to NEW MODE
      enterNewMode();
      if (invSelect.value) {
        currentINV = invSelect.value;
        loadInvDetail(invSelect.value);
      } else {
        tableBody.innerHTML = "";
        renderSummary({supplier:"-",invoiceDate:"-",status:"-",totalOrdered:"-",totalReceived:"-",totalRemaining:"-"});
      }
    } else {
      alert("Error: "+res.message);
    }
  })
  .catch(err=>{
    hideLoading();
    alert("Submit failed: "+err);
  });
}

/* ------------ INIT ------------ */
window.addEventListener("DOMContentLoaded",async()=>{
  showLoading();

  const t = new Date();
  receivingDate.value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;

  await Promise.all([
    loadNextReceivingId(),
    loadInvList(),
    loadEditableReceivingList().catch(()=>{})
  ]);

  hideLoading();
});
</script>

</body>
</html>
