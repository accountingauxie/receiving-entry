<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Receiving Entry â€” Coil Purchase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Sortable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <style>
    :root {
      --ux-blue: #0077e4;
      --ux-blue-soft: #ecf4ff;
      --ux-border: #d3d7e3;
      --ux-border-soft: #e5e9f2;
      --ux-bg: #f5f7fa;
      --ux-text-main: #1f2933;
      --ux-text-sub: #55627a;
      --ux-danger: #d33;
    }

    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--ux-bg);
      font-family: "Segoe UI", Roboto, sans-serif;
      font-size: 13px;
      color: #333;
    }

    .top-bar {
      height: 54px;
      display: flex;
      align-items: center;
      padding: 0 48px;
      background: #fff;
      border-bottom: 1px solid #e3e6ea;
    }
    .brand-main {
      font-size: 18px;
      font-weight: 600;
      margin-right: 6px;
      letter-spacing: 0.04em;
    }
    .brand-sub {
      font-size: 13px;
      color: #7a8699;
    }

    .page {
      max-width: 1180px;
      margin: 32px auto;
      padding: 0 20px 40px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 28px 32px 30px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.03),
        0 18px 40px rgba(15, 23, 42, 0.08);
    }
    .card-title {
      font-size: 21px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--ux-text-main);
    }

    .row-flex {
      display: grid;
      grid-template-columns: 1.1fr 1.5fr 1.3fr 1.7fr;
      gap: 20px;
      align-items: end;
      margin-bottom: 12px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      color: #445;
    }

    .input-box {
      height: 34px !important;
      padding: 6px 10px !important;
      font-size: 13px !important;
      border: 1px solid var(--ux-border) !important;
      border-radius: 6px !important;
      background: white !important;
      width: 100%;
    }

    .choices {
      margin-bottom: 0 !important;
      width: 100% !important;
    }
    .choices__inner {
      height: 34px !important;
      min-height: 34px !important;
      padding: 4px 8px !important;
      border: 1px solid var(--ux-border) !important;
      border-radius: 6px !important;
      background: white !important;
      box-shadow: none !important;
      display: flex !important;
      align-items: center !important;
      font-size: 13px !important;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      background: #f7f8ff;
      border: 1px solid #dbe2ff;
      border-radius: 9px;
      padding: 14px 18px;
      margin: 16px 0 20px;
    }
    .summary-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--ux-text-sub);
      letter-spacing: 0.04em;
      margin-bottom: 2px;
    }
    .summary-value {
      font-size: 13px;
      font-weight: 500;
      color: var(--ux-text-main);
    }

    .lock-warning {
      display: none;
      margin-bottom: 10px;
      padding: 9px 11px;
      border-radius: 6px;
      border: 1px solid #f6c86a;
      background: #fff7e0;
      color: #8a5a19;
      font-size: 12.5px;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--ux-border-soft);
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    thead {
      background: #eef2f7;
    }
    th {
      padding: 8px 8px;
      font-size: 12px;
      font-weight: 600;
      color: #465166;
      text-align: left;
      white-space: nowrap;
      border-bottom: 1px solid var(--ux-border-soft);
    }
    td {
      padding: 6px 7px;
      border-bottom: 1px solid #f1f3f6;
      font-size: 12.5px;
    }

    .row-handle {
      cursor: grab;
      color: #b4bac7;
      text-align: center;
      font-size: 16px;
      user-select: none;
      width: 26px;
    }

    .readonly-field {
      background: #f3f4f6 !important;
      border-color: #d3d7e3 !important;
      color: #555 !important;
    }

    textarea {
      width: 100%;
      height: 110px;
      padding: 9px 10px;
      font-size: 13px;
      background: #f9fafb;
      border: 1px solid #ced4e1;
      border-radius: 8px;
      margin-top: 6px;
      resize: vertical;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .secondary-btn {
      padding: 8px 14px;
      background: #ecf1f8;
      border: 1px solid #cfd7e3;
      border-radius: 6px;
      cursor: pointer;
    }
    .submit-btn {
      padding: 9px 22px;
      background: var(--ux-blue);
      border-radius: 6px;
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(2px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 4px solid #d0d7e2;
      border-top-color: #1a73e8;
      animation: spin .85s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>

<body>

<div id="loadingOverlay"><div class="loading-spinner"></div></div>

<div class="top-bar">
  <span class="brand-main">UXILIUM</span>
  <span class="brand-sub">Receiving Entry â€” Coil Purchase</span>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">Receiving Entry (Based on PO - Purchase Coil)</div>

    <div class="row-flex">
      <div>
        <label>Receiving Date</label>
        <input type="date" id="receivingDate" class="input-box">
      </div>

      <div>
        <label>Inv Number</label>
        <select id="invSelect" class="input-box"></select>
      </div>

      <div>
        <label>Receiving ID</label>
        <input type="text" id="receivingId" class="input-box" readonly>
      </div>

      <div>
        <label>Edit Existing Receiving (Optional)</label>
        <select id="editSelect" class="input-box">
          <option value="">â€” New Receiving Entry â€”</option>
        </select>
      </div>
    </div>

    <div id="lockWarning" class="lock-warning">
      âš  This Receiving Entry is <strong>LOCKED</strong> by period closing and cannot be edited.
    </div>

    <div class="summary-grid">
      <div><div class="summary-label">Supplier</div><div id="summarySupplier" class="summary-value">-</div></div>
      <div><div class="summary-label">Invoice Date</div><div id="summaryDate" class="summary-value">-</div></div>
      <div><div class="summary-label">Status</div><div id="summaryStatus" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Ordered</div><div id="summaryTotalOrdered" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Received</div><div id="summaryTotalReceived" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Remaining</div><div id="summaryTotalRemaining" class="summary-value">-</div></div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th style="width:28px;"></th>
            <th>PO Number</th>
            <th>Item Code</th>
            <th>KPC</th>
            <th>Description</th>
            <th>Ordered</th>
            <th>Received</th>
            <th>Remaining</th>
            <th>Qty This Receipt</th>
            <th>Harga/m</th>
            <th>UoM</th>
            <th>Split</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <label style="margin-top:18px;">Additional Notes</label>
    <textarea id="notes"></textarea>

    <div class="actions-row">
      <button class="secondary-btn" type="button" onclick="reloadINV()">Reload INV</button>
      <button id="submitBtn" class="submit-btn" type="button" onclick="submitReceiving()">Submit Receiving</button>
    </div>

  </div>
</div>
<script>
/* ============================================================
   CONFIG
============================================================ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcShs4XqW_c5O5FRDyyVJw3YQZ4hRXmACKySLdk0RiX0gpJlEuomwOaNou9G5OBbVARg/exec";   // â† GANTI DENGAN URL WEB APP MU

let currentINV = "";
let invChoices = null;
let editChoices = null;
let isLocked = false;
let isEditMode = false;

/* DOM */
const loadingOverlay = document.getElementById("loadingOverlay");
const tableBody = document.getElementById("tableBody");
const receivingDate = document.getElementById("receivingDate");
const receivingId = document.getElementById("receivingId");
const invSelect = document.getElementById("invSelect");
const editSelect = document.getElementById("editSelect");
const notes = document.getElementById("notes");
const submitBtn = document.getElementById("submitBtn");
const lockWarning = document.getElementById("lockWarning");

const summarySupplier = document.getElementById("summarySupplier");
const summaryDate = document.getElementById("summaryDate");
const summaryStatus = document.getElementById("summaryStatus");
const summaryTotalOrdered = document.getElementById("summaryTotalOrdered");
const summaryTotalReceived = document.getElementById("summaryTotalReceived");
const summaryTotalRemaining = document.getElementById("summaryTotalRemaining");

/* ============================================================
   LOADING OVERLAY
============================================================ */
function showLoading() { loadingOverlay.style.display = "flex"; }
function hideLoading() { loadingOverlay.style.display = "none"; }

/* ============================================================
   ID GENERATOR (RCVYYMMxxxxxxx)
============================================================ */
async function loadNextReceivingId() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getlastreceivingid`);
    const data = await res.json();

    const now = new Date();
    const yy = String(now.getFullYear()).slice(2);
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const prefix = `RCV${yy}${mm}`;

    const lastId = data.lastId;
    let nextId;

    if (!lastId || !lastId.startsWith(prefix)) {
      nextId = prefix + "0000001";
    } else {
      const lastSeq = parseInt(lastId.substring(7), 10) || 0;
      nextId = prefix + String(lastSeq + 1).padStart(7, "0");
    }

    receivingId.value = nextId;
  } catch (e) {
    const now = new Date();
    receivingId.value =
      `RCV${String(now.getFullYear()).slice(2)}${String(
        now.getMonth() + 1
      ).padStart(2, "0")}0000001`;
  }
}

/* ============================================================
   SUMMARY (HEADER DETAIL)
============================================================ */
function renderSummary(header) {
  summarySupplier.textContent = header.supplier || "-";
  summaryDate.textContent = header.invoiceDate || "-";
  summaryStatus.textContent = header.status || "-";
  summaryTotalOrdered.textContent = header.totalOrdered ?? "-";
  summaryTotalReceived.textContent = header.totalReceived ?? "-";
  summaryTotalRemaining.textContent = header.totalRemaining ?? "-";
}

function renderSummaryFromLines(lines, supplier, lockedFlag) {
  let tOrd = 0, tRec = 0, tRem = 0;

  lines.forEach((ln) => {
    const ord = Number(ln.orderedQty) || 0;
    const recBefore = Number(ln.receivedToDate) || 0;
    const qtyThis = Number(ln.qtyThisReceipt) || 0;
    const rem = Number(ln.remainingQty) || 0;

    tOrd += ord;
    tRec += recBefore + qtyThis;
    tRem += rem;
  });

  summarySupplier.textContent = supplier || "-";
  summaryDate.textContent = "-";

  let status = "-";
  if (lockedFlag) status = "LOCKED";
  else if (tRem === 0) status = "Selesai";
  else if (tRec === 0) status = "Belum Diterima";
  else status = "Sebagian";

  summaryStatus.textContent = status;
  summaryTotalOrdered.textContent = tOrd;
  summaryTotalReceived.textContent = tRec;
  summaryTotalRemaining.textContent = tRem;
}

/* ============================================================
   LOCK STATE
============================================================ */
function applyLockState(locked) {
  isLocked = !!locked;

  document.querySelectorAll(".qty-receipt").forEach((el) => (el.disabled = locked));
  document.querySelectorAll(".kpc-new").forEach((el) => (el.disabled = locked));
  receivingDate.disabled = locked;
  notes.disabled = locked;
  submitBtn.disabled = locked;

  lockWarning.style.display = locked ? "block" : "none";
}

/* ============================================================
   MODE HANDLING
============================================================ */
function enterNewMode() {
  isEditMode = false;
  editChoices && editChoices.setChoiceByValue("");
  invSelect.disabled = false;
  invChoices && invChoices.enable && invChoices.enable();
  applyLockState(false);
  loadNextReceivingId();
}

function enterEditMode() {
  isEditMode = true;
  invSelect.disabled = true;
  invChoices && invChoices.disable && invChoices.disable();
}

/* ============================================================
   ROW EVENTS (qty validation, delete, split)
============================================================ */
function attachRowEvents(tr) {
  const qtyInput = tr.querySelector(".qty-receipt");
  if (qtyInput) {
    qtyInput.addEventListener("input", (e) => {
      const rem = Number(tr.querySelector(".remaining").value) || 0;
      let val = Number(e.target.value || 0);
      if (val < 0) val = 0;
      if (val > rem) val = rem;
      e.target.value = val || "";
    });
  }

  const del = tr.querySelector(".delete-btn");
  if (del) {
    del.addEventListener("click", () => {
      tr.remove();
    });
  }

  const splitBtn = tr.querySelector(".split-btn");
  if (splitBtn) {
    splitBtn.addEventListener("click", () => addSplitRow(tr));
  }
}

/* ============================================================
   RENDER TABLE ROWS
============================================================ */
function renderLines(lines, useExistingQty) {
  tableBody.innerHTML = "";

  lines.forEach((ln) => {
    const tr = document.createElement("tr");
    tr.dataset.rowIndex = ln.rowIndex;

    const remaining = Number(ln.remainingQty) || 0;
    const defaultQty = useExistingQty ? Number(ln.qtyThisReceipt || 0) : remaining;

    tr.innerHTML = `
      <td class="row-handle">â‹®â‹®</td>
      <td>${ln.poNumber}</td>
      <td><span class="item-code">${ln.itemCode || "-"}</span></td>
      <td><input class="table-input kpc-new" placeholder="(required)" value="${ln.kpc || ""}"></td>
      <td>${ln.description}</td>
      <td><input class="table-input readonly-field ordered" value="${ln.orderedQty}" readonly></td>
      <td><input class="table-input readonly-field received" value="${ln.receivedToDate}" readonly></td>
      <td><input class="table-input readonly-field remaining" value="${remaining}" readonly></td>
      <td><input type="number" class="table-input qty-receipt" value="${defaultQty}" min="0"></td>
      <td><input class="table-input readonly-field price" value="${ln.price || 0}" readonly></td>
      <td><input class="table-input readonly-field" value="${ln.uom || "Meter"}" readonly></td>
      <td style="text-align:center;">
        <button type="button" class="split-btn" title="Split this line">
          <span class="split-icon"></span>
        </button>
      </td>
      <td class="delete-btn">ðŸ—‘</td>
    `;

    tableBody.appendChild(tr);
    attachRowEvents(tr);
  });

  /* Enable drag sorting */
  Sortable.create(tableBody, { handle: ".row-handle", animation: 150 });

  applyLockState(isLocked);
}

/* ============================================================
   SPLIT ROW
============================================================ */
function addSplitRow(baseTr) {
  const clone = baseTr.cloneNode(true);
  clone.dataset.rowIndex = baseTr.dataset.rowIndex;

  clone.querySelector(".kpc-new").value = "";
  clone.querySelector(".qty-receipt").value = "";

  tableBody.insertBefore(clone, baseTr.nextSibling);
  attachRowEvents(clone);
}
/* ============================================================
   LOAD INV LIST (NEW MODE)
============================================================ */
async function loadInvList() {
  const res = await fetch(`${SCRIPT_URL}?action=getinvlist`);
  const list = await res.json();

  if (invChoices) invChoices.destroy();
  invSelect.innerHTML = `<option value="">â€” Select INV â€”</option>`;

  list.forEach((x) => {
    const op = document.createElement("option");
    op.value = op.textContent = x.invNumber;
    invSelect.appendChild(op);
  });

  invChoices = new Choices("#invSelect", {
    searchEnabled: true,
    itemSelectText: "",
    shouldSort: false,
  });

  invSelect.addEventListener("change", () => {
    if (!isEditMode && invSelect.value) {
      currentINV = invSelect.value;
      loadInvDetail(invSelect.value);
    }
  });
}

/* ============================================================
   LOAD EDITABLE RECEIVING LIST
============================================================ */
async function loadEditableReceivingList() {
  const res = await fetch(`${SCRIPT_URL}?action=geteditablelist`);
  const list = await res.json();

  if (editChoices) editChoices.destroy();
  editSelect.innerHTML = `<option value="">â€” New Receiving Entry â€”</option>`;

  list.forEach((item) => {
    const op = document.createElement("option");
    op.value = item.receivingId;
    op.textContent = `${item.receivingId} â€” ${item.invNumber || ''}`;
    editSelect.appendChild(op);
  });

  editChoices = new Choices("#editSelect", {
    searchEnabled: true,
    itemSelectText: "",
    shouldSort: false,
  });

  editSelect.addEventListener("change", () => {
    const id = editSelect.value;
    if (!id) {
      enterNewMode();
      if (invSelect.value) {
        currentINV = invSelect.value;
        loadInvDetail(invSelect.value);
      } else {
        tableBody.innerHTML = "";
        renderSummary({
          supplier: "-",
          invoiceDate: "-",
          status: "-",
          totalOrdered: "-",
          totalReceived: "-",
          totalRemaining: "-",
        });
      }
      return;
    }

    loadReceivingEntry(id);
  });
}

/* ============================================================
   LOAD INV DETAIL (NEW MODE)
============================================================ */
async function loadInvDetail(inv) {
  if (!inv) return;

  showLoading();
  try {
    const res = await fetch(
      `${SCRIPT_URL}?action=getinvdetail&invNumber=${encodeURIComponent(inv)}`
    );
    const data = await res.json();
    currentINV = inv;

    renderSummary(data.header);
    renderLines(data.lines, false);
    applyLockState(false);
  } finally {
    hideLoading();
  }
}

/* ============================================================
   LOAD EXISTING RECEIVING (EDIT MODE)
============================================================ */
async function loadReceivingEntry(rcvId) {
  if (!rcvId) return;
  showLoading();

  try {
    const res = await fetch(
      `${SCRIPT_URL}?action=loadreceiving&id=${encodeURIComponent(rcvId)}`
    );
    const data = await res.json();

    enterEditMode();
    currentINV = data.invNumber || "";

    receivingId.value = data.receivingId;
    if (data.receivingDate) receivingDate.value = data.receivingDate;
    notes.value = data.notes || "";

    renderLines(data.lines, true);
    renderSummaryFromLines(
      data.lines,
      data.header && data.header.supplier,
      data.locked
    );
    applyLockState(data.locked);
  } finally {
    hideLoading();
  }
}

/* ============================================================
   RELOAD BUTTON
============================================================ */
function reloadINV() {
  if (isEditMode && editSelect.value) {
    loadReceivingEntry(editSelect.value);
  } else if (invSelect.value) {
    loadInvDetail(invSelect.value);
  }
}

/* ============================================================
   VALIDATION BEFORE SUBMIT
============================================================ */
function validateForm() {
  if (isLocked) return "This Receiving Entry is locked and cannot be edited.";
  if (!receivingDate.value) return "Receiving Date required.";
  if (!isEditMode && !invSelect.value) return "Inv Number required.";

  const rows = [...document.querySelectorAll("#tableBody tr")];
  if (rows.length === 0) return "No line items found.";

  let anyQty = false;

  /* Row-level checks */
  for (const r of rows) {
    const qty = +r.querySelector(".qty-receipt").value || 0;
    const rem = +r.querySelector(".remaining").value || 0;
    const kpcVal = r.querySelector(".kpc-new").value.trim();

    if (qty > rem) return "Qty cannot exceed Remaining.";
    if (qty > 0) anyQty = true;
    if (qty > 0 && !kpcVal) return "KPC is required for every line with Qty.";
  }

  if (!anyQty) return "At least one line must have Qty > 0.";

  return null;
}

/* ============================================================
   SUBMIT
============================================================ */
function submitReceiving() {
  const err = validateForm();
  if (err) return alert(err);

  showLoading();

  const rows = [...document.querySelectorAll("#tableBody tr")];

  const lines = rows.map((r) => {
    return {
      rowIndex: r.dataset.rowIndex,
      poNumber: r.children[1].textContent.trim(),
      itemCode: r.children[2].textContent.trim(),
      kpc: r.querySelector(".kpc-new").value.trim(),
      description: r.children[4].textContent.trim(),
      orderedQty: r.querySelector(".ordered").value,
      receivedToDate: r.querySelector(".received").value,
      remainingQty: r.querySelector(".remaining").value,
      qtyThisReceipt: r.querySelector(".qty-receipt").value,
      price: r.querySelector(".price").value,
      uom: "Meter",
    };
  });

  const payload = {
    receivingId: receivingId.value,
    receivingDate: receivingDate.value,
    invNumber: currentINV || invSelect.value || "",
    header: { supplier: summarySupplier.textContent || "" },
    notes: notes.value,
    lines: lines,
  };

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(payload),
  })
    .then((r) => r.json())
    .then(async (res) => {
      hideLoading();

      if (res.status === "success") {
        alert("Receiving saved.\nReceiving ID: " + payload.receivingId);

        await loadEditableReceivingList();
        enterNewMode();

        if (invSelect.value) {
          currentINV = invSelect.value;
          loadInvDetail(invSelect.value);
        } else {
          tableBody.innerHTML = "";
          renderSummary({
            supplier: "-",
            invoiceDate: "-",
            status: "-",
            totalOrdered: "-",
            totalReceived: "-",
            totalRemaining: "-",
          });
        }
      } else {
        alert("Error: " + res.message);
      }
    })
    .catch((err) => {
      hideLoading();
      alert("Submit failed: " + err);
    });
}

/* ============================================================
   INIT
============================================================ */
window.addEventListener("DOMContentLoaded", async () => {
  showLoading();

  const t = new Date();
  receivingDate.value = `${t.getFullYear()}-${String(
    t.getMonth() + 1
  ).padStart(2, "0")}-${String(t.getDate()).padStart(2, "0")}`;

  await Promise.all([
    loadNextReceivingId(),
    loadInvList(),
    loadEditableReceivingList(),
  ]);

  hideLoading();
});
</script>
</body>
</html>
