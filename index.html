<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Receiving Entry â€” Coil Purchase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Sortable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      font-size: 13px;
      color: #333;
    }

    /* Top Bar */
    .top-bar {
      height: 54px;
      display: flex;
      align-items: center;
      padding: 0 48px;
      background: #fff;
      border-bottom: 1px solid #e3e6ea;
    }
    .brand-main { font-size: 18px; font-weight: 600; margin-right: 6px; }
    .brand-sub { font-size: 13px; color: #7a8699; }

    /* Page */
    .page {
      max-width: 1180px;
      margin: 32px auto;
      padding: 0 20px;
    }

    /* Card */
    .card {
      background: white;
      border-radius: 10px;
      padding: 32px 40px;
      box-shadow: 0 0 0 1px rgba(15,23,42,.04), 0 14px 30px rgba(15,23,42,.08);
    }
    .card-title {
      font-size: 21px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #1f2933;
    }

    /* 4 Column Layout */
    .row-flex {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 24px;
      align-items: end;
      margin-bottom: 26px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      color: #445;
    }

    /* Standard Input */
    .input-box {
      height: 34px !important;
      padding: 6px 10px !important;
      font-size: 13px !important;
      border: 1px solid #d3d7e3 !important;
      border-radius: 6px !important;
      background: white !important;
      width: 100%;
      box-sizing: border-box;
    }

    .input-box[disabled],
    textarea[disabled] {
      background: #f3f4f6 !important;
      cursor: not-allowed;
    }

    /* Choices.js â€” identical to input-box */
    .choices {
      margin-bottom: 0 !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    .choices__inner {
      height: 34px !important;
      min-height: 34px !important;
      padding: 6px 10px !important;
      border: 1px solid #d3d7e3 !important;
      border-radius: 6px !important;
      background: white !important;
      box-shadow: none !important;
      display: flex !important;
      align-items: center !important;
      font-size: 13px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    .choices__placeholder { opacity: 0.6 !important; }

    .choices__list--dropdown {
      border-radius: 6px !important;
      border: 1px solid #d3d7e3 !important;
      margin-top: 4px !important;
    }
    .choices__list--dropdown .choices__item {
      padding: 7px 10px !important;
      font-size: 13px;
    }
    .choices__list--single {
      padding: 0 !important;
    }
    .choices[data-type*="select-one"]::after {
      top: 14px !important;
      right: 12px !important;
      border-color: #777 transparent transparent transparent !important;
    }

    .row-flex > div {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Summary Box */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      background: #f5f7ff;
      border: 1px solid #dbe2ff;
      border-radius: 8px;
      padding: 18px 20px;
      margin-bottom: 24px;
    }
    .summary-label { font-size: 12px; font-weight: 600; color: #55627a; }
    .summary-value { font-size: 13px; font-weight: 500; }

    /* Table */
    .table-wrapper { width: 100%; overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border: 1px solid #dde3ef;
      border-radius: 8px;
      table-layout: auto;
    }
    th {
      background: #eef2f7;
      padding: 8px;
      font-size: 12.5px;
      font-weight: 600;
      color: #445;
      text-align: left;
      white-space: nowrap;
    }
    td {
      padding: 7px;
      border-bottom: 1px solid #f1f3f6;
      vertical-align: top;
    }

    /* Input in Table */
    .table-input {
      width: 100%;
      padding: 6px;
      font-size: 12.5px;
      border: 1px solid #cfd7e3;
      border-radius: 6px;
      box-sizing: border-box;
    }

    /* Readonly Input */
    .readonly-field {
      background: #f3f4f6 !important;
      border-color: #d3d7e3 !important;
      color: #555 !important;
    }

    .row-handle { cursor: grab; color: #bbb; text-align: center; }
    .delete-btn { cursor: pointer; color: #d33; font-size: 15px; text-align: center; }

    /* Notes */
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      font-size: 13px;
      background: #f9fafb;
      border: 1px solid #ced4e1;
      border-radius: 8px;
      margin-top: 6px;
      box-sizing: border-box;
    }

    /* Buttons */
    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 14px;
      margin-top: 24px;
    }
    .secondary-btn {
      padding: 8px 16px;
      background: #ecf1f8;
      border: 1px solid #cfd7e3;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    .submit-btn {
      padding: 10px 26px;
      background: #0077e4;
      border-radius: 6px;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 13.5px;
      cursor: pointer;
    }
    .submit-btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    /* Loading Overlay */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(2px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 4px solid #d0d7e2;
      border-top-color: #1a73e8;
      animation: spin .85s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>

<div id="loadingOverlay"><div class="loading-spinner"></div></div>

<div class="top-bar">
  <span class="brand-main">UXILIUM</span>
  <span class="brand-sub">Receiving Entry â€” Coil Purchase</span>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">Receiving Entry (Based on PO - Purchase Coil)</div>

    <!-- Header 4 Columns -->
    <div class="row-flex">
      <div>
        <label>Receiving Date</label>
        <input type="date" id="receivingDate" class="input-box">
      </div>

      <div>
        <label>Inv Number</label>
        <select id="invSelect" class="input-box"></select>
      </div>

      <div>
        <label>Receiving ID</label>
        <input type="text" id="receivingId" class="input-box" readonly>
      </div>

      <div>
        <label>Edit Existing Receiving (Optional)</label>
        <select id="editReceivingSelect" class="input-box">
          <option value="">â€” New Receiving Entry â€”</option>
        </select>
        <div id="lockWarning"
             style="display:none;margin-top:6px;padding:8px 12px;
                    background:#ffe7e7;border:1px solid #ffb3b3;
                    color:#b00000;font-size:12.5px;border-radius:6px;">
          âš  This Receiving Entry is LOCKED and cannot be edited.
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="summary-grid">
      <div><div class="summary-label">Supplier</div><div id="summarySupplier" class="summary-value">-</div></div>
      <div><div class="summary-label">Invoice Date</div><div id="summaryDate" class="summary-value">-</div></div>
      <div><div class="summary-label">Status</div><div id="summaryStatus" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Ordered</div><div id="summaryTotalOrdered" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Received</div><div id="summaryTotalReceived" class="summary-value">-</div></div>
      <div><div class="summary-label">Total Remaining</div><div id="summaryTotalRemaining" class="summary-value">-</div></div>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>PO Number</th>
            <th>KPC</th>
            <th>Description</th>
            <th>Ordered</th>
            <th>Received</th>
            <th>Remaining</th>
            <th>Qty This Receipt</th>
            <th>UoM</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Notes -->
    <label style="margin-top:18px;">Additional Notes</label>
    <textarea id="notes"></textarea>

    <!-- Buttons -->
    <div class="actions-row">
      <button class="secondary-btn" onclick="reloadINV()">Reload INV</button>
      <button id="submitBtn" class="submit-btn" onclick="submitReceiving()">Submit Receiving</button>
    </div>

  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwiEvBBu26yHpQuOpU8nGS3kSnuHunDOcNQDquij1iryC2oRTuBo4kDvN9FZhV3lIxvCg/exec";

let currentINV = null;
let isLockedMode = false;

const loadingOverlay = document.getElementById("loadingOverlay");
const invSelect = document.getElementById("invSelect");
const editReceivingSelect = document.getElementById("editReceivingSelect");
const lockWarning = document.getElementById("lockWarning");
const submitBtn = document.getElementById("submitBtn");
const tableBody = document.getElementById("tableBody");
const receivingDate = document.getElementById("receivingDate");
const receivingId = document.getElementById("receivingId");
const notes = document.getElementById("notes");

function showLoading(){ loadingOverlay.style.display="flex"; }
function hideLoading(){ loadingOverlay.style.display="none"; }

function setFormLocked(locked){
  isLockedMode = locked;
  lockWarning.style.display = locked ? "block" : "none";
  submitBtn.disabled = locked;

  const controls = document.querySelectorAll("input, textarea, select");
  controls.forEach(el => {
    // tetap boleh ganti INV & pilih Receiving, dan Receiving ID tetap readonly
    if (el.id === "invSelect" || el.id === "editReceivingSelect" || el.id === "receivingId") return;
    el.disabled = locked;
  });
}

async function loadNextReceivingId() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getlastreceivingid`);
    const data = await res.json();

    const now = new Date();
    const yy = String(now.getFullYear()).slice(2);
    const mm = String(now.getMonth() + 1).padStart(2, "0");

    const prefix = `RCV${yy}${mm}`;

    let nextId;

    if (!data.lastId || !data.lastId.startsWith(prefix)) {
      nextId = prefix + "0000001";
    } else {
      const lastSeq = parseInt(data.lastId.substring(7), 10) || 0;
      const newSeq = lastSeq + 1;
      nextId = prefix + String(newSeq).padStart(7, "0");
    }

    receivingId.value = nextId;

  } catch (e) {
    const now = new Date();
    receivingId.value = `RCV${String(now.getFullYear()).slice(2)}${String(now.getMonth()+1).padStart(2,"0")}0000001`;
  }
}


async function loadInvList(){
  const res = await fetch(`${SCRIPT_URL}?action=getinvlist`);
  const list = await res.json();

  invSelect.innerHTML = `<option disabled selected>â€” Select INV â€”</option>`;

  list.forEach(x => {
    const op = document.createElement("option");
    op.value = op.textContent = x.invNumber;
    invSelect.appendChild(op);
  });

  new Choices(invSelect,{
    searchEnabled:true,
    itemSelectText:"",
    shouldSort:false
  });

  invSelect.addEventListener("change",()=>{
    if(invSelect.value){
      loadInvDetail(invSelect.value);
      loadReceivingHistory(invSelect.value);
      // reset ke mode new setiap ganti INV
      editReceivingSelect.value = "";
      setFormLocked(false);
      loadNextReceivingId();
    }
  });
}

function renderSummary(h){
  document.getElementById("summarySupplier").textContent = h.supplier || "-";
  document.getElementById("summaryDate").textContent = h.invoiceDate || "-";
  document.getElementById("summaryStatus").textContent = h.status || "-";
  document.getElementById("summaryTotalOrdered").textContent = h.totalOrdered ?? "-";
  document.getElementById("summaryTotalReceived").textContent = h.totalReceived ?? "-";
  document.getElementById("summaryTotalRemaining").textContent = h.totalRemaining ?? "-";
}

async function loadInvDetail(inv){
  showLoading();
  const res = await fetch(`${SCRIPT_URL}?action=getinvdetail&invNumber=${encodeURIComponent(inv)}`);
  currentINV = await res.json();

  renderSummary(currentINV.header);
  renderLines(currentINV.lines);
  hideLoading();
}

function renderLines(lines, useQtyThisReceipt=false){
  tableBody.innerHTML="";

  lines.forEach(ln=>{
    const tr = document.createElement("tr");
    tr.dataset.rowIndex = ln.rowIndex ?? "";

    const qtyRemaining = ln.remainingQty ?? 0;
    const qtyThis = useQtyThisReceipt
      ? (ln.qtyThisReceipt ?? qtyRemaining)
      : qtyRemaining;

    const uom = ln.uom || "Meter";

    tr.innerHTML = `
      <td class="row-handle">â‹®â‹®</td>
      <td>${ln.poNumber ?? ""}</td>
      <td><strong>${ln.kpc ?? ""}</strong></td>
      <td>${ln.description ?? ""}</td>
      <td><input class="table-input readonly-field" value="${ln.orderedQty ?? ""}" readonly></td>
      <td><input class="table-input readonly-field" value="${ln.receivedToDate ?? ""}" readonly></td>
      <td><input class="table-input readonly-field remaining" value="${qtyRemaining}" readonly></td>
      <td><input type="number" class="table-input qty-receipt" value="${qtyThis}" min="0"></td>
      <td><input class="table-input readonly-field" value="${uom}" readonly></td>
      <td class="delete-btn">ðŸ—‘</td>
    `;

    tableBody.appendChild(tr);
  });

  document.querySelectorAll(".qty-receipt").forEach(input=>{
    input.addEventListener("input",e=>{
      const tr = e.target.closest("tr");
      const remaining = +tr.querySelector(".remaining").value;
      let val = +e.target.value;
      if(val < 0) val=0;
      if(val > remaining) val=remaining;
      e.target.value = val;
    });
  });

  document.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.addEventListener("click",e=>{
      e.target.closest("tr").remove();
    });
  });

  Sortable.create(tableBody,{handle:".row-handle",animation:150});
}

function reloadINV(){
  if(invSelect.value) loadInvDetail(invSelect.value);
}

function validateForm(){
  if(isLockedMode){
    alert("This Receiving Entry is LOCKED and cannot be edited.");
    return "locked";
  }
  if(!receivingDate.value) return "Receiving Date required.";
  if(!invSelect.value) return "Inv Number required.";

  const rows=[...document.querySelectorAll("#tableBody tr")];
  if(rows.length===0) return "No line items found.";

  let ok=false;
  for(const r of rows){
    const qty = +r.querySelector(".qty-receipt").value;
    const rem = +r.querySelector(".remaining").value;
    if(qty > rem) return "Qty cannot exceed remaining.";
    if(qty > 0) ok=true;
  }

  return ok ? null : "At least one line must have Qty > 0.";
}

function submitReceiving(){
  const err = validateForm();
  if(err) {
    if(err !== "locked") alert(err);
    return;
  }

  showLoading();

  const rows = [...document.querySelectorAll("#tableBody tr")];

  const lines = rows.map(r=>({
    rowIndex: r.dataset.rowIndex,
    poNumber: r.children[1].textContent.trim(),
    kpc: r.children[2].textContent.trim(),
    description: r.children[3].textContent.trim(),
    orderedQty: r.children[4].children[0].value,
    receivedToDate: r.children[5].children[0].value,
    remainingQty: r.children[6].children[0].value,
    qtyThisReceipt: r.children[7].children[0].value,
    uom: "Meter"
  }));

  const payload = {
    receivingId: receivingId.value,
    receivingDate: receivingDate.value,
    invNumber: invSelect.value,
    header: currentINV ? currentINV.header : {},
    notes: notes.value,
    lines: lines
  };

  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    hideLoading();
    if(res.status==="success"){
      alert("Receiving saved.\nReceiving ID: "+payload.receivingId);
      // setelah save, balik ke mode NEW untuk INV tsb
      editReceivingSelect.value = "";
      setFormLocked(false);
      loadNextReceivingId();
      reloadINV();
      loadReceivingHistory(invSelect.value);
    } else {
      alert("Error: "+res.message);
    }
  })
  .catch(err=>{
    hideLoading();
    alert("Submit failed: "+err);
  });
}

/* === NEW: Load Receiving History for selected INV === */
async function loadReceivingHistory(invNumber){
  if(!invNumber){
    editReceivingSelect.innerHTML = `<option value="">â€” New Receiving Entry â€”</option>`;
    return;
  }

  const res = await fetch(`${SCRIPT_URL}?action=getreceivinghistory&inv=${encodeURIComponent(invNumber)}`);
  const list = await res.json();

  editReceivingSelect.innerHTML = `<option value="">â€” New Receiving Entry â€”</option>`;
  list.forEach(x=>{
    const op = document.createElement("option");
    op.value = x.receivingId;
    op.textContent = `${x.receivingId} â€” ${x.date}`;
    editReceivingSelect.appendChild(op);
  });
}

/* === NEW: Load specific Receiving Entry when selected === */
editReceivingSelect.addEventListener("change", async () => {
  const rcvId = editReceivingSelect.value;
  if(!rcvId){
    // balik ke mode NEW
    setFormLocked(false);
    notes.value = "";
    if(invSelect.value){
      loadInvDetail(invSelect.value);
    }
    loadNextReceivingId();
    return;
  }

  showLoading();
  const res = await fetch(`${SCRIPT_URL}?action=loadreceiving&id=${encodeURIComponent(rcvId)}`);
  const data = await res.json();
  hideLoading();

  receivingId.value = data.receivingId;
  receivingDate.value = data.receivingDate || "";
  notes.value = data.notes || "";

  renderSummary(data.header || {});
  renderLines(data.lines || [], true);

  setFormLocked(data.locked === true);
});

window.addEventListener("DOMContentLoaded",async()=>{
  showLoading();

  const t = new Date();
  receivingDate.value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;

  await Promise.all([loadNextReceivingId(), loadInvList()]);
  hideLoading();
});
</script>

</body>
</html>
