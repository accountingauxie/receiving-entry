<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory KPC FG - Auxilium Style</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root { 
    --primary-color: #116999; 
    --bg-color: #f8fafc; 
    --text-color: #333; 
    --border-color: #eaecf0;
  }
  body { 
    font-family: "Inter", sans-serif; 
    background: var(--bg-color); 
    color: var(--text-color); 
  }

  /* Navbar Style */
  .aux-navbar {
    background-color: #ffffff;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    position: sticky; top: 0; z-index: 50;
  }
   
  /* Table Style */
  .table-header { 
    background-color: #f8fafc; 
    color: #64748b; 
    font-size: 12px; 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: 0.05em; 
    cursor: pointer; /* Menandakan bisa diklik */
    user-select: none; /* Mencegah teks terblok saat klik cepat */
    transition: background-color 0.2s;
  }
  .table-header:hover { background-color: #e2e8f0; color: #334155; }
  
  .table-row { border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
  .table-row:hover { background-color: #f8fafc; }
   
  /* Loading Spinner */
  #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 50000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
  .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #3b82f6; border-radius: 50%; width: 45px; height: 45px; animation: spin 0.8s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* Pill/Tabs */
  .filter-pill { cursor: pointer; padding: 6px 16px; border-radius: 9999px; font-size: 13px; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
  .pill-active { background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
  .pill-inactive { background-color: white; color: #64748b; border-color: #e2e8f0; }
  .pill-inactive:hover { background-color: #f1f5f9; color: #334155; }
</style>
</head>

<body>

  <div class="aux-navbar">
    <div class="flex items-center gap-3">
        <div class="font-bold text-xl text-slate-800 flex items-center gap-2">
            <i class="fas fa-layer-group text-blue-600"></i> KPC Inventory
        </div>
    </div>
    <div class="flex items-center gap-4">
        <div class="text-right hidden sm:block">
            <div class="text-xs text-slate-500">Data Source</div>
            <div class="text-sm font-semibold text-slate-800">Sheet: KPC FG</div>
        </div>
        <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm">
            AG
        </div>
    </div>
  </div>

  <div id="loading"><div class="spinner"></div></div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
      <div>
          <h1 class="text-2xl font-bold text-slate-900 tracking-tight">KPC Finished Goods</h1>
          <p class="text-sm text-slate-500 mt-1">Monitoring stok, nilai aset, dan penggunaan mesin (Kolom A-H).</p>
      </div>
      <div class="flex gap-3">
          <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/production/daftarproduksi/index.html" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center">
              <i class="fas fa-arrow-left mr-2"></i> Kembali
          </a>
          <button onclick="fetchData()" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center">
              <i class="fas fa-sync-alt mr-2"></i> Refresh Data
          </button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden transition-all duration-300">
        <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Items (KPC)</div>
        <div class="flex items-baseline"><span class="text-3xl font-bold text-slate-800" id="stat-total-items">0</span></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden transition-all duration-300">
        <div class="absolute right-0 top-0 h-full w-1 bg-emerald-500"></div>
        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Quantity (KG)</div>
        <div class="flex items-baseline"><span class="text-3xl font-bold text-slate-800" id="stat-total-qty">0</span> <span class="ml-2 text-sm text-slate-400">kg</span></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden transition-all duration-300">
        <div class="absolute right-0 top-0 h-full w-1 bg-amber-500"></div>
        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Asset Value</div>
        <div class="flex items-baseline"><span class="text-xl font-bold text-slate-800" id="stat-total-value">Rp 0</span></div>
      </div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex gap-2 overflow-x-auto pb-2 w-full md:w-auto" id="machine-filters">
            <button onclick="filterByMachine('All')" class="filter-pill pill-active" id="btn-all">All Machines</button>
        </div>

        <div class="relative w-full md:w-80">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-slate-400"></i></div>
            <input type="text" id="searchInput" onkeyup="renderTable()" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 sm:text-sm shadow-sm transition" placeholder="Cari KPC, Item, atau Code...">
        </div>
    </div>

    <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th scope="col" onclick="handleSort('kpc')" class="px-6 py-3 text-left table-header">
                            KPC Number <i id="sort-icon-kpc" class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                        <th scope="col" onclick="handleSort('itemProduced')" class="px-6 py-3 text-left table-header">
                            Item Name <i id="sort-icon-itemProduced" class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                        <th scope="col" onclick="handleSort('machine')" class="px-6 py-3 text-left table-header">
                            Machine <i id="sort-icon-machine" class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                        <th scope="col" onclick="handleSort('qty')" class="px-6 py-3 text-right table-header">
                            Qty (kg) <i id="sort-icon-qty" class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                        <th scope="col" onclick="handleSort('price')" class="px-6 py-3 text-right table-header">
                            Price (Unit) <i id="sort-icon-price" class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                        <th scope="col" onclick="handleSort('itemCode')" class="px-6 py-3 text-left table-header">
                            Xero Code <i id="sort-icon-itemCode" class="fas fa-sort ml-1 text-slate-400"></i>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-100" id="table-body">
                </tbody>
            </table>
        </div>
        <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
            <span class="text-xs text-slate-500" id="showing-info">Showing 0 entries</span>
        </div>
    </div>

  </div>

<script>
    // --- KONFIGURASI ---
    const API_URL = "https://script.google.com/macros/s/AKfycbzEWjrouJixlNXuqm0zkI_zoGWinte7rQBbJ5T5cruHuwM-Bd5rJ_hBMMWsGT1Jw8JN/exec"; 

    let rawData = [];
    let currentFilter = 'All';
    // State untuk Sorting
    let currentSort = { column: null, direction: 'asc' };

    document.addEventListener('DOMContentLoaded', () => {
        feather.replace();
        fetchData();
    });

    // Helper: Membersihkan angka
    function cleanNumber(val) {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        const cleanStr = String(val).replace(/,/g, '');
        return parseFloat(cleanStr) || 0;
    }

    async function fetchData() {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            
            if (!Array.isArray(data)) throw new Error("Format data salah");
            
            rawData = data;
            generateMachineFilters();
            renderTable();

        } catch (error) {
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'Gagal Memuat Data',
                text: 'Pastikan URL Apps Script benar dan Deployment diatur ke "Anyone".'
            });
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function generateMachineFilters() {
        const machines = [...new Set(rawData.map(item => item.machine).filter(m => m))].sort();
        const container = document.getElementById('machine-filters');
        
        container.innerHTML = '<button onclick="filterByMachine(\'All\')" class="filter-pill pill-active" id="btn-All">All Machines</button>';

        machines.forEach(m => {
            const cleanId = m.replace(/[^a-zA-Z0-9]/g, '');
            const btn = document.createElement('button');
            btn.className = 'filter-pill pill-inactive whitespace-nowrap';
            btn.id = `btn-${cleanId}`;
            btn.textContent = m;
            btn.onclick = () => filterByMachine(m);
            container.appendChild(btn);
        });
    }

    function filterByMachine(machineName) {
        currentFilter = machineName;
        
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.classList.remove('pill-active');
            btn.classList.add('pill-inactive');
        });

        const targetId = machineName === 'All' ? 'btn-All' : `btn-${machineName.replace(/[^a-zA-Z0-9]/g, '')}`;
        const activeBtn = document.getElementById(targetId);
        if(activeBtn) {
            activeBtn.classList.remove('pill-inactive');
            activeBtn.classList.add('pill-active');
        }

        renderTable();
    }

    // --- LOGIKA SORTING BARU ---
    function handleSort(column) {
        // Jika kolom sama, balik arahnya (asc <-> desc)
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            // Jika kolom baru, default ke ascending
            currentSort.column = column;
            currentSort.direction = 'asc';
        }
        
        updateSortIcons(column);
        renderTable();
    }

    function updateSortIcons(activeColumn) {
        // Reset semua icon ke default (fa-sort dan warna abu)
        const allIcons = document.querySelectorAll('[id^="sort-icon-"]');
        allIcons.forEach(icon => {
            icon.className = 'fas fa-sort ml-1 text-slate-400';
        });

        // Update icon kolom yang aktif
        const activeIcon = document.getElementById(`sort-icon-${activeColumn}`);
        if (activeIcon) {
            // Ubah icon jadi sort-up atau sort-down
            activeIcon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} ml-1 text-blue-600`;
        }
    }

    // Fungsi update kartu statistik (Subtotal Dinamis)
    function updateStats(dataSet) {
        const totalItems = dataSet.length;
        
        const totalQty = dataSet.reduce((sum, item) => sum + cleanNumber(item.qty), 0);
        
        const totalValue = dataSet.reduce((sum, item) => {
            const q = cleanNumber(item.qty);
            const p = cleanNumber(item.price); 
            return sum + (q * p); 
        }, 0);

        document.getElementById('stat-total-items').innerText = new Intl.NumberFormat('id-ID').format(totalItems);
        document.getElementById('stat-total-qty').innerText = new Intl.NumberFormat('id-ID', { maximumFractionDigits: 2 }).format(totalQty);
        document.getElementById('stat-total-value').innerText = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalValue);
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        
        tbody.innerHTML = '';

        // 1. Filter Data
        let filteredData = rawData.filter(item => {
            const matchMachine = currentFilter === 'All' || item.machine === currentFilter;
            const searchString = `${item.kpc} ${item.coilName} ${item.itemProduced} ${item.itemCode} ${item.machine}`.toLowerCase();
            const matchSearch = searchString.includes(searchInput);
            return matchMachine && matchSearch;
        });

        // 2. Sorting Logic (Ditambahkan di sini)
        if (currentSort.column) {
            filteredData.sort((a, b) => {
                let valA = a[currentSort.column];
                let valB = b[currentSort.column];

                // Cek apakah kolom yang disort adalah angka (qty atau price)
                if (currentSort.column === 'qty' || currentSort.column === 'price') {
                    valA = cleanNumber(valA);
                    valB = cleanNumber(valB);
                } else {
                    // String comparison (case insensitive)
                    valA = (valA || '').toString().toLowerCase();
                    valB = (valB || '').toString().toLowerCase();
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // 3. Update Stats Cards dengan data yang sudah difilter
        updateStats(filteredData);

        document.getElementById('showing-info').innerText = `Showing ${filteredData.length} entries`;

        if (filteredData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">Tidak ada data ditemukan.</td></tr>`;
            return;
        }

        // 4. Render Rows
        filteredData.forEach(row => {
            const numQty = cleanNumber(row.qty);
            const numPrice = cleanNumber(row.price);
            
            const fmtQty = new Intl.NumberFormat('id-ID').format(numQty);
            const fmtPrice = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(numPrice);

            const tr = document.createElement('tr');
            tr.className = 'table-row';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-bold text-slate-900">${row.kpc || '-'}</div>
                    <div class="text-xs text-slate-500">${row.coilName || ''}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-slate-900 font-medium">${row.itemProduced || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                        ${row.machine || 'N/A'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <div class="text-sm font-mono font-bold text-slate-700">${fmtQty}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <div class="text-sm text-slate-600">${fmtPrice}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">ITEM: <span class="text-slate-600 font-mono font-normal normal-case">${row.itemCode || '-'}</span></span>
                        <span class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">XERO: <span class="text-slate-600 font-mono font-normal normal-case">${row.accountXero || '-'}</span></span>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
</script>

</body>
</html>
