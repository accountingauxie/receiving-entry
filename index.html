<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Kelola Penerimaan Tagihan</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ADVANCE WHITE THEME --- */
        body { background-color: #f8f9fc; font-family: 'Inter', sans-serif; color: #333; font-size: 0.88rem; }
        
        /* Typography */
        h3.page-title { font-weight: 700; letter-spacing: -0.5px; color: #1a1a1a; }
        
        /* Cards */
        .card-custom { background: #fff; border: 1px solid #eef0f3; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        
        /* Summary Cards */
        .summary-card { 
            background: #fff; 
            padding: 15px 20px; 
            border-radius: 8px; 
            border-left: 5px solid #ccc; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        .summary-card:hover { transform: translateY(-2px); }
        .summary-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 5px; display: block; }
        .summary-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
        
        /* Specific Border Colors */
        .border-purple { border-left-color: #6f42c1; }
        .text-purple { color: #6f42c1; }
        
        .border-green { border-left-color: #198754; }
        .text-green { color: #198754; }
        
        .border-orange { border-left-color: #fd7e14; }
        .text-orange { color: #fd7e14; }

        /* Navigation Tabs */
        .nav-tabs { border-bottom: 1px solid #eef0f3; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 500; border: none; padding: 12px 25px; transition: 0.3s; }
        .nav-tabs .nav-link:hover { color: #0d6efd; background: #f8f9fa; border-radius: 8px 8px 0 0; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; font-weight: 700; }

        /* Filter Section */
        .filter-section { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #eef0f3; margin-bottom: 20px; }
        .form-label-sm { font-size: 0.75rem; font-weight: 600; color: #555; text-transform: uppercase; }

        /* Tables */
        .table-custom thead th { background-color: #ffffff; color: #888; font-weight: 700; font-size: 0.7rem; text-transform: uppercase; padding: 15px 20px; border-bottom: 2px solid #f0f0f0; }
        .table-custom tbody td { padding: 15px 20px; vertical-align: middle; border-bottom: 1px solid #f7f9fc; font-weight: 500; }
        .table-custom tbody tr:hover { background-color: #fafbfc; }

        /* Badges */
        .badge-status { padding: 6px 12px; border-radius: 30px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.3px; }
        .badge-pending { background-color: #fff4e5; color: #fd7e14; border: 1px solid #ffe5d0; } /* Orange */
        .badge-success { background-color: #e6f7ee; color: #198754; border: 1px solid #d1e7dd; } /* Green */
        .badge-partial { background-color: #f3e8ff; color: #6f42c1; border: 1px solid #e0cffc; } /* Purple */
        .badge-type { font-size: 0.65rem; padding: 4px 8px; }

        /* Back Button */
        .btn-back { color: #555; font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; transition: 0.2s; }
        .btn-back:hover { color: #0d6efd; transform: translateX(-3px); }

        /* Modal Clean Look */
        .header-icon-box { width: 45px; height: 45px; background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; margin-right: 15px; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.2); }
        .col-highlight-body { background-color: #f8fbff !important; font-weight: 700; color: #0d6efd; }
        .info-label { color: #999; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .info-value { color: #333; font-weight: 600; font-size: 1.05rem; }

        /* Progress Bar Custom */
        .progress-thin { height: 6px; border-radius: 10px; background-color: #e9ecef; }
        
        /* Custom Scrollbar for large tables */
        .table-responsive::-webkit-scrollbar { height: 8px; }
        .table-responsive::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-responsive::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .table-responsive::-webkit-scrollbar-thumb:hover { background: #bbb; }
    </style>
</head>
<body>

<div class="container-fluid px-4 py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="page-title mb-1">Daftar Kelola Penerimaan Tagihan</h3>
            <span class="text-muted small">Dashboard / Report View</span>
        </div>
        <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/entry/index.html" class="btn-back">
            <i class="bi bi-arrow-left me-2"></i> Kembali ke Entry
        </a>
    </div>

    <div class="row g-3 mb-4" id="summarySection"></div>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" href="#" onclick="switchTab('receiving', this)">
                <i class="bi bi-box-arrow-in-down me-2"></i>Penerimaan
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="switchTab('list_po', this)">
                <i class="bi bi-list-check me-2"></i>List PO
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="switchTab('detail', this)">
                <i class="bi bi-table me-2"></i>Laporan Detail
            </a>
        </li>
    </ul>

    <div id="filterContainer" class="filter-section d-none">
        <div class="row align-items-end g-3">
            <div class="col-md-3">
                <label class="form-label-sm">Start Date</label>
                <input type="date" id="filterStartDate" class="form-control" onchange="applyFilters()">
            </div>
            <div class="col-md-3">
                <label class="form-label-sm">End Date</label>
                <input type="date" id="filterEndDate" class="form-control" onchange="applyFilters()">
            </div>
            <div class="col-md-4">
                <label class="form-label-sm d-block mb-2">Status Filter (Multi-select)</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="Sudah Diterima" id="checkSudah" onchange="applyFilters()" checked>
                        <label class="form-check-label small" for="checkSudah">Sudah</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="Sebagian Diterima" id="checkSebagian" onchange="applyFilters()" checked>
                        <label class="form-check-label small" for="checkSebagian">Sebagian</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="Belum Diterima" id="checkBelum" onchange="applyFilters()" checked>
                        <label class="form-check-label small" for="checkBelum">Belum</label>
                    </div>
                </div>
            </div>
            <div class="col-md-2 text-end">
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetFilters()">Reset Filter</button>
            </div>
        </div>
    </div>

    <div class="card-custom">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <div class="position-relative w-50">
                <i class="bi bi-search position-absolute text-muted" style="top: 10px; left: 12px;"></i>
                <input type="text" id="searchInput" class="form-control ps-5 border-0 bg-light" placeholder="Search Data (ID, Vendor, Date)..." onkeyup="applyFilters()">
            </div>
            <button class="btn btn-light border btn-sm" onclick="fetchData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
        </div>

        <div id="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted small">Synchronizing data...</p>
        </div>

        <div class="table-responsive">
            <table class="table table-custom d-none" id="mainTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div class="p-3 text-muted small border-top d-flex justify-content-between">
            <span>Showing data</span>
            <span>Total Records: <strong id="recordCount">0</strong></span>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0">
            <div class="modal-header pt-4 px-4">
                <div class="d-flex align-items-start w-100">
                    <div class="header-icon-box" id="modalIconBox">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div>
                        <h5 class="modal-title-custom mb-0" id="modalTitle">Detail Data</h5>
                        <p class="modal-subtitle mb-0" id="modalSubtitle">Review detail item</p>
                    </div>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="p-4 bg-white" id="modalInfoSection"></div>
                <div class="table-responsive">
                    <table class="table table-striped mb-0 w-100">
                        <thead id="modalTableHead" class="bg-light small text-uppercase"></thead>
                        <tbody id="modalTableBody" class="small"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIGURATION ---
    // GANTI URL INI dengan URL Web App Script kamu yang terbaru
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbygx-huClDPtnvgYaF9Tw0Z5iHuYd3S9m1036QSvBnftLQ9YPVcNuEQV57SUB5gK8az/exec'; 

    let allData = [];
    let displayedData = [];
    let currentTab = 'receiving'; 

    const CONFIG = {
        'receiving': {
            tableHeaders: ['Reference', 'Vendor', 'Date', 'Items', 'Total Qty', 'Action'],
            modalHeaders: ['Tipe', 'Description', 'KPC', 'UoM', 'Ordered', 'Recv Before', 'This Receipt'],
            title: 'Detail Penerimaan Barang',
            subtitle: 'Validasi fisik barang yang diterima'
        },
        'list_po': {
            tableHeaders: ['Inv Number', 'Vendor', 'Inv Date', 'Status', 'Items', 'Total Order', 'Total Arrived', '', 'Action'],
            modalHeaders: ['Tipe', 'Item Name', 'Qty Order', 'Qty Arrived', 'Qty Remaining'],
            title: 'Detail Invoice Number',
            subtitle: 'Tracking status kelengkapan order'
        },
        // --- KONFIGURASI BARU UNTUK TAB DETAIL ---
        'detail': {
            // Sesuai permintaan: Receiving ID | Date | Supplier | Inv | PO | Item | Qty Order | Recv Bef | This Rec | UoM | Container
            tableHeaders: [
                'Rec ID', 'Date', 'Supplier', 'Inv Number', 'PO Number', 
                'Item Name', 'Qty Ordered', 'Recv Before', 'This Receipt', 'UoM', 'Container'
            ],
            // Modal tidak dipakai di tab Detail, tapi disiapkan saja biar aman
            modalHeaders: [],
            title: 'Laporan Detail',
            subtitle: 'Data detail per baris'
        }
    };

    // --- INIT ---
    function switchTab(tabName, element) {
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        currentTab = tabName;
        
        // Toggle Filter Visibility
        const filterContainer = document.getElementById('filterContainer');
        const summarySection = document.getElementById('summarySection');
        
        if (currentTab === 'list_po') {
            filterContainer.classList.remove('d-none');
            summarySection.classList.remove('d-none');
        } else if (currentTab === 'detail') {
            // Tab Detail tidak butuh Filter Status/Date kompleks & Summary Cards
            filterContainer.classList.add('d-none');
            summarySection.classList.add('d-none');
        } else {
            // Tab Receiving
            filterContainer.classList.add('d-none');
            summarySection.classList.remove('d-none');
        }

        fetchData();
    }

    async function fetchData() {
        const loading = document.getElementById('loading');
        const table = document.getElementById('mainTable');
        const tbody = document.getElementById('tableBody');
        const thead = document.getElementById('tableHead');
        
        loading.classList.remove('d-none');
        table.classList.add('d-none');
        tbody.innerHTML = '';
        thead.innerHTML = '';
        document.getElementById('summarySection').innerHTML = ''; 

        try {
            const response = await fetch(`${WEB_APP_URL}?type=${currentTab}`);
            let data = await response.json();
            
            if (data.error) { alert("Error: " + data.error); return; }

            // Normalize Data & Sort
            data = data.map(normalizeData);
            
            // Sort Descending by ID
            data.sort((a, b) => {
                if(a.id && b.id) return b.id.localeCompare(a.id);
                return 0;
            });
            
            allData = data;
            displayedData = data;
            
            renderTable(displayedData);
            if(currentTab !== 'detail') updateSummary(); // Detail tidak pakai summary cards
            
            loading.classList.add('d-none');
            table.classList.remove('d-none');

        } catch (error) {
            console.error(error);
            loading.innerHTML = '<p class="text-danger">Gagal koneksi ke server.</p>';
        }
    }

    function normalizeData(row) {
        if (currentTab === 'list_po') {
            let s = row.status ? row.status.toString().trim() : "";
            if (s === "") s = "Belum Diterima";
            row.normalizedStatus = s;
        }
        return row;
    }

    // --- RENDER TABLE ---
    function renderTable(data) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        const conf = CONFIG[currentTab];

        // 1. Render Header
        let headerHtml = '<tr>';
        conf.tableHeaders.forEach(h => headerHtml += `<th class="text-nowrap">${h}</th>`);
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;

        // 2. Render Body
        tbody.innerHTML = '';
        document.getElementById('recordCount').innerText = data.length;

        if(data.length === 0) {
            const colSpan = conf.tableHeaders.length;
            tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4 text-muted">Tidak ada data ditemukan</td></tr>`;
            return;
        }

        data.forEach(row => {
            let tr = document.createElement('tr');
            
            if (currentTab === 'receiving') {
                const itemsCount = row.items ? row.items.length : 0;
                tr.innerHTML = `
                    <td class="fw-bold text-primary">${row.id}</td>
                    <td>${row.vendor}</td>
                    <td>${row.date}</td>
                    <td class="text-center"><span class="badge bg-light text-dark border">${itemsCount}</span></td>
                    <td class="fw-bold">${row.totalQty}</td>
                    <td class="text-end"><button class="btn btn-sm btn-light text-primary" onclick="showDetail('${row.id}')"><i class="bi bi-eye-fill"></i></button></td>
                `;
            } else if (currentTab === 'list_po') {
                let badgeClass = "badge-pending";
                if (row.normalizedStatus === "Sudah Diterima") badgeClass = "badge-success";
                if (row.normalizedStatus === "Sebagian Diterima") badgeClass = "badge-partial";

                let totalArrived = 0;
                if(row.items && row.items.length > 0) {
                     totalArrived = row.items.reduce((sum, item) => sum + (parseFloat(item.val2) || 0), 0);
                }

                let percent = 0;
                if(row.totalQty > 0) percent = Math.round((totalArrived / row.totalQty) * 100);
                if(percent > 100) percent = 100;

                let barColorClass = "bg-primary";
                if(percent === 100) barColorClass = "bg-success";
                else if(percent === 0) barColorClass = "bg-secondary";

                const itemsCount = row.items ? row.items.length : 0;

                tr.innerHTML = `
                    <td class="fw-bold text-primary">${row.id}</td>
                    <td>${row.vendor}</td>
                    <td>${row.date}</td>
                    <td><span class="badge-status ${badgeClass}">${row.normalizedStatus}</span></td>
                    <td class="text-center"><span class="badge bg-light text-dark border">${itemsCount}</span></td>
                    <td class="fw-bold">${row.totalQty}</td>
                    <td class="fw-bold text-success">${totalArrived}</td>
                    <td style="min-width: 150px;">
                        <div class="d-flex align-items-center">
                            <div class="progress progress-thin flex-grow-1">
                                <div class="progress-bar ${barColorClass}" role="progressbar" style="width: ${percent}%"></div>
                            </div>
                            <span class="ms-2 small text-muted fw-bold">${percent}%</span>
                        </div>
                    </td>
                    <td class="text-end"><button class="btn btn-sm btn-light text-primary" onclick="showDetail('${row.id}')"><i class="bi bi-eye-fill"></i></button></td>
                `;
            } else if (currentTab === 'detail') {
                // LOGIKA RENDER TAB DETAIL (FLAT TABLE)
                tr.innerHTML = `
                    <td class="text-primary fw-bold small text-nowrap">${row.id}</td>
                    <td class="small text-nowrap">${row.date}</td>
                    <td class="small text-nowrap">${row.vendor}</td>
                    <td class="small text-nowrap">${row.inv || '-'}</td>
                    <td class="small text-nowrap">${row.po || '-'}</td>
                    <td class="fw-bold small">${row.item}</td>
                    <td class="text-end small">${row.qtyOrder}</td>
                    <td class="text-end small text-muted">${row.qtyBefore}</td>
                    <td class="text-end fw-bold text-success bg-light">${row.qtyNow}</td>
                    <td class="small">${row.uom}</td>
                    <td class="small text-nowrap text-primary fw-bold">${row.container || '-'}</td>
                `;
            }
            tbody.appendChild(tr);
        });
    }

    // --- SUMMARY LOGIC ---
    function updateSummary() {
        const container = document.getElementById('summarySection');
        let html = '';

        if (currentTab === 'receiving') {
            const total = allData.length;
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0'); 
            const yyyy = today.getFullYear();
            const todayStr = dd + '/' + mm + '/' + yyyy;
            const todayCount = allData.filter(d => d.date === todayStr).length;

            html = `
                <div class="col-md-3">
                    <div class="summary-card border-purple">
                        <span class="summary-label">Total Penerimaan</span>
                        <span class="summary-value text-purple">${total}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card border-green">
                        <span class="summary-label">Penerimaan Hari Ini</span>
                        <span class="summary-value text-green">${todayCount}</span>
                    </div>
                </div>
            `;
        } else if (currentTab === 'list_po') {
            let countSudah = 0;
            let countSebagian = 0;
            let countBelum = 0;

            allData.forEach(d => {
                if (d.normalizedStatus === "Sudah Diterima") countSudah++;
                else if (d.normalizedStatus === "Sebagian Diterima") countSebagian++;
                else countBelum++;
            });

            html = `
                <div class="col-md-3">
                    <div class="summary-card border-purple">
                        <span class="summary-label">Sudah Diterima</span>
                        <span class="summary-value text-purple">${countSudah}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card border-green">
                        <span class="summary-label">Sebagian Diterima</span>
                        <span class="summary-value text-green">${countSebagian}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card border-orange">
                        <span class="summary-label">Belum Diterima</span>
                        <span class="summary-value text-orange">${countBelum}</span>
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
    }

    // --- FILTERING LOGIC ---
    function applyFilters() {
        const searchVal = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = allData.filter(row => {
            let str = "";
            if (currentTab === 'detail') {
                 // Pencarian khusus tab detail (bisa cari Item Name & Container juga)
                 // Menggabungkan ID, Vendor, Item, Container, Inv, PO
                 str = (row.id + " " + row.vendor + " " + row.item + " " + (row.container||"") + " " + (row.inv||"") + " " + (row.po||"")).toLowerCase();
            } else {
                 str = (row.id + " " + row.vendor + " " + row.date).toLowerCase();
            }
            return str.includes(searchVal);
        });

        if (currentTab === 'list_po') {
            const startDateVal = document.getElementById('filterStartDate').value;
            const endDateVal = document.getElementById('filterEndDate').value;
            const checkSudah = document.getElementById('checkSudah').checked;
            const checkSebagian = document.getElementById('checkSebagian').checked;
            const checkBelum = document.getElementById('checkBelum').checked;

            if (startDateVal && endDateVal) {
                const start = new Date(startDateVal);
                const end = new Date(endDateVal);
                end.setHours(23,59,59); 

                filtered = filtered.filter(row => {
                    const parts = row.date.split('/');
                    if(parts.length !== 3) return false;
                    const rowDate = new Date(parts[2], parts[1]-1, parts[0]); 
                    return rowDate >= start && rowDate <= end;
                });
            }

            const allowedStatuses = [];
            if (checkSudah) allowedStatuses.push("Sudah Diterima");
            if (checkSebagian) allowedStatuses.push("Sebagian Diterima");
            if (checkBelum) allowedStatuses.push("Belum Diterima");

            filtered = filtered.filter(row => allowedStatuses.includes(row.normalizedStatus));
        }

        displayedData = filtered;
        renderTable(displayedData);
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        document.getElementById('checkSudah').checked = true;
        document.getElementById('checkSebagian').checked = true;
        document.getElementById('checkBelum').checked = true;
        applyFilters();
    }

    // --- MODAL LOGIC (UNCHANGED) ---
    function showDetail(id) {
        // Modal logic hanya dipakai untuk Receiving & List PO
        const data = allData.find(d => d.id === id);
        if (!data) return;

        const conf = CONFIG[currentTab];
        document.getElementById('modalTitle').innerText = conf.title;
        document.getElementById('modalSubtitle').innerText = conf.subtitle;
        
        const infoSection = document.getElementById('modalInfoSection');
        
        if (currentTab === 'receiving') {
            infoSection.innerHTML = `
                <div class="row g-4 pb-3">
                    <div class="col-md-3">
                        <span class="info-label">Receiving ID</span>
                        <div class="info-value text-primary">${data.id}</div>
                    </div>
                    <div class="col-md-3">
                        <span class="info-label">Receive Date</span>
                        <div class="info-value">${data.date}</div>
                    </div>
                    <div class="col-md-3">
                        <span class="info-label">PO Number</span>
                        <div class="info-value">${data.poNumber || '-'}</div>
                    </div>
                    <div class="col-md-3">
                        <span class="info-label">Invoice Number</span>
                        <div class="info-value text-success">${data.invNumber || '-'}</div>
                    </div>
                    <div class="col-12 border-top pt-3 mt-2">
                        <span class="info-label">Supplier / Vendor</span>
                        <div class="fs-5 fw-bold text-dark">${data.vendor}</div>
                    </div>
                </div>
            `;
        } else if (currentTab === 'list_po') {
            infoSection.innerHTML = `
                <div class="row g-4">
                    <div class="col-md-4">
                        <span class="info-label">Invoice Number</span>
                        <div class="info-value text-primary">${data.id}</div>
                    </div>
                    <div class="col-md-4">
                        <span class="info-label">Date</span>
                        <div class="info-value">${data.date}</div>
                    </div>
                    <div class="col-md-4">
                        <span class="info-label">Status</span>
                        <span class="badge-status ${data.normalizedStatus === 'Sudah Diterima' ? 'badge-success' : (data.normalizedStatus === 'Belum Diterima' ? 'badge-pending' : 'badge-partial')}">${data.normalizedStatus}</span>
                    </div>
                    <div class="col-12 border-top pt-3 mt-2">
                         <span class="info-label">Vendor</span>
                         <div class="fs-5 fw-bold text-dark">${data.vendor}</div>
                    </div>
                </div>
            `;
        }

        const mHead = document.getElementById('modalTableHead');
        let mHeadHtml = '<tr>';
        conf.modalHeaders.forEach((h, index) => {
             const alignClass = (index > 1) ? 'text-end' : '';
             mHeadHtml += `<th class="py-3 px-3 border-bottom ${alignClass}">${h}</th>`;
        });
        mHeadHtml += '</tr>';
        mHead.innerHTML = mHeadHtml;

        const mBody = document.getElementById('modalTableBody');
        mBody.innerHTML = '';
        const safeVal = (val) => (val === "" || val === null || val === undefined) ? "0" : val;

        data.items.forEach(item => {
            let rowHtml = '<tr>';
            if (currentTab === 'receiving') {
                rowHtml += `
                    <td class="px-3"><span class="badge bg-secondary badge-type">${item.col1 || 'Item'}</span></td>
                    <td class="px-3 fw-bold">${item.col2}</td>
                    <td class="px-3">${item.col3 || '-'}</td>
                    <td class="px-3 text-muted small">${item.col4 || 'UNIT'}</td>
                    <td class="px-3 text-end text-muted">${safeVal(item.val1)}</td>
                    <td class="px-3 text-end text-muted">${safeVal(item.val2)}</td>
                    <td class="px-3 text-end col-highlight-body">${safeVal(item.val3)}</td>
                `;
            } else if (currentTab === 'list_po') {
                rowHtml += `
                    <td class="px-3"><span class="badge bg-secondary badge-type">${item.col1 || 'Item'}</span></td>
                    <td class="px-3 fw-bold">${item.col2}</td>
                    <td class="px-3 text-end">${safeVal(item.val1)}</td>
                    <td class="px-3 text-end text-success fw-bold">${safeVal(item.val2)}</td>
                    <td class="px-3 text-end text-danger fw-bold">${safeVal(item.val3)}</td>
                `;
            }
            rowHtml += '</tr>';
            mBody.innerHTML += rowHtml;
        });

        const myModal = new bootstrap.Modal(document.getElementById('detailModal'));
        myModal.show();
    }

    fetchData();
</script>

</body>
</html>
