<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Receiving Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Sortable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <style>
    /* GLOBAL STYLE (Xero-like) */
    body {
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      font-size: 13px;
      color: #333;
    }
    input, select, textarea, .choices__inner { transition: all 0.18s ease; }
    input:hover, select:hover, textarea:hover, .choices__inner:hover { border-color: #b9c4d0 !important; }

    @keyframes spin { 0% {transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    .top-bar {
      height: 50px;
      display: flex;
      align-items: center;
      padding: 0 48px;
      background: #ffffff;
      border-bottom: 1px solid #e1e4e8;
    }
    .brand-main { font-size:17px;font-weight:600;margin-right:6px;letter-spacing:0.08em; }
    .brand-sub { font-size:13px;color:#7a8699; }

    .page { max-width:1120px;margin:32px auto;padding:0 16px; }
    .card { background:#fff;border-radius:8px;box-shadow:0 0 0 1px rgba(15,23,42,.04),0 14px 30px rgba(15,23,42,.08);padding:24px 26px; }
    .card-title { font-size:20px;font-weight:600;color:#1f2933;margin-bottom:18px; }

    label { font-size:12.5px;font-weight:600;color:#4a5568;margin-bottom:4px;display:block; }

    .input-box, .table-input, .choices__inner {
      height:30px !important;min-height:30px !important;
      padding:5px 8px !important;font-size:12.5px !important;
      border:1px solid #d0d7df !important;border-radius:5px !important;
      background:#f9fafb !important;box-sizing:border-box;
    }

    .row-flex {
      display:grid;
      grid-template-columns: minmax(160px,1fr) minmax(220px,1.2fr) minmax(210px,1.1fr);
      gap:24px;margin-bottom:18px;
      align-items:end;
    }

    .summary-grid {
      display:grid;
      grid-template-columns:repeat(4,minmax(150px,1fr));
      gap:18px;background:#f5f7ff;
      border:1px solid #dde4ff;border-radius:6px;
      padding:12px;margin-bottom:16px;
    }
    .summary-label { font-size:11.5px;font-weight:600;color:#5a6478; }
    .summary-value { font-size:12.5px;font-weight:500; }
    .summary-muted { color:#6b7280;font-style:italic; }

    table { width:100%;border-collapse:collapse;border:1px solid #e3e6ea;background:#fff;border-radius:6px; }
    th { background:#edf0f5;font-size:12.5px;padding:6px;border-bottom:1px solid #e1e4e9;text-align:left; }
    td { font-size:12px;padding:4px;border-bottom:1px solid #f3f4f6; }

    .row-handle { cursor:grab;text-align:center;color:#999;font-size:13px; }
    .delete-btn { color:#cc1f2f;cursor:pointer;font-size:14px;text-align:center; }

    .notes-label { font-size:13px;font-weight:600;margin-top:18px; }
    textarea { width:100%;height:110px;padding:8px;border:1px solid #d0d7df;border-radius:6px;background:#f9fafb;resize:vertical; }

    .actions-row { margin-top:22px;display:flex;justify-content:flex-end;gap:12px; }
    .submit-btn {
      background:#0f80d9;color:#fff;padding:9px 24px;border-radius:6px;
      font-size:13px;font-weight:600;cursor:pointer;border:none;
    }
    .submit-btn:hover { background:#0b66ad; }
    .secondary-btn { background:#e9eef8;border:1px solid #cfd6e5;padding:8px 16px;border-radius:6px;cursor:pointer; }

    #loadingOverlay { position:fixed;inset:0;background:rgba(255,255,255,.75);display:none;align-items:center;justify-content:center;z-index:9999; }
    .loading-spinner {
      width:42px;height:42px;border-radius:50%;
      border:5px solid #dae6f4;border-top-color:#2b6be8;
      animation:spin .85s linear infinite;
    }

    .error-text { color:#b91c1c;font-size:12px;display:none;margin-top:6px; }
  </style>
</head>

<body>

<div id="loadingOverlay"><div class="loading-spinner"></div></div>

<div class="top-bar">
  <span class="brand-main">UXILIUM</span>
  <span class="brand-sub">Receiving Entry â€” Coil Purchase</span>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">Receiving Entry (Based on PO - Purchase Coil)</div>

    <div class="row-flex">
      <div>
        <label>Receiving Date</label>
        <input type="date" id="receivingDate" class="input-box">
      </div>

      <div>
        <label>PO Number</label>
        <select id="poNumberSelect" class="input-box"></select>
      </div>

      <div>
        <label>Receiving ID</label>
        <input type="text" id="receivingId" class="input-box" readonly>
      </div>
    </div>

    <!-- SUMMARY -->
    <div class="summary-grid">
      <div>
        <div class="summary-label">Supplier</div>
        <div class="summary-value" id="summarySupplier"><span class="summary-muted">Select PO</span></div>
      </div>

      <div>
        <div class="summary-label">PO Date</div>
        <div class="summary-value" id="summaryDate">â€”</div>
      </div>

      <div>
        <div class="summary-label">Status</div>
        <div class="summary-value" id="summaryStatus">â€”</div>
      </div>

      <div>
        <div class="summary-label">Currency</div>
        <div class="summary-value" id="summaryCurrency">â€”</div>
      </div>

      <div>
        <div class="summary-label">Total Ordered</div>
        <div class="summary-value" id="summaryTotalOrdered">â€”</div>
      </div>

      <div>
        <div class="summary-label">Total Received</div>
        <div class="summary-value" id="summaryTotalReceived">â€”</div>
      </div>

      <div>
        <div class="summary-label">Total Remaining</div>
        <div class="summary-value" id="summaryTotalRemaining">â€”</div>
      </div>

      <div>
        <div class="summary-label">ETA</div>
        <div class="summary-value" id="summaryEta">â€”</div>
      </div>
    </div>

    <!-- TABLE -->
    <table>
      <thead>
        <tr>
          <th></th>
          <th>Item</th>
          <th>Ordered</th>
          <th>Received</th>
          <th>Remaining</th>
          <th>Qty This Receipt</th>
          <th>UoM</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div id="tableError" class="error-text">Error loading PO lines.</div>

    <div class="notes-label">Additional Notes</div>
    <textarea id="notes"></textarea>

    <div class="actions-row">
      <button class="secondary-btn" onclick="reloadPO()">Reload PO</button>
      <button class="submit-btn" onclick="submitReceiving()">Submit Receiving</button>
    </div>

  </div>
</div>

<script>
  // GANTI DENGAN URL WEB APP SCRIPT KAMU
  const SCRIPT_URL = "YOUR_WEB_APP_URL";

  let poList = [];
  let currentPO = null;

  function showLoading(){ loadingOverlay.style.display="flex"; }
  function hideLoading(){ loadingOverlay.style.display="none"; }

  async function loadNextReceivingId() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=getlastreceivingid`);
      const data = await res.json();
      const lastId = data.lastId;

      const today = new Date();
      const yy = String(today.getFullYear()).slice(2);
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const prefix = `RCV${yy}${mm}`;

      if (!lastId || !lastId.startsWith(prefix)) {
        receivingId.value = prefix + "0000001";
        return;
      }

      const seq = parseInt(lastId.substring(7)) + 1;
      receivingId.value = prefix + String(seq).padStart(7,"0");
    } catch(e){
      console.log(e);
    }
  }

  async function loadPOList() {
    const res = await fetch(`${SCRIPT_URL}?action=getpolist`);
    poList = await res.json();

    poNumberSelect.innerHTML = "<option value='' disabled selected>â€” Select PO â€”</option>";

    poList.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.poNumber;
      opt.textContent = `${p.poNumber} â€” ${p.supplier}`;
      poNumberSelect.appendChild(opt);
    });

    new Choices(poNumberSelect,{searchEnabled:true,itemSelectText:"",shouldSort:false});

    poNumberSelect.addEventListener("change",()=>loadPODetail(poNumberSelect.value));
  }

  function renderSummary(h) {
    summarySupplier.textContent = h.supplier || "-";
    summaryDate.textContent = h.poDate || "-";
    summaryStatus.textContent = h.status || "-";
    summaryCurrency.textContent = h.currency || "-";
    summaryTotalOrdered.textContent = h.totalOrdered ?? "-";
    summaryTotalReceived.textContent = h.totalReceived ?? "-";
    summaryTotalRemaining.textContent = h.totalRemaining ?? "-";
    summaryEta.textContent = h.eta || "-";
  }

  async function loadPODetail(poNo) {
    showLoading();
    try {
      const res = await fetch(`${SCRIPT_URL}?action=getpodetail&poNumber=${poNo}`);
      currentPO = await res.json();

      renderSummary(currentPO.header);
      renderPOLines(currentPO.lines);
    } catch(e){
      console.log(e);
      tableError.style.display="block";
    } finally {
      hideLoading();
    }
  }

  function renderPOLines(lines){
    tableBody.innerHTML = "";
    tableError.style.display = lines?.length ? "none" : "block";

    lines.forEach((ln,i)=>{
      const ordered = parseFloat(ln.orderedQty)||0;
      const received = parseFloat(ln.receivedToDate)||0;
      const remain = Math.max(ordered-received,0);

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="row-handle">â‹®â‹®</td>
        <td>
          <div style="font-weight:600">${ln.itemCode}</div>
          <div style="font-size:11px;color:#6b7280">${ln.description}</div>
        </td>
        <td><input class="table-input" value="${ordered}" readonly></td>
        <td><input class="table-input" value="${received}" readonly></td>
        <td><input class="table-input remaining" value="${remain}" readonly></td>
        <td><input type="number" class="table-input qty-receipt" value="${remain}" min="0"></td>
        <td><input class="table-input" value="${ln.uom||''}" readonly></td>
        <td class="delete-btn" onclick="this.closest('tr').remove()">ðŸ—‘</td>
      `;
      tableBody.appendChild(tr);
    });

    tableBody.querySelectorAll(".qty-receipt").forEach(i=>{
      i.addEventListener("input",e=>{
        const tr=e.target.closest("tr");
        const remaining=parseFloat(tr.querySelector(".remaining").value)||0;
        let val=parseFloat(e.target.value)||0;
        if(val>remaining) val=remaining;
        if(val<0) val=0;
        e.target.value=val;
      });
    });

    Sortable.create(tableBody,{handle:".row-handle",animation:150});
  }

  function reloadPO(){
    if(poNumberSelect.value) loadPODetail(poNumberSelect.value);
  }

  function validateForm(){
    if(!receivingDate.value) return "Receiving Date required";
    if(!poNumberSelect.value) return "PO Number required";

    let hasQty=false;
    document.querySelectorAll(".qty-receipt").forEach(q=>{
      if(parseFloat(q.value)>0) hasQty=true;
    });
    return hasQty ? null : "At least one Qty must be > 0";
  }

  function submitReceiving(){
    const err=validateForm();
    if(err){ alert(err); return; }

    showLoading();

    const lines = Array.from(document.querySelectorAll("#tableBody tr")).map(r=>{
      return {
        itemCode: r.cells[1].children[0].textContent,
        description: r.cells[1].children[1].textContent,
        orderedQty: r.cells[2].children[0].value,
        receivedToDate: r.cells[3].children[0].value,
        qtyThisReceipt: r.cells[4].nextElementSibling.value,
        uom: r.cells[6].children[0].value
      };
    });

    const payload={
      receivingId:receivingId.value,
      receivingDate:receivingDate.value,
      poNumber:poNumberSelect.value,
      notes:notes.value,
      header:currentPO.header,
      lines:lines
    };

    fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(payload)})
      .then(res=>res.json())
      .then(r=>{
        hideLoading();
        if(r.status==="success"){
          alert("Saved successfully!");
          loadNextReceivingId();
          reloadPO();
        } else alert("Error: "+r.message);
      })
      .catch(err=>{
        hideLoading();
        alert("Submit failed: "+err);
      });
  }

  window.addEventListener("DOMContentLoaded",async()=>{
    showLoading();

    const t=new Date();
    receivingDate.value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;

    await Promise.all([loadNextReceivingId(),loadPOList()]);

    hideLoading();
  });
</script>

</body>
</html>
