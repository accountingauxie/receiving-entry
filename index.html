<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Penerimaan & PO</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME & UTILS --- */
        body { background-color: #f8f9fc; font-family: 'Inter', sans-serif; color: #333; font-size: 0.85rem; }
        
        .card-custom { background: #fff; border: 1px solid #eef0f3; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        
        /* Summary Cards */
        .summary-card { background: #fff; padding: 15px 20px; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .summary-card:hover { transform: translateY(-2px); }
        .summary-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #666; display: block; }
        .summary-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
        
        .border-purple { border-left-color: #6f42c1; } .text-purple { color: #6f42c1; }
        .border-green { border-left-color: #198754; } .text-green { color: #198754; }
        .border-orange { border-left-color: #fd7e14; } .text-orange { color: #fd7e14; }
        .border-blue { border-left-color: #0d6efd; } .text-blue { color: #0d6efd; }

        /* Nav Tabs */
        .nav-tabs { border-bottom: 1px solid #eef0f3; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 500; border: none; padding: 12px 25px; transition: 0.3s; }
        .nav-tabs .nav-link:hover { color: #0d6efd; background: #f8f9fa; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; font-weight: 700; background: transparent; }

        /* Table & Sorting */
        .table-custom thead th { 
            background-color: #ffffff; color: #888; font-weight: 700; font-size: 0.75rem; 
            text-transform: uppercase; padding: 15px 10px; border-bottom: 2px solid #f0f0f0; 
            cursor: pointer; user-select: none; white-space: nowrap;
        }
        .table-custom thead th:hover { background-color: #f8f9fa; color: #0d6efd; }
        .table-custom tbody td { padding: 10px 10px; vertical-align: middle; border-bottom: 1px solid #f7f9fc; font-weight: 500; }
        
        .sort-icon { display: inline-block; margin-left: 5px; font-size: 0.7rem; opacity: 0.3; }
        .sort-active .sort-icon { opacity: 1; color: #0d6efd; }

        /* Badges */
        .badge-status { padding: 5px 10px; border-radius: 30px; font-size: 0.7rem; font-weight: 600; }
        .badge-pending { background-color: #fff4e5; color: #fd7e14; border: 1px solid #ffe5d0; }
        .badge-success { background-color: #e6f7ee; color: #198754; border: 1px solid #d1e7dd; }
        .badge-partial { background-color: #f3e8ff; color: #6f42c1; border: 1px solid #e0cffc; }
        
        #loading { display: none; }
        .progress-thin { height: 6px; border-radius: 10px; }

        /* --- ADVANCED FILTER STYLES --- */
        .filter-row {
            background-color: #fff; border: 1px solid #e9ecef; border-radius: 8px;
            padding: 10px 15px; margin-bottom: 10px; display: flex; align-items: flex-start; gap: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .filter-label { font-weight: 600; font-size: 0.8rem; color: #495057; min-width: 100px; padding-top: 6px; }
        .filter-input-container { flex-grow: 1; width: 100%; }
        .btn-remove-filter { color: #dc3545; cursor: pointer; font-size: 1.2rem; opacity: 0.5; transition: 0.2s; margin-top: 2px; }
        .btn-remove-filter:hover { opacity: 1; transform: scale(1.1); }

        /* Custom Multi Select Dropdown */
        .multi-select-dropdown {
            position: relative;
            width: 100%;
        }
        .multi-select-btn {
            width: 100%; text-align: left; background: #fff; border: 1px solid #dee2e6;
            padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; color: #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .multi-select-menu {
            position: absolute; top: 100%; left: 0; width: 100%; z-index: 1000;
            background: #fff; border: 1px solid #dee2e6; border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; margin-top: 2px;
        }
        .multi-select-menu.show { display: block; }
        .multi-select-search { padding: 8px; border-bottom: 1px solid #eee; background: #f8f9fa; }
        .multi-select-options { max-height: 200px; overflow-y: auto; padding: 5px 0; }
        .multi-select-option {
            padding: 6px 12px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px;
        }
        .multi-select-option:hover { background-color: #f1f4f9; }
        .multi-select-option input[type="checkbox"] { cursor: pointer; width: 14px; height: 14px; }
    </style>
</head>
<body>

<div class="container-fluid px-4 py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="page-title mb-1">Daftar Kelola Penerimaan Tagihan</h3>
            <span class="text-muted small">Dashboard / Report View</span>
        </div>
        <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/entry/index.html" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-2"></i> Kembali ke Entry
        </a>
    </div>

    <div class="row g-3 mb-4" id="summarySection"></div>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('receiving', this)"><i class="bi bi-box-arrow-in-down me-2"></i>Penerimaan</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('list_po', this)"><i class="bi bi-list-check me-2"></i>List PO</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('detail', this)"><i class="bi bi-table me-2"></i>Laporan Detail</a></li>
    </ul>

    <div class="card-custom">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom gap-2">
            <div class="position-relative flex-grow-1" style="max-width: 400px;">
                <i class="bi bi-search position-absolute text-muted" style="top: 10px; left: 12px;"></i>
                <input type="text" id="searchInput" class="form-control ps-5 border-0 bg-light" placeholder="Search anything (contains)..." onkeyup="applyFilters()">
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm position-relative shadow-sm" data-bs-toggle="modal" data-bs-target="#filterModal">
                    <i class="bi bi-funnel-fill me-1"></i> Filter Conditions
                    <span id="activeFilterBadge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none">
                        <span class="visually-hidden">New alerts</span>
                    </span>
                </button>
                
                <button class="btn btn-light border btn-sm" onclick="fetchData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <div id="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted small">Synchronizing data...</p>
        </div>

        <div class="table-responsive">
            <table class="table table-custom d-none" id="mainTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div class="p-3 text-muted small border-top d-flex justify-content-between">
            <span>Showing <span id="shownCount">0</span> of <span id="totalCount">0</span> records</span>
        </div>
    </div>
</div>

<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-funnel me-2"></i> Filter Data (Cascading)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body bg-light">
                <div id="activeFiltersContainer">
                    <div class="text-center py-5" id="emptyFilterMsg">
                        <i class="bi bi-filter-circle text-muted fs-1 mb-2"></i>
                        <p class="text-muted small">No active filters. Click "Add Condition" to filter data.</p>
                    </div>
                </div>

                <div class="dropdown mt-3">
                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-plus-circle me-1"></i> Add Condition
                    </button>
                    <ul class="dropdown-menu shadow" id="conditionDropdown">
                        </ul>
                </div>
            </div>

            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-sm btn-link text-muted text-decoration-none me-auto" onclick="resetDynamicFilters()">Reset All</button>
                <button type="button" class="btn btn-sm btn-primary px-4" onclick="applyFilters()" data-bs-dismiss="modal">Apply Filter</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0">
            <div class="modal-header pt-4 px-4">
                <div class="d-flex align-items-start w-100">
                    <div class="header-icon-box" id="modalIconBox"><i class="bi bi-file-earmark-text"></i></div>
                    <div>
                        <h5 class="modal-title-custom mb-0" id="modalTitle">Detail Data</h5>
                    </div>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="p-4 bg-white" id="modalInfoSection"></div>
                <div class="table-responsive">
                    <table class="table table-striped mb-0 w-100">
                        <thead id="modalTableHead" class="bg-light small text-uppercase"></thead>
                        <tbody id="modalTableBody" class="small"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyEDVCUPc41LBUK8G-FBSQDfLVDiPOv0cHI3PfHNTe6BKQ0j36yMLzB-sp6I5ZSGBZQ/exec'; 

    let allData = [];
    let displayedData = [];
    let currentTab = 'receiving'; 
    let sortState = { key: 'id', direction: 'desc' };
    
    // Structure: { id: timestamp, key: columnKey, type: 'date'|'multi_select', values: [] }
    let activeFilters = []; 

    // --- CONFIGURATION ---
    // filterType: 'multi_select' (Checkbox Dropdown), 'date' (Range), null (No filter)
    const CONFIG = {
        'receiving': {
            columns: [
                { label: 'Reference', key: 'id', filterType: 'multi_select' }, 
                { label: 'Vendor', key: 'vendor', filterType: 'multi_select' },
                { label: 'Date', key: 'date', filterType: 'date' }, 
                { label: 'Items', key: 'itemsCount', filterType: null }, 
                { label: 'Total Qty', key: 'totalQty', filterType: null }, 
                { label: 'Action', key: null }
            ],
            title: 'Detail Penerimaan',
            modalCols: ['Tipe', 'Description', 'KPC', 'UoM', 'Ordered', 'Recv Before', 'This Rect']
        },
        'list_po': {
            columns: [
                { label: 'Inv Number', key: 'id', filterType: 'multi_select' }, 
                { label: 'Vendor', key: 'vendor', filterType: 'multi_select' },
                { label: 'Inv Date', key: 'date', filterType: 'date' }, 
                { label: 'Status', key: 'normalizedStatus', filterType: 'multi_select' },
                { label: 'Items', key: 'itemsCount', filterType: null }, 
                { label: 'Total Order', key: 'totalQty', filterType: null },
                { label: 'Arrived', key: 'totalArrived', filterType: null }, 
                { label: 'Progress', key: 'percent', isSortable: true, filterType: null },
                { label: 'Action', key: null }
            ],
            title: 'Detail Invoice',
            modalCols: ['Tipe', 'Item Name', 'Qty Order', 'Qty Arrived', 'Qty Remaining']
        },
        'detail': {
            columns: [
                { label: 'Rec ID', key: 'id', filterType: 'multi_select' }, 
                { label: 'Date', key: 'date', filterType: 'date' },
                { label: 'Supplier', key: 'vendor', filterType: 'multi_select' }, 
                { label: 'Inv Number', key: 'inv', filterType: 'multi_select' },
                { label: 'PO Number', key: 'po', filterType: 'multi_select' }, 
                { label: 'Item Name', key: 'item', filterType: 'multi_select' },
                { label: 'Ordered', key: 'qtyOrder', filterType: null }, 
                { label: 'Recv Bef', key: 'qtyBefore', filterType: null },
                { label: 'This Rect', key: 'qtyNow', filterType: null }, 
                { label: 'UoM', key: 'uom', filterType: 'multi_select' },
                // CHANGE: KPC Moved AFTER UOM
                { label: 'KPC Number', key: 'kpc', filterType: 'multi_select' }, 
                { label: 'Container', key: 'container', filterType: 'multi_select' }
            ],
            title: 'Laporan Detail',
            modalCols: []
        }
    };

    // --- INIT ---
    function switchTab(tabName, element) {
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        currentTab = tabName;
        resetDynamicFilters(false);
        sortState = { key: 'id', direction: 'desc' };
        fetchData();
    }

    async function fetchData() {
        const loading = document.getElementById('loading');
        const table = document.getElementById('mainTable');
        
        loading.style.display = 'block';
        table.classList.add('d-none');
        document.getElementById('tableBody').innerHTML = '';
        document.getElementById('summarySection').innerHTML = '';

        try {
            const response = await fetch(`${WEB_APP_URL}?type=${currentTab}`);
            let data = await response.json();
            
            if (data.error) { alert("Error: " + data.error); return; }

            data = data.map(normalizeData);
            allData = data;
            displayedData = [...allData];

            handleSort(sortState.key, false);
            updateSummary();
            
            loading.style.display = 'none';
            table.classList.remove('d-none');

        } catch (error) {
            console.error(error);
            loading.innerHTML = '<p class="text-danger">Gagal koneksi ke server.</p>';
        }
    }

    function normalizeData(row) {
        row.itemsCount = row.items ? row.items.length : 0;
        row.totalQty = parseFloat(row.totalQty) || 0;
        row.qtyNow = parseFloat(row.qtyNow) || 0;
        
        if (currentTab === 'list_po') {
            let s = row.status ? row.status.toString().trim() : "Belum Diterima";
            if (s === "") s = "Belum Diterima";
            row.normalizedStatus = s;

            let arr = 0;
            if(row.items) arr = row.items.reduce((sum, item) => sum + (parseFloat(item.val2) || 0), 0);
            row.totalArrived = arr;
            row.percent = row.totalQty > 0 ? (arr / row.totalQty) * 100 : 0;
        }
        return row;
    }

    // --- DYNAMIC FILTER SYSTEM (CASCADING & MULTI-SELECT) ---

    document.getElementById('filterModal').addEventListener('show.bs.modal', setupConditionDropdown);

    function setupConditionDropdown() {
        const dropdown = document.getElementById('conditionDropdown');
        dropdown.innerHTML = '';
        const activeColumns = CONFIG[currentTab].columns;
        activeColumns.forEach(col => {
            if (col.filterType) {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item small" href="#" onclick="addFilterRow('${col.key}', '${col.filterType}', '${col.label}')">${col.label}</a>`;
                dropdown.appendChild(li);
            }
        });
    }

    function addFilterRow(key, type, label) {
        // Prevent duplicate filters for same key
        if(activeFilters.find(f => f.key === key)) {
            alert("Filter for " + label + " already active.");
            return;
        }

        document.getElementById('emptyFilterMsg').style.display = 'none';
        const filterId = Date.now(); 
        
        // Initial state
        activeFilters.push({ id: filterId, key: key, type: type, values: [], start: null, end: null });

        const container = document.getElementById('activeFiltersContainer');
        const row = document.createElement('div');
        row.className = 'filter-row';
        row.id = `filter-row-${filterId}`;
        
        let inputHtml = '';

        if (type === 'date') {
            inputHtml = `
                <div class="d-flex align-items-center gap-2">
                    <input type="date" class="form-control form-control-sm" onchange="updateFilterVal(${filterId}, 'date', this.value, 'start')">
                    <span class="text-muted small">to</span>
                    <input type="date" class="form-control form-control-sm" onchange="updateFilterVal(${filterId}, 'date', this.value, 'end')">
                </div>
            `;
        } 
        else if (type === 'multi_select') {
            // Placeholder for Multi Select, options will be loaded dynamically
            inputHtml = `
                <div class="multi-select-dropdown" id="ms-dropdown-${filterId}">
                    <button class="multi-select-btn" onclick="toggleMultiSelect(${filterId})">
                        <span id="ms-label-${filterId}">Select options...</span>
                        <i class="bi bi-chevron-down small text-muted"></i>
                    </button>
                    <div class="multi-select-menu shadow-sm" id="ms-menu-${filterId}">
                        <div class="multi-select-search">
                            <input type="text" class="form-control form-control-sm" placeholder="Search..." onkeyup="filterMultiSelectOptions(${filterId}, this.value)">
                        </div>
                        <div class="multi-select-options" id="ms-options-${filterId}">
                            </div>
                    </div>
                </div>
            `;
        }

        row.innerHTML = `
            <div class="filter-label">${label}</div>
            <div class="filter-input-container">${inputHtml}</div>
            <i class="bi bi-x-circle btn-remove-filter" onclick="removeFilterRow(${filterId})"></i>
        `;

        container.appendChild(row);

        if (type === 'multi_select') {
            // Load options initially (Cascading happens here)
            loadMultiSelectOptions(filterId, key);
        }
    }

    function removeFilterRow(id) {
        document.getElementById(`filter-row-${id}`).remove();
        activeFilters = activeFilters.filter(f => f.id !== id);
        if(activeFilters.length === 0) document.getElementById('emptyFilterMsg').style.display = 'block';
    }

    // --- CASCADING LOGIC CORE ---
    function getCascadingOptions(targetKey) {
        // Filter data based on ALL active filters EXCEPT the current one
        // This ensures cascading (e.g., Date limits Vendor), but allows modifying the current filter
        let filteredContext = allData.filter(row => {
            for (let filter of activeFilters) {
                if (filter.key === targetKey) continue; // Skip self

// Date Check
if (filter.type === 'date') {
    if(!row.date) continue; 
    const parts = row.date.split('/');
    if(parts.length !== 3) continue;
    
    const rowDate = new Date(parts[2], parts[1]-1, parts[0]);
    rowDate.setHours(0,0,0,0);

    if (filter.start) {
        const s = filter.start.split('-');
        const startDate = new Date(s[0], s[1]-1, s[2]);
        startDate.setHours(0,0,0,0);
        if (rowDate < startDate) return false;
    }
    
    if (filter.end) {
        const e = filter.end.split('-');
        const endDate = new Date(e[0], e[1]-1, e[2]);
        endDate.setHours(23,59,59,999);
        if (rowDate > endDate) return false;
    }
}
                // Multi Select Check
                else if (filter.type === 'multi_select' && filter.values.length > 0) {
                     if (!filter.values.includes(row[filter.key])) return false;
                }
            }
            return true;
        });

        // Get unique values for the target column from the filtered context
        const uniqueValues = [...new Set(filteredContext.map(item => item[targetKey]))].sort();
        // Remove empty/null
        return uniqueValues.filter(v => v && v !== '-' && v.trim() !== '');
    }

    function loadMultiSelectOptions(filterId, key) {
        const optionsContainer = document.getElementById(`ms-options-${filterId}`);
        const availableOptions = getCascadingOptions(key);
        
        let html = '';
        if (availableOptions.length === 0) {
            html = '<div class="p-2 text-muted small fst-italic">No options available based on other filters.</div>';
        } else {
            availableOptions.forEach(val => {
                html += `
                    <label class="multi-select-option">
                        <input type="checkbox" value="${val}" onchange="updateFilterVal(${filterId}, 'multi_select', '${val}', null, this.checked)">
                        <span>${val}</span>
                    </label>
                `;
            });
        }
        optionsContainer.innerHTML = html;
    }

    function toggleMultiSelect(id) {
        // Close others
        document.querySelectorAll('.multi-select-menu').forEach(el => {
            if(el.id !== `ms-menu-${id}`) el.classList.remove('show');
        });

        const menu = document.getElementById(`ms-menu-${id}`);
        // Refresh options when opening to ensure cascading is up to date
        const filter = activeFilters.find(f => f.id === id);
        if(filter && !menu.classList.contains('show')) {
            // Re-load options to reflect changes in other filters
            // But we need to keep selected ones checked
            const currentSelection = filter.values;
            const optionsContainer = document.getElementById(`ms-options-${id}`);
            const availableOptions = getCascadingOptions(filter.key);
            
            let html = '';
            availableOptions.forEach(val => {
                const isChecked = currentSelection.includes(val) ? 'checked' : '';
                html += `
                    <label class="multi-select-option">
                        <input type="checkbox" value="${val}" ${isChecked} onchange="updateFilterVal(${id}, 'multi_select', '${val}', null, this.checked)">
                        <span>${val}</span>
                    </label>
                `;
            });
            optionsContainer.innerHTML = html;
        }
        menu.classList.toggle('show');
    }

    // Close dropdowns when clicking outside
    window.onclick = function(event) {
        if (!event.target.closest('.multi-select-dropdown')) {
            document.querySelectorAll('.multi-select-menu').forEach(el => el.classList.remove('show'));
        }
    }

    function filterMultiSelectOptions(id, text) {
        const container = document.getElementById(`ms-options-${id}`);
        const labels = container.getElementsByTagName('label');
        const filter = text.toLowerCase();
        
        for (let label of labels) {
            const txt = label.textContent || label.innerText;
            if (txt.toLowerCase().indexOf(filter) > -1) {
                label.style.display = "";
            } else {
                label.style.display = "none";
            }
        }
    }

    function updateFilterVal(id, type, val, dateType, isChecked) {
        const filter = activeFilters.find(f => f.id === id);
        if(!filter) return;

        if (type === 'date') {
            if (dateType === 'start') filter.start = val;
            if (dateType === 'end') filter.end = val;
        } 
        else if (type === 'multi_select') {
            if (isChecked) {
                if (!filter.values.includes(val)) filter.values.push(val);
            } else {
                filter.values = filter.values.filter(v => v !== val);
            }
            
            // Update Label Button
            const btnLabel = document.getElementById(`ms-label-${id}`);
            if (filter.values.length === 0) btnLabel.innerText = "Select options...";
            else if (filter.values.length === 1) btnLabel.innerText = filter.values[0];
            else btnLabel.innerText = `${filter.values.length} selected`;
        }
    }

    function resetDynamicFilters(refresh = true) {
        activeFilters = [];
        document.getElementById('activeFiltersContainer').innerHTML = `
            <div class="text-center py-5" id="emptyFilterMsg">
                <i class="bi bi-filter-circle text-muted fs-1 mb-2"></i>
                <p class="text-muted small">No active filters. Click "Add Condition" to filter data.</p>
            </div>`;
        document.getElementById('searchInput').value = '';
        document.getElementById('activeFilterBadge').classList.add('d-none');
        if(refresh) { displayedData = allData; renderTable(displayedData); updateSummary(); }
    }

function applyFilters() {
        const searchInputVal = document.getElementById('searchInput').value.toLowerCase();
        
        const badge = document.getElementById('activeFilterBadge');
        if(activeFilters.length > 0 || searchInputVal) badge.classList.remove('d-none');
        else badge.classList.add('d-none');

        let filtered = allData.filter(row => {
            // Global Search
            let rowStr = Object.values(row).join(" ").toLowerCase();
            if (!rowStr.includes(searchInputVal)) return false;

            // --- BAGIAN INI YANG HILANG SEBELUMNYA (LOOPING) ---
            for (let filter of activeFilters) { 
                
                // Date Logic
                if (filter.type === 'date') {
                    if(!row.date) continue;
                    const parts = row.date.split('/');
                    if(parts.length !== 3) continue;
                    
                    // 1. Buat tanggal data (Set jam ke 00:00:00 agar murni tanggal)
                    const rowDate = new Date(parts[2], parts[1]-1, parts[0]);
                    rowDate.setHours(0,0,0,0);
                    
                    // 2. Cek Start Date
                    if (filter.start) {
                        const s = filter.start.split('-'); 
                        const startDate = new Date(s[0], s[1]-1, s[2]);
                        startDate.setHours(0,0,0,0);
                        
                        if (rowDate < startDate) return false;
                    }

                    // 3. Cek End Date
                    if (filter.end) {
                        const e = filter.end.split('-'); 
                        const endDate = new Date(e[0], e[1]-1, e[2]);
                        endDate.setHours(23,59,59,999); 
                        
                        if (rowDate > endDate) return false;
                    }
                }
                // Multi Select Logic
                else if (filter.type === 'multi_select') {
                     if (filter.values.length > 0) {
                         // Must match ONE of the selected values
                         if (!filter.values.includes(row[filter.key])) return false;
                     }
                }
            } // --- AKHIR LOOPING ---

            return true;
        });

        displayedData = filtered;
        handleSort(sortState.key, false);
        updateSummary(); 
    }

    // --- SUMMARY & TABLE RENDER (UNCHANGED LOGIC) ---
    function updateSummary() {
        const container = document.getElementById('summarySection');
        let html = '';

        // Gunakan displayedData (data yg sudah difilter) untuk summary yang dinamis?
        // Biasanya summary card menampilkan total dataset atau filtered dataset. 
        // Di sini saya gunakan displayedData agar angka berubah sesuai filter.
        const dataSet = displayedData; 

        if (currentTab === 'receiving') {
            const total = dataSet.length;
            const todayStr = new Date().toLocaleDateString('en-GB'); 
            const todayCount = dataSet.filter(d => d.date && d.date.startsWith(todayStr.substring(0,2))).length; 

            html = `
               <div class="col-md-3"><div class="summary-card border-purple"><span class="summary-label">Total Penerimaan</span><span class="summary-value text-purple">${total}</span></div></div>
               <div class="col-md-3"><div class="summary-card border-green"><span class="summary-label">Hari Ini (Est)</span><span class="summary-value text-green">${todayCount}</span></div></div>
            `;
        } 
        else if (currentTab === 'list_po') {
            let s=0, p=0, b=0;
            dataSet.forEach(d => {
                if(d.normalizedStatus==='Sudah Diterima') s++;
                else if(d.normalizedStatus==='Sebagian Diterima') p++;
                else b++;
            });
            html = `
               <div class="col-md-3"><div class="summary-card border-purple"><span class="summary-label">Sudah</span><span class="summary-value text-purple">${s}</span></div></div>
               <div class="col-md-3"><div class="summary-card border-green"><span class="summary-label">Sebagian</span><span class="summary-value text-green">${p}</span></div></div>
               <div class="col-md-3"><div class="summary-card border-orange"><span class="summary-label">Belum</span><span class="summary-value text-orange">${b}</span></div></div>
            `;
        } 
        else if (currentTab === 'detail') {
            const uniqueIDs = new Set(dataSet.map(d => d.id)).size;
            const uniqueContainers = new Set(dataSet.map(d => d.container).filter(c => c && c.trim() !== '' && c.trim() !== '-')).size;
            const totalProducts = dataSet.reduce((sum, d) => sum + (parseFloat(d.qtyNow) || 0), 0);

            html = `
               <div class="col-md-3">
                   <div class="summary-card border-purple">
                       <span class="summary-label">Total Penerimaan</span>
                       <span class="summary-value text-purple">${uniqueIDs}</span>
                   </div>
               </div>
               <div class="col-md-3">
                   <div class="summary-card border-blue">
                       <span class="summary-label">Total Container</span>
                       <span class="summary-value text-blue">${uniqueContainers}</span>
                   </div>
               </div>
               <div class="col-md-3">
                   <div class="summary-card border-green">
                       <span class="summary-label">Total Produk (Qty)</span>
                       <span class="summary-value text-green">${totalProducts.toLocaleString('id-ID')}</span>
                   </div>
               </div>
            `;
        }
        container.innerHTML = html;
    }

    function handleSort(key, toggle = true) {
        if (!key) return;
        if (toggle) {
            if (sortState.key === key) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            else { sortState.key = key; sortState.direction = 'asc'; }
        }
        displayedData.sort((a, b) => {
            let valA = a[key] || ''; let valB = b[key] || '';
            
            // Check if parsing date
            if (key === 'date') {
                const parseD = (str) => {
                     if(!str) return 0;
                     const p = str.split('/'); return p.length===3 ? new Date(p[2],p[1]-1,p[0]).getTime() : 0;
                };
                valA = parseD(valA); valB = parseD(valB);
            }
            else if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
            
            if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
            if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
            return 0;
        });
        renderTable(displayedData);
    }

    function renderTable(data) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        const conf = CONFIG[currentTab];

        let headerHtml = '<tr>';
        conf.columns.forEach(col => {
            let sortIcon = ''; let sortClass = ''; let clickAttr = '';
            if (col.key && col.isSortable !== false) {
                clickAttr = `onclick="handleSort('${col.key}')"`;
                if (sortState.key === col.key) {
                    sortClass = 'sort-active';
                    sortIcon = sortState.direction === 'asc' ? '<i class="bi bi-sort-up sort-icon"></i>' : '<i class="bi bi-sort-down sort-icon"></i>';
                } else { sortIcon = '<i class="bi bi-arrow-down-up sort-icon"></i>'; }
            }
            headerHtml += `<th class="${sortClass}" ${clickAttr}>${col.label} ${sortIcon}</th>`;
        });
        thead.innerHTML = headerHtml + '</tr>';

        tbody.innerHTML = '';
        document.getElementById('shownCount').innerText = data.length;
        document.getElementById('totalCount').innerText = allData.length;

        if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="${conf.columns.length}" class="text-center py-4 text-muted">Tidak ada data ditemukan</td></tr>`; return; }

        data.forEach(row => {
            let tr = document.createElement('tr');
            let inner = '';
            if (currentTab === 'receiving') {
                inner = `<td class="fw-bold text-primary">${row.id}</td><td>${row.vendor}</td><td>${row.date}</td><td class="text-center"><span class="badge bg-light text-dark border">${row.itemsCount}</span></td><td class="fw-bold">${row.totalQty}</td><td class="text-end"><button class="btn btn-sm btn-light text-primary" onclick="showDetail('${row.id}')"><i class="bi bi-eye-fill"></i></button></td>`;
            } else if (currentTab === 'list_po') {
                let badgeClass = "badge-pending";
                if (row.normalizedStatus === "Sudah Diterima") badgeClass = "badge-success";
                if (row.normalizedStatus === "Sebagian Diterima") badgeClass = "badge-partial";
                let pctDisp = Math.round(row.percent);
                let barColor = pctDisp === 100 ? 'bg-success' : 'bg-primary';

                inner = `<td class="fw-bold text-primary">${row.id}</td><td>${row.vendor}</td><td>${row.date}</td><td><span class="badge-status ${badgeClass}">${row.normalizedStatus}</span></td><td class="text-center">${row.itemsCount}</td><td class="fw-bold">${row.totalQty}</td><td class="fw-bold text-success">${row.totalArrived}</td><td><div class="d-flex align-items-center" style="width:120px"><div class="progress progress-thin flex-grow-1"><div class="progress-bar ${barColor}" style="width: ${pctDisp}%"></div></div><span class="ms-2 small fw-bold">${pctDisp}%</span></div></td><td class="text-end"><button class="btn btn-sm btn-light text-primary" onclick="showDetail('${row.id}')"><i class="bi bi-eye-fill"></i></button></td>`;
            } else if (currentTab === 'detail') {
                inner = `
                    <td class="text-primary fw-bold small text-nowrap">${row.id}</td>
                    <td class="small text-nowrap">${row.date}</td>
                    <td class="small text-nowrap">${row.vendor}</td>
                    <td class="small text-nowrap">${row.inv || '-'}</td>
                    <td class="small text-nowrap">${row.po || '-'}</td>
                    <td class="fw-bold small text-nowrap">${row.item}</td>
                    <td class="text-end small">${row.qtyOrder}</td>
                    <td class="text-end small text-muted">${row.qtyBefore}</td>
                    <td class="text-end fw-bold text-success bg-light">${row.qtyNow}</td>
                    <td class="small">${row.uom}</td>
                    <td class="small text-nowrap font-monospace text-muted">${row.kpc || '-'}</td>
                    <td class="small text-nowrap text-primary fw-bold">${row.container || '-'}</td>`;
            }
            tr.innerHTML = inner;
            tbody.appendChild(tr);
        });
    }

    // --- MODAL DETAIL ---
    function showDetail(id) {
        const data = allData.find(d => d.id === id);
        if (!data) return;
        document.getElementById('modalTitle').innerText = CONFIG[currentTab].title;
        document.getElementById('modalInfoSection').innerHTML = `<div class="row g-3"><div class="col-6"><span class="info-label">ID</span><div class="info-value text-primary">${data.id}</div></div><div class="col-6"><span class="info-label">Vendor</span><div class="fw-bold">${data.vendor}</div></div></div>`;
        
        let headHtml = '<tr>'; CONFIG[currentTab].modalCols.forEach(h => headHtml += `<th class="py-2 px-3 border-bottom">${h}</th>`);
        document.getElementById('modalTableHead').innerHTML = headHtml + '</tr>';
        
        let bodyHtml = '';
        if(data.items) {
            data.items.forEach(item => {
                if(currentTab==='receiving') bodyHtml += `<tr><td class="px-3">${item.col1}</td><td class="px-3 fw-bold">${item.col2}</td><td class="px-3">${item.col3}</td><td class="px-3">${item.col4}</td><td class="px-3 text-end">${item.val1}</td><td class="px-3 text-end">${item.val2}</td><td class="px-3 text-end fw-bold text-success bg-light">${item.val3}</td></tr>`;
                else bodyHtml += `<tr><td class="px-3">${item.col1}</td><td class="px-3 fw-bold">${item.col2}</td><td class="px-3 text-end">${item.val1}</td><td class="px-3 text-end fw-bold text-success">${item.val2}</td><td class="px-3 text-end fw-bold text-danger">${item.val3}</td></tr>`;
            });
        }
        document.getElementById('modalTableBody').innerHTML = bodyHtml;
        new bootstrap.Modal(document.getElementById('detailModal')).show();
    }

    fetchData();
</script>
</body>
</html>
