<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyqsUNP7oUdQsSOMLKCxgs4OZqROpF5ZzFr5IXNIs-jmOo-vNZJkPyQc1JTN431uBPK/exec";

let currentINV = "";
let invChoices = null;
let editChoices = null;
let isLocked = false;
let isEditMode = false;

function showLoading(){ loadingOverlay.style.display="flex"; }
function hideLoading(){ loadingOverlay.style.display="none"; }

/* ============================================================
   1Ô∏è‚É£  GENERATE RECEIVING ID
============================================================ */
async function loadNextReceivingId() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getlastreceivingid`);
    const data = await res.json();

    const now = new Date();
    const yy = String(now.getFullYear()).slice(2);
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const prefix = `RCV${yy}${mm}`;

    let nextId;
    if (!data.lastId || !data.lastId.startsWith(prefix)) {
      nextId = prefix + "0000001";
    } else {
      const lastSeq = parseInt(data.lastId.substring(7),10);
      nextId = prefix + String(lastSeq+1).padStart(7,"0");
    }
    receivingId.value = nextId;

  } catch (e) {
    const now = new Date();
    receivingId.value = `RCV${String(now.getFullYear()).slice(2)}${String(now.getMonth()+1).padStart(2,"0")}0000001`;
  }
}

/* ============================================================
   2Ô∏è‚É£  SUMMARY
============================================================ */
function renderSummary(header){
  summarySupplier.textContent       = header.supplier || "-";
  summaryDate.textContent           = header.invoiceDate || "-";
  summaryStatus.textContent         = header.status || "-";
  summaryTotalOrdered.textContent   = header.totalOrdered ?? "-";
  summaryTotalReceived.textContent  = header.totalReceived ?? "-";
  summaryTotalRemaining.textContent = header.totalRemaining ?? "-";
}

function renderSummaryFromLines(lines, supplier, lockedFlag){
  let tOrd = 0, tRec = 0, tRem = 0;

  lines.forEach(ln => {
    const ord  = Number(ln.orderedQty) || 0;
    const rec  = Number(ln.receivedToDate) || 0;
    const qty  = Number(ln.qtyThisReceipt) || 0;
    const rem  = Number(ln.remainingQty) || 0;

    tOrd += ord;
    tRec += rec + qty;
    tRem += rem;
  });

  summarySupplier.textContent = supplier || "-";
  summaryDate.textContent = "-";

  let status = "-";
  if (lockedFlag) status = "LOCKED";
  else if (tRem === 0) status = "Selesai";
  else if (tRec === 0) status = "Belum Diterima";
  else status = "Sebagian";

  summaryStatus.textContent = status;
  summaryTotalOrdered.textContent   = tOrd;
  summaryTotalReceived.textContent  = tRec;
  summaryTotalRemaining.textContent = tRem;
}

/* ============================================================
   3Ô∏è‚É£  LOCK STATE
============================================================ */
function applyLockState(locked){
  isLocked = !!locked;

  document.querySelectorAll(".qty-receipt").forEach(el => el.disabled = locked);
  document.querySelectorAll(".kpc-new").forEach(el => el.disabled = locked);

  receivingDate.disabled = locked;
  notes.disabled = locked;
  submitBtn.disabled = locked;

  lockWarning.style.display = locked ? "block" : "none";
}

/* ============================================================
   4Ô∏è‚É£  MODE HANDLING
============================================================ */
function enterNewMode(){
  isEditMode = false;
  if (editChoices) editChoices.setChoiceByValue("");
  invSelect.disabled = false;
  invChoices?.enable();
  applyLockState(false);
  loadNextReceivingId();
}

function enterEditMode(){
  isEditMode = true;
  invSelect.disabled = true;
  invChoices?.disable();
}

/* ============================================================
   5Ô∏è‚É£  TABLE ROW RENDERING
============================================================ */
function attachRowEvents(tr){
  const qtyInput = tr.querySelector(".qty-receipt");
  const kpcInput = tr.querySelector(".kpc-new");

  qtyInput.addEventListener("input", e => {
    const rem = +tr.querySelector(".remaining").value || 0;
    let val = +e.target.value;
    if (val < 0) val = 0;
    if (val > rem) val = rem;
    e.target.value = val;
  });

  const del = tr.querySelector(".delete-btn");
  del.addEventListener("click", () => tr.remove());

  const splitBtn = tr.querySelector(".split-btn");
  splitBtn.addEventListener("click", () => addSplitRow(tr));
}

function renderLines(lines, useExistingQty){
  tableBody.innerHTML = "";

  lines.forEach(ln => {
    const tr = document.createElement("tr");
    tr.dataset.rowIndex = ln.rowIndex;

    const remaining = Number(ln.remainingQty) || 0;
    const defaultQty = useExistingQty ? (Number(ln.qtyThisReceipt) || 0) : remaining;

    tr.innerHTML = `
      <td class="row-handle">‚ãÆ‚ãÆ</td>
      <td>${ln.poNumber}</td>
      <td><strong class="kpc-original">${ln.kpc}</strong></td>
      <td><input class="table-input kpc-new" placeholder="(optional)"></td>
      <td>${ln.description}</td>
      <td><input class="table-input readonly-field ordered" value="${ln.orderedQty}" readonly></td>
      <td><input class="table-input readonly-field received" value="${ln.receivedToDate}" readonly></td>
      <td><input class="table-input readonly-field remaining" value="${remaining}" readonly></td>
      <td><input type="number" class="table-input qty-receipt" value="${defaultQty}" min="0"></td>
      <td><input class="table-input readonly-field" value="${ln.uom || 'Meter'}" readonly></td>
      <td style="text-align:center;">
         <button type="button" class="split-btn">Ôºã</button>
      </td>
      <td class="delete-btn">üóë</td>
    `;

    tableBody.appendChild(tr);
    attachRowEvents(tr);
  });

  Sortable.create(tableBody,{ handle:".row-handle", animation:150 });
  applyLockState(isLocked);
}

/* ============================================================
   6Ô∏è‚É£  SPLIT ROW
============================================================ */
function addSplitRow(baseTr){
  const clone = baseTr.cloneNode(true);
  clone.dataset.rowIndex = baseTr.dataset.rowIndex;

  clone.querySelector(".kpc-new").value = "";
  clone.querySelector(".qty-receipt").value = "";

  tableBody.insertBefore(clone, baseTr.nextSibling);
  attachRowEvents(clone);
}

/* ============================================================
   7Ô∏è‚É£  LOAD INV LIST
============================================================ */
async function loadInvList(){
  const res = await fetch(`${SCRIPT_URL}?action=getinvlist`);
  const list = await res.json();

  if (invChoices) invChoices.destroy();
  invSelect.innerHTML = `<option value="">‚Äî Select INV ‚Äî</option>`;

  list.forEach(x => {
    const op = document.createElement("option");
    op.value = x.invNumber;
    op.textContent = x.invNumber;
    invSelect.appendChild(op);
  });

  invChoices = new Choices("#invSelect",{
    searchEnabled:true,
    itemSelectText:"",
    shouldSort:false
  });

  invSelect.addEventListener("change",()=>{
    if (!isEditMode && invSelect.value){
      currentINV = invSelect.value;
      loadInvDetail(invSelect.value);
    }
  });
}

/* ============================================================
   8Ô∏è‚É£  LOAD EDITABLE RECEIVING LIST (FIXED)
============================================================ */
async function loadEditableReceivingList(){
  let res = await fetch(`${SCRIPT_URL}?action=geteditablelist`);
  if (!res.ok){
    console.warn("Failed to load editable list");
    return;
  }

  const list = await res.json();

  if (editChoices) editChoices.destroy();
  editSelect.innerHTML = `<option value="">‚Äî New Receiving Entry ‚Äî</option>`;

  list.forEach(item=>{
    const op = document.createElement("option");
    op.value = item.receivingId;
    op.textContent = `${item.receivingId} ‚Äî ${item.invNumber || ""}`;
    editSelect.appendChild(op);
  });

  editChoices = new Choices("#editSelect",{
    searchEnabled:true,
    itemSelectText:"",
    shouldSort:false
  });

  editSelect.addEventListener("change",()=>{
    const id = editSelect.value;

    if (!id) {
      enterNewMode();
      if (invSelect.value){
        loadInvDetail(invSelect.value);
      } else {
        tableBody.innerHTML = "";
        renderSummary({supplier:"-",invoiceDate:"-",status:"-",totalOrdered:"-",totalReceived:"-",totalRemaining:"-"});
      }
      return;
    }

    loadReceivingEntry(id);
  });
}

/* ============================================================
   9Ô∏è‚É£  LOAD INV DETAIL
============================================================ */
async function loadInvDetail(inv){
  showLoading();
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getinvdetail&invNumber=${encodeURIComponent(inv)}`);
    const data = await res.json();

    currentINV = inv;

    renderSummary(data.header);
    renderLines(data.lines,false);
    applyLockState(false);

  } finally { hideLoading(); }
}

/* ============================================================
   üîü  LOAD EXISTING RECEIVING (EDIT MODE)
============================================================ */
async function loadReceivingEntry(rcvId){
  showLoading();
  try {
    const res = await fetch(`${SCRIPT_URL}?action=loadreceiving&id=${encodeURIComponent(rcvId)}`);
    const data = await res.json();

    enterEditMode();

    currentINV = data.invNumber || "";
    receivingId.value = data.receivingId;
    if (data.receivingDate) receivingDate.value = data.receivingDate;
    notes.value = data.notes || "";

    renderLines(data.lines,true);
    renderSummaryFromLines(data.lines, data.header?.supplier, data.locked);
    applyLockState(data.locked);

  } finally { hideLoading(); }
}

/* ============================================================
   1Ô∏è‚É£1Ô∏è‚É£  VALIDATION
============================================================ */
function validateForm(){
  if (isLocked) return "This Receiving Entry is locked.";
  if (!receivingDate.value) return "Receiving Date required.";
  if (!isEditMode && !invSelect.value) return "Inv Number required.";

  const rows = [...document.querySelectorAll("#tableBody tr")];
  if (rows.length===0) return "No line items.";

  let anyQty = false;
  const groups = {};

  for (const r of rows){
    const qty = +r.querySelector(".qty-receipt").value || 0;
    const rem = +r.querySelector(".remaining").value || 0;
    const idx = r.dataset.rowIndex;

    if (!groups[idx]) groups[idx] = {sum:0, remaining:rem, rows:[]};
    groups[idx].sum += qty;
    groups[idx].rows.push(r);

    if (qty > rem) return "Qty cannot exceed remaining.";
    if (qty > 0) anyQty = true;
  }
  if (!anyQty) return "At least one line must have Qty > 0.";

  // split rule: each split line with qty > 0 must have KPC optional
  for (const key in groups){
    const g = groups[key];
    if (g.sum > g.remaining) return `Total Qty exceeds Remaining for PO line.`

    if (g.rows.length > 1){
      for (const r of g.rows){
        const qty = +r.querySelector(".qty-receipt").value || 0;
        if (qty > 0){
          const newKpc = r.querySelector(".kpc-new").value.trim();
          if (!newKpc) return "Split lines must have KPC Optional.";
        }
      }
    }
  }

  return null;
}

/* ============================================================
   1Ô∏è‚É£2Ô∏è‚É£  SUBMIT
============================================================ */
function submitReceiving(){
  const err = validateForm();
  if (err) return alert(err);

  showLoading();

  const rows = [...document.querySelectorAll("#tableBody tr")];

  const lines = rows.map(r => {
    const poNumber = r.children[1].textContent.trim();
    const kpcOrg = r.querySelector(".kpc-original").textContent.trim();
    const kpcNew = r.querySelector(".kpc-new").value.trim();
    const kpcFinal = kpcNew || kpcOrg;

    return {
      rowIndex: r.dataset.rowIndex,
      poNumber: poNumber,
      kpc: kpcFinal,
      description: r.children[4].textContent.trim(),
      orderedQty: r.querySelector(".ordered").value,
      receivedToDate: r.querySelector(".received").value,
      remainingQty: r.querySelector(".remaining").value,
      qtyThisReceipt: r.querySelector(".qty-receipt").value,
      uom: "Meter"
    };
  });

  const payload = {
    receivingId: receivingId.value,
    receivingDate: receivingDate.value,
    invNumber: currentINV || invSelect.value || "",
    header: { supplier: summarySupplier.textContent || "" },
    notes: notes.value,
    lines: lines
  };

  fetch(SCRIPT_URL,{
    method:"POST",
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(async res=>{
    hideLoading();

    if (res.status==="success"){
      alert("Receiving saved.\nReceiving ID: "+payload.receivingId);

      await loadEditableReceivingList();

      enterNewMode();
      if (invSelect.value){
        currentINV = invSelect.value;
        loadInvDetail(invSelect.value);
      } else {
        tableBody.innerHTML = "";
        renderSummary({supplier:"-",invoiceDate:"-",status:"-",totalOrdered:"-",totalReceived:"-",totalRemaining:"-"});
      }
    } else {
      alert("Error: "+res.message);
    }
  })
  .catch(err=>{
    hideLoading();
    alert("Submit failed: "+err);
  });
}

/* ============================================================
   1Ô∏è‚É£3Ô∏è‚É£  INIT
============================================================ */
window.addEventListener("DOMContentLoaded", async ()=>{
  showLoading();

  const t = new Date();
  receivingDate.value =
    `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;

  await Promise.all([
    loadNextReceivingId(),
    loadInvList(),
    loadEditableReceivingList()
  ]);

  hideLoading();
});
</script>
