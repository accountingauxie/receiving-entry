<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Penerimaan & PO</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME & UTILS --- */
        body { background-color: #f8f9fc; font-family: 'Inter', sans-serif; color: #333; font-size: 0.88rem; }
        
        .card-custom { background: #fff; border: 1px solid #eef0f3; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        
        /* Summary Cards */
        .summary-card { background: #fff; padding: 15px 20px; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .summary-card:hover { transform: translateY(-2px); }
        .summary-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #666; display: block; }
        .summary-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
        
        .border-purple { border-left-color: #6f42c1; } .text-purple { color: #6f42c1; }
        .border-green { border-left-color: #198754; } .text-green { color: #198754; }
        .border-orange { border-left-color: #fd7e14; } .text-orange { color: #fd7e14; }
        .border-blue { border-left-color: #0d6efd; } .text-blue { color: #0d6efd; }

        /* Nav Tabs */
        .nav-tabs { border-bottom: 1px solid #eef0f3; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 500; border: none; padding: 12px 25px; transition: 0.3s; }
        .nav-tabs .nav-link:hover { color: #0d6efd; background: #f8f9fa; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; font-weight: 700; background: transparent; }

        /* Table & Sorting */
        .table-custom thead th { 
            background-color: #ffffff; color: #888; font-weight: 700; font-size: 0.75rem; 
            text-transform: uppercase; padding: 15px 10px; border-bottom: 2px solid #f0f0f0; 
            cursor: pointer; user-select: none; white-space: nowrap;
        }
        .table-custom thead th:hover { background-color: #f8f9fa; color: #0d6efd; }
        .table-custom tbody td { padding: 12px 10px; vertical-align: middle; border-bottom: 1px solid #f7f9fc; font-weight: 500; }
        
        .sort-icon { display: inline-block; margin-left: 5px; font-size: 0.7rem; opacity: 0.3; }
        .sort-active .sort-icon { opacity: 1; color: #0d6efd; }

        /* Badges */
        .badge-status { padding: 6px 12px; border-radius: 30px; font-size: 0.7rem; font-weight: 600; }
        .badge-pending { background-color: #fff4e5; color: #fd7e14; border: 1px solid #ffe5d0; }
        .badge-success { background-color: #e6f7ee; color: #198754; border: 1px solid #d1e7dd; }
        .badge-partial { background-color: #f3e8ff; color: #6f42c1; border: 1px solid #e0cffc; }
        
        /* Loading */
        #loading { display: none; }
        .progress-thin { height: 6px; border-radius: 10px; }

        /* --- XERO STYLE DYNAMIC FILTER --- */
        .filter-row {
            background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px;
            padding: 8px 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;
            transition: all 0.2s;
        }
        .filter-row:hover { border-color: #ced4da; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-label { font-weight: 600; font-size: 0.8rem; color: #495057; min-width: 120px; }
        .filter-input-container { flex-grow: 1; display: flex; gap: 10px; align-items: center; }
        .btn-remove-filter { color: #dc3545; cursor: pointer; padding: 4px; font-size: 1.1rem; opacity: 0.6; transition: 0.2s; }
        .btn-remove-filter:hover { opacity: 1; background-color: #ffe6e6; border-radius: 50%; }
        .dropdown-menu-filter { max-height: 250px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container-fluid px-4 py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="page-title mb-1">Daftar Kelola Penerimaan Tagihan</h3>
            <span class="text-muted small">Dashboard / Report View</span>
        </div>
        <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/entry/index.html" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-2"></i> Kembali ke Entry
        </a>
    </div>

    <div class="row g-3 mb-4" id="summarySection"></div>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('receiving', this)"><i class="bi bi-box-arrow-in-down me-2"></i>Penerimaan</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('list_po', this)"><i class="bi bi-list-check me-2"></i>List PO</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('detail', this)"><i class="bi bi-table me-2"></i>Laporan Detail</a></li>
    </ul>

    <div class="card-custom">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom gap-2">
            <div class="position-relative flex-grow-1" style="max-width: 400px;">
                <i class="bi bi-search position-absolute text-muted" style="top: 10px; left: 12px;"></i>
                <input type="text" id="searchInput" class="form-control ps-5 border-0 bg-light" placeholder="Search anything..." onkeyup="applyDynamicFilters()">
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm position-relative" data-bs-toggle="modal" data-bs-target="#filterModal">
                    <i class="bi bi-funnel-fill me-1"></i> Filter Conditions
                    <span id="activeFilterBadge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none">
                        <span class="visually-hidden">New alerts</span>
                    </span>
                </button>
                
                <button class="btn btn-light border btn-sm" onclick="fetchData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <div id="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted small">Synchronizing data...</p>
        </div>

        <div class="table-responsive">
            <table class="table table-custom d-none" id="mainTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div class="p-3 text-muted small border-top d-flex justify-content-between">
            <span>Showing <span id="shownCount">0</span> of <span id="totalCount">0</span> records</span>
        </div>
    </div>
</div>

<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-funnel me-2"></i>Filter Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <div id="activeFiltersContainer" class="mb-3">
                    <p class="text-muted small fst-italic text-center py-4" id="emptyFilterMsg">
                        No conditions applied. Click "Add Condition" to filter by specific columns.
                    </p>
                </div>

                <div class="dropdown">
                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-plus-circle me-1"></i> Add Condition
                    </button>
                    <ul class="dropdown-menu dropdown-menu-filter" id="conditionDropdown">
                        </ul>
                </div>
            </div>

            <div class="modal-footer bg-light p-2">
                <button type="button" class="btn btn-sm btn-link text-muted text-decoration-none me-auto" onclick="resetDynamicFilters()">Clear All</button>
                <button type="button" class="btn btn-sm btn-primary px-4" onclick="applyDynamicFilters()" data-bs-dismiss="modal">Apply Filter</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0">
            <div class="modal-header pt-4 px-4">
                <div class="d-flex align-items-start w-100">
                    <div class="header-icon-box" id="modalIconBox"><i class="bi bi-file-earmark-text"></i></div>
                    <div>
                        <h5 class="modal-title-custom mb-0" id="modalTitle">Detail Data</h5>
                    </div>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="p-4 bg-white" id="modalInfoSection"></div>
                <div class="table-responsive">
                    <table class="table table-striped mb-0 w-100">
                        <thead id="modalTableHead" class="bg-light small text-uppercase"></thead>
                        <tbody id="modalTableBody" class="small"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyy_EHVZQKLhqKTp_iPCsH79IPyae2-GXiZJn1Scucf63ULP-WVLSaIj8ZkFD9fEVbk/exec'; 

    let allData = [];
    let displayedData = [];
    let currentTab = 'receiving'; 
    let sortState = { key: 'id', direction: 'desc' };
    let activeFilters = []; 

    // --- CONFIGURATION DENGAN DEFINISI FILTER ---
    // filterType: 'text' (input biasa), 'select' (dropdown unik), 'date' (rentang tanggal)
    const CONFIG = {
        'receiving': {
            columns: [
                { label: 'Reference', key: 'id', filterType: 'text' }, 
                { label: 'Vendor', key: 'vendor', filterType: 'select' },
                { label: 'Date', key: 'date', filterType: 'date' }, 
                { label: 'Items', key: 'itemsCount', filterType: null }, // Tidak difilter
                { label: 'Total Qty', key: 'totalQty', filterType: 'text' }, 
                { label: 'Action', key: null }
            ],
            title: 'Detail Penerimaan',
            modalCols: ['Tipe', 'Description', 'KPC', 'UoM', 'Ordered', 'Recv Before', 'This Rect']
        },
        'list_po': {
            columns: [
                { label: 'Inv Number', key: 'id', filterType: 'text' }, 
                { label: 'Vendor', key: 'vendor', filterType: 'select' },
                { label: 'Inv Date', key: 'date', filterType: 'date' }, 
                { label: 'Status', key: 'normalizedStatus', filterType: 'select' },
                { label: 'Items', key: 'itemsCount', filterType: null }, 
                { label: 'Total Order', key: 'totalQty', filterType: 'text' },
                { label: 'Arrived', key: 'totalArrived', filterType: 'text' }, 
                { label: 'Progress', key: 'percent', isSortable: true, filterType: null },
                { label: 'Action', key: null }
            ],
            title: 'Detail Invoice',
            modalCols: ['Tipe', 'Item Name', 'Qty Order', 'Qty Arrived', 'Qty Remaining']
        },
        'detail': {
            columns: [
                { label: 'Rec ID', key: 'id', filterType: 'text' }, 
                { label: 'Date', key: 'date', filterType: 'date' },
                { label: 'Supplier', key: 'vendor', filterType: 'select' }, 
                { label: 'Inv Number', key: 'inv', filterType: 'text' },
                { label: 'PO Number', key: 'po', filterType: 'text' }, 
                { label: 'KPC Number', key: 'kpc', filterType: 'text' }, // <--- KOLOM BARU
                { label: 'Item Name', key: 'item', filterType: 'text' },
                { label: 'Ordered', key: 'qtyOrder', filterType: 'text' }, 
                { label: 'Recv Bef', key: 'qtyBefore', filterType: 'text' },
                { label: 'This Rect', key: 'qtyNow', filterType: 'text' }, 
                { label: 'UoM', key: 'uom', filterType: 'select' },
                { label: 'Container', key: 'container', filterType: 'select' }
            ],
            title: 'Laporan Detail',
            modalCols: []
        }
    };

    // --- INIT ---
    function switchTab(tabName, element) {
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        currentTab = tabName;
        
        resetDynamicFilters(false);
        sortState = { key: 'id', direction: 'desc' };
        
        fetchData();
    }

    async function fetchData() {
        const loading = document.getElementById('loading');
        const table = document.getElementById('mainTable');
        
        loading.style.display = 'block';
        table.classList.add('d-none');
        document.getElementById('tableBody').innerHTML = '';
        document.getElementById('summarySection').innerHTML = '';

        try {
            const response = await fetch(`${WEB_APP_URL}?type=${currentTab}`);
            let data = await response.json();
            
            if (data.error) { alert("Error: " + data.error); return; }

            data = data.map(normalizeData);
            allData = data;
            displayedData = [...allData];

            handleSort(sortState.key, false);
            updateSummary();
            
            loading.style.display = 'none';
            table.classList.remove('d-none');

        } catch (error) {
            console.error(error);
            loading.innerHTML = '<p class="text-danger">Gagal koneksi ke server.</p>';
        }
    }

    function normalizeData(row) {
        row.itemsCount = row.items ? row.items.length : 0;
        row.totalQty = parseFloat(row.totalQty) || 0;
        row.qtyOrder = parseFloat(row.qtyOrder) || 0;
        row.qtyNow = parseFloat(row.qtyNow) || 0;
        
        if (currentTab === 'list_po') {
            let s = row.status ? row.status.toString().trim() : "Belum Diterima";
            if (s === "") s = "Belum Diterima";
            row.normalizedStatus = s;

            let arr = 0;
            if(row.items) arr = row.items.reduce((sum, item) => sum + (parseFloat(item.val2) || 0), 0);
            row.totalArrived = arr;
            row.percent = row.totalQty > 0 ? (arr / row.totalQty) * 100 : 0;
        }
        return row;
    }

    // --- SUMMARY LOGIC ---
    function updateSummary() {
        const container = document.getElementById('summarySection');
        let html = '';

        if (currentTab === 'receiving') {
            const total = allData.length;
            const todayStr = new Date().toLocaleDateString('en-GB'); 
            const todayCount = allData.filter(d => d.date.startsWith(todayStr.substring(0,2))).length; 

            html = `
               <div class="col-md-3"><div class="summary-card border-purple"><span class="summary-label">Total Penerimaan</span><span class="summary-value text-purple">${total}</span></div></div>
               <div class="col-md-3"><div class="summary-card border-green"><span class="summary-label">Hari Ini (Est)</span><span class="summary-value text-green">${todayCount}</span></div></div>
            `;
        } 
        else if (currentTab === 'list_po') {
            let s=0, p=0, b=0;
            allData.forEach(d => {
                if(d.normalizedStatus==='Sudah Diterima') s++;
                else if(d.normalizedStatus==='Sebagian Diterima') p++;
                else b++;
            });
            html = `
               <div class="col-md-3"><div class="summary-card border-purple"><span class="summary-label">Sudah</span><span class="summary-value text-purple">${s}</span></div></div>
               <div class="col-md-3"><div class="summary-card border-green"><span class="summary-label">Sebagian</span><span class="summary-value text-green">${p}</span></div></div>
               <div class="col-md-3"><div class="summary-card border-orange"><span class="summary-label">Belum</span><span class="summary-value text-orange">${b}</span></div></div>
            `;
        } 
        else if (currentTab === 'detail') {
            const uniqueIDs = new Set(allData.map(d => d.id)).size;
            const uniqueContainers = new Set(allData.map(d => d.container).filter(c => c && c.trim() !== '' && c.trim() !== '-')).size;
            const totalProducts = allData.reduce((sum, d) => sum + (parseFloat(d.qtyNow) || 0), 0);

            html = `
               <div class="col-md-3">
                   <div class="summary-card border-purple">
                       <span class="summary-label">Total Penerimaan</span>
                       <span class="summary-value text-purple">${uniqueIDs}</span>
                   </div>
               </div>
               <div class="col-md-3">
                   <div class="summary-card border-blue">
                       <span class="summary-label">Total Container</span>
                       <span class="summary-value text-blue">${uniqueContainers}</span>
                   </div>
               </div>
               <div class="col-md-3">
                   <div class="summary-card border-green">
                       <span class="summary-label">Total Produk (Qty)</span>
                       <span class="summary-value text-green">${totalProducts.toLocaleString('id-ID')}</span>
                   </div>
               </div>
            `;
        }
        container.innerHTML = html;
    }

    // --- SORTING ---
    function handleSort(key, toggle = true) {
        if (!key) return;
        if (toggle) {
            if (sortState.key === key) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            else { sortState.key = key; sortState.direction = 'asc'; }
        }
        displayedData.sort((a, b) => {
            let valA = a[key] || ''; let valB = b[key] || '';
            if (key === 'date') { valA = parseDate(valA); valB = parseDate(valB); }
            else if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
            if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
            if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
            return 0;
        });
        renderTable(displayedData);
    }

    function parseDate(dateStr) {
        if (!dateStr) return 0;
        const parts = dateStr.split('/');
        if (parts.length !== 3) return dateStr;
        return new Date(parts[2], parts[1]-1, parts[0]).getTime();
    }

    // --- SMART DYNAMIC FILTER SYSTEM ---
    
    // 1. Setup Dropdown OTOMATIS berdasarkan CONFIG
    document.getElementById('filterModal').addEventListener('show.bs.modal', setupConditionDropdown);

    function setupConditionDropdown() {
        const dropdown = document.getElementById('conditionDropdown');
        dropdown.innerHTML = '';
        
        // Ambil definisi kolom dari tab yang sedang aktif
        const activeColumns = CONFIG[currentTab].columns;

        // Loop setiap kolom, jika ada filterType, tambahkan ke dropdown
        activeColumns.forEach(col => {
            if (col.filterType) {
                const li = document.createElement('li');
                // Simpan metadata (key dan type) untuk dipakai saat diklik
                li.innerHTML = `<a class="dropdown-item small" href="#" onclick="addFilterRow('${col.key}', '${col.filterType}', '${col.label}')">${col.label}</a>`;
                dropdown.appendChild(li);
            }
        });
    }

    // 2. Add Row (Generic)
    function addFilterRow(key, type, label) {
        document.getElementById('emptyFilterMsg').style.display = 'none';

        const filterId = Date.now(); 
        activeFilters.push({ id: filterId, key: key, type: type, value: null, value2: null });

        const container = document.getElementById('activeFiltersContainer');
        const row = document.createElement('div');
        row.className = 'filter-row';
        row.id = `filter-row-${filterId}`;
        row.innerHTML = `<div class="filter-label">${label}</div>`;

        const inputContainer = document.createElement('div');
        inputContainer.className = 'filter-input-container';

        if (type === 'text') {
            inputContainer.innerHTML = `<input type="text" class="form-control form-control-sm" placeholder="Contains..." oninput="updateFilterVal(${filterId}, this.value)">`;
        } 
        else if (type === 'date') {
            inputContainer.innerHTML = `
                <input type="date" class="form-control form-control-sm" onchange="updateFilterVal(${filterId}, this.value, 'start')">
                <span class="text-muted small">to</span>
                <input type="date" class="form-control form-control-sm" onchange="updateFilterVal(${filterId}, this.value, 'end')">`;
        }
        else if (type === 'select') {
            // Populate unik values dari data
            const uniqueValues = [...new Set(allData.map(item => item[key]))].sort();
            let options = `<option value="">-- All --</option>`;
            uniqueValues.forEach(val => { if (val && val !== '-') options += `<option value="${val}">${val}</option>`; });
            inputContainer.innerHTML = `<select class="form-select form-select-sm" onchange="updateFilterVal(${filterId}, this.value)">${options}</select>`;
        }

        row.appendChild(inputContainer);
        const removeBtn = document.createElement('i');
        removeBtn.className = 'bi bi-x-circle btn-remove-filter';
        removeBtn.onclick = () => removeFilterRow(filterId);
        row.appendChild(removeBtn);
        container.appendChild(row);
    }

    // 3. Helper Functions
    function removeFilterRow(id) {
        document.getElementById(`filter-row-${id}`).remove();
        activeFilters = activeFilters.filter(f => f.id !== id);
        if(activeFilters.length === 0) document.getElementById('emptyFilterMsg').style.display = 'block';
    }

    function updateFilterVal(id, val, rangeType = null) {
        const filter = activeFilters.find(f => f.id === id);
        if(filter) {
            if (filter.type === 'date') {
                if (rangeType === 'start') filter.value = val;
                if (rangeType === 'end') filter.value2 = val;
            } else { filter.value = val; }
        }
    }

    function resetDynamicFilters(refresh = true) {
        activeFilters = [];
        document.getElementById('activeFiltersContainer').innerHTML = `<p class="text-muted small fst-italic text-center py-4" id="emptyFilterMsg">No conditions applied.</p>`;
        document.getElementById('searchInput').value = '';
        document.getElementById('activeFilterBadge').classList.add('d-none');
        if(refresh) { displayedData = allData; renderTable(displayedData); }
    }

    // 4. Engine Apply
    function applyDynamicFilters() {
        const searchInputVal = document.getElementById('searchInput').value.toLowerCase();
        
        const badge = document.getElementById('activeFilterBadge');
        if(activeFilters.length > 0 || searchInputVal) badge.classList.remove('d-none');
        else badge.classList.add('d-none');

        let filtered = allData.filter(row => {
            // Global Search (Cari di semua kolom visible)
            let rowStr = Object.values(row).join(" ").toLowerCase();
            if (!rowStr.includes(searchInputVal)) return false;

            // Condition Check
            for (let filter of activeFilters) {
                if (!filter.value && !filter.value2) continue; 
                
                // Ambil nilai dari baris data berdasarkan key filter
                const cellValue = row[filter.key]; 

                if (filter.type === 'date') {
                    if(!cellValue) continue;
                    const parts = cellValue.split('/');
                    if(parts.length !== 3) continue;
                    const rowDate = new Date(parts[2], parts[1]-1, parts[0]);
                    
                    if (filter.value && rowDate < new Date(filter.value)) return false;
                    if (filter.value2) {
                        const end = new Date(filter.value2); end.setHours(23,59,59);
                        if (rowDate > end) return false;
                    }
                }
                else if (filter.type === 'text') {
                     const cellStr = String(cellValue || "").toLowerCase();
                     if (!cellStr.includes(String(filter.value).toLowerCase())) return false;
                }
                else if (filter.type === 'select') {
                    if (cellValue !== filter.value) return false;
                }
            }
            return true;
        });

        displayedData = filtered;
        handleSort(sortState.key, false);
    }

    // --- RENDER TABLE ---
    function renderTable(data) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        const conf = CONFIG[currentTab];

        let headerHtml = '<tr>';
        conf.columns.forEach(col => {
            let sortIcon = ''; let sortClass = ''; let clickAttr = '';
            if (col.key && col.isSortable !== false) {
                clickAttr = `onclick="handleSort('${col.key}')"`;
                if (sortState.key === col.key) {
                    sortClass = 'sort-active';
                    sortIcon = sortState.direction === 'asc' ? '<i class="bi bi-sort-up sort-icon"></i>' : '<i class="bi bi-sort-down sort-icon"></i>';
                } else { sortIcon = '<i class="bi bi-arrow-down-up sort-icon"></i>'; }
            }
            headerHtml += `<th class="${sortClass}" ${clickAttr}>${col.label} ${sortIcon}</th>`;
        });
        thead.innerHTML = headerHtml + '</tr>';

        tbody.innerHTML = '';
        document.getElementById('shownCount').innerText = data.length;
        document.getElementById('totalCount').innerText = allData.length;

        if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="${conf.columns.length}" class="text-center py-4 text-muted">Tidak ada data ditemukan</td></tr>`; return; }

        data.forEach(row => {
            let tr = document.createElement('tr');
            let inner = '';
            if (currentTab === 'receiving') {
                inner = `<td class="fw-bold text-primary">${row.id}</td><td>${row.vendor}</td><td>${row.date}</td><td class="text-center"><span class="badge bg-light text-dark border">${row.itemsCount}</span></td><td class="fw-bold">${row.totalQty}</td><td class="text-end"><button class="btn btn-sm btn-light text-primary" onclick="showDetail('${row.id}')"><i class="bi bi-eye-fill"></i></button></td>`;
            } else if (currentTab === 'list_po') {
                let badgeClass = "badge-pending";
                if (row.normalizedStatus === "Sudah Diterima") badgeClass = "badge-success";
                if (row.normalizedStatus === "Sebagian Diterima") badgeClass = "badge-partial";
                let pctDisp = Math.round(row.percent);
                let barColor = pctDisp === 100 ? 'bg-success' : 'bg-primary';

                inner = `<td class="fw-bold text-primary">${row.id}</td><td>${row.vendor}</td><td>${row.date}</td><td><span class="badge-status ${badgeClass}">${row.normalizedStatus}</span></td><td class="text-center">${row.itemsCount}</td><td class="fw-bold">${row.totalQty}</td><td class="fw-bold text-success">${row.totalArrived}</td><td><div class="d-flex align-items-center" style="width:120px"><div class="progress progress-thin flex-grow-1"><div class="progress-bar ${barColor}" style="width: ${pctDisp}%"></div></div><span class="ms-2 small fw-bold">${pctDisp}%</span></div></td><td class="text-end"><button class="btn btn-sm btn-light text-primary" onclick="showDetail('${row.id}')"><i class="bi bi-eye-fill"></i></button></td>`;
            } else if (currentTab === 'detail') {
                inner = `<td class="text-primary fw-bold small text-nowrap">${row.id}</td><td class="small text-nowrap">${row.date}</td><td class="small text-nowrap">${row.vendor}</td><td class="small text-nowrap">${row.inv || '-'}</td><td class="small text-nowrap">${row.po || '-'}</td><td class="small text-nowrap font-monospace text-muted">${row.kpc || '-'}</td><td class="fw-bold small">${row.item}</td><td class="text-end small">${row.qtyOrder}</td><td class="text-end small text-muted">${row.qtyBefore}</td><td class="text-end fw-bold text-success bg-light">${row.qtyNow}</td><td class="small">${row.uom}</td><td class="small text-nowrap text-primary fw-bold">${row.container || '-'}</td>`;
            }
            tr.innerHTML = inner;
            tbody.appendChild(tr);
        });
    }

    // --- MODAL DETAIL ---
    function showDetail(id) {
        const data = allData.find(d => d.id === id);
        if (!data) return;
        document.getElementById('modalTitle').innerText = CONFIG[currentTab].title;
        document.getElementById('modalInfoSection').innerHTML = `<div class="row g-3"><div class="col-6"><span class="info-label">ID</span><div class="info-value text-primary">${data.id}</div></div><div class="col-6"><span class="info-label">Vendor</span><div class="fw-bold">${data.vendor}</div></div></div>`;
        
        let headHtml = '<tr>'; CONFIG[currentTab].modalCols.forEach(h => headHtml += `<th class="py-2 px-3 border-bottom">${h}</th>`);
        document.getElementById('modalTableHead').innerHTML = headHtml + '</tr>';
        
        let bodyHtml = '';
        if(data.items) {
            data.items.forEach(item => {
                if(currentTab==='receiving') bodyHtml += `<tr><td class="px-3">${item.col1}</td><td class="px-3 fw-bold">${item.col2}</td><td class="px-3">${item.col3}</td><td class="px-3">${item.col4}</td><td class="px-3 text-end">${item.val1}</td><td class="px-3 text-end">${item.val2}</td><td class="px-3 text-end fw-bold text-success bg-light">${item.val3}</td></tr>`;
                else bodyHtml += `<tr><td class="px-3">${item.col1}</td><td class="px-3 fw-bold">${item.col2}</td><td class="px-3 text-end">${item.val1}</td><td class="px-3 text-end fw-bold text-success">${item.val2}</td><td class="px-3 text-end fw-bold text-danger">${item.val3}</td></tr>`;
            });
        }
        document.getElementById('modalTableBody').innerHTML = bodyHtml;
        new bootstrap.Modal(document.getElementById('detailModal')).show();
    }

    fetchData();
</script>
</body>
</html>
