<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Receiving Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Sortable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      font-family: "Segoe UI", Roboto, sans-serif;
      font-size: 13px;
      color: #333;
    }

    .top-bar {
      height: 50px;
      display: flex;
      align-items: center;
      padding: 0 48px;
      background: #ffffff;
      border-bottom: 1px solid #e1e4e8;
    }

    .brand-main { font-size:17px;font-weight:600;margin-right:6px;letter-spacing:0.08em; }
    .brand-sub { font-size:13px;color:#7a8699; }

    .page { max-width:1120px;margin:32px auto;padding:0 16px; }
    .card { background:#fff;border-radius:8px;box-shadow:0 0 0 1px rgba(15,23,42,.04),0 14px 30px rgba(15,23,42,.08);padding:24px 26px; }
    .card-title { font-size:20px;font-weight:600;color:#1f2933;margin-bottom:18px; }

    .row-flex {
      display:grid;
      grid-template-columns: minmax(160px,1fr) minmax(220px,1.2fr) minmax(210px,1.1fr);
      gap:24px;margin-bottom:18px;
      align-items:end;
    }

    label { font-size:12.5px;font-weight:600;color:#4a5568;margin-bottom:4px;display:block; }

    .input-box, .table-input, .choices__inner {
      height:30px !important;min-height:30px !important;
      padding:5px 8px !important;font-size:12.5px !important;
      border:1px solid #d0d7df !important;border-radius:5px !important;
      background:#f9fafb !important;box-sizing:border-box;
    }

    .summary-grid {
      display:grid;
      grid-template-columns: repeat(3, minmax(150px,1fr));
      gap:18px;background:#f5f7ff;
      border:1px solid #dde4ff;border-radius:6px;
      padding:12px;margin-bottom:16px;
    }
    .summary-label { font-size:11.5px;font-weight:600;color:#5a6478; }
    .summary-value { font-size:12.5px;font-weight:500; }
    .summary-muted { color:#6b7280;font-style:italic; }

    table { width:100%;border-collapse:collapse;border:1px solid #e3e6ea;background:#fff;border-radius:6px; }
    th { background:#edf0f5;font-size:12.5px;padding:6px;border-bottom:1px solid #e1e4e9;text-align:left; }
    td { font-size:12px;padding:4px;border-bottom:1px solid #f3f4f6; }

    .row-handle { cursor:grab;text-align:center;color:#999;font-size:13px; }
    .delete-btn { color:#cc1f2f;cursor:pointer;font-size:14px;text-align:center; }

    .notes-label { font-size:13px;font-weight:600;margin-top:18px; }
    textarea { width:100%;height:110px;padding:8px;border:1px solid #d0d7df;border-radius:6px;background:#f9fafb;resize:vertical; }

    .actions-row { margin-top:22px;display:flex;justify-content:flex-end;gap:12px;flex-wrap:wrap; }
    .submit-btn {
      background:#0f80d9;color:#fff;padding:9px 24px;border-radius:6px;
      font-size:13px;font-weight:600;cursor:pointer;border:none;
    }
    .submit-btn:hover { background:#0b66ad; }
    .secondary-btn { background:#e9eef8;border:1px solid #cfd6e5;padding:8px 16px;border-radius:6px;cursor:pointer; }

    #loadingOverlay { position:fixed;inset:0;background:rgba(255,255,255,.75);display:none;align-items:center;justify-content:center;z-index:9999; }
    .loading-spinner {
      width:42px;height:42px;border-radius:50%;
      border:5px solid #dae6f4;border-top-color:#2b6be8;
      animation:spin .85s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

  </style>
</head>

<body>

<div id="loadingOverlay"><div class="loading-spinner"></div></div>

<div class="top-bar">
  <span class="brand-main">UXILIUM</span>
  <span class="brand-sub">Receiving Entry â€” Coil Purchase</span>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">Receiving Entry (Based on PO - Purchase Coil)</div>

    <div class="row-flex">
      <div>
        <label>Receiving Date</label>
        <input type="date" id="receivingDate" class="input-box">
      </div>

      <div>
        <label>Inv Number</label>
        <select id="invSelect" class="input-box"></select>
      </div>

      <div>
        <label>Receiving ID</label>
        <input type="text" id="receivingId" class="input-box" readonly>
      </div>
    </div>

    <div class="summary-grid">
      <div>
        <div class="summary-label">Supplier</div>
        <div class="summary-value" id="summarySupplier"><span class="summary-muted">Select INV</span></div>
      </div>

      <div>
        <div class="summary-label">Invoice Date</div>
        <div class="summary-value" id="summaryDate">â€”</div>
      </div>

      <div>
        <div class="summary-label">Status</div>
        <div class="summary-value" id="summaryStatus">â€”</div>
      </div>

      <div>
        <div class="summary-label">Total Ordered</div>
        <div class="summary-value" id="summaryTotalOrdered">â€”</div>
      </div>

      <div>
        <div class="summary-label">Total Received</div>
        <div class="summary-value" id="summaryTotalReceived">â€”</div>
      </div>

      <div>
        <div class="summary-label">Total Remaining</div>
        <div class="summary-value" id="summaryTotalRemaining">â€”</div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th></th>
          <th>PO Number</th>
          <th>Item</th>
          <th>Ordered</th>
          <th>Received</th>
          <th>Remaining</th>
          <th>Qty This Receipt</th>
          <th>UoM</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div class="notes-label">Additional Notes</div>
    <textarea id="notes"></textarea>

    <div class="actions-row">
      <button class="secondary-btn" type="button" onclick="reloadINV()">Reload INV</button>
      <button class="submit-btn" type="button" onclick="submitReceiving()">Submit Receiving</button>
    </div>

  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwtG8vlcyBSfWl501-0HDO-iDozbyjihWf-n8IGmbgWZxQZWEzMzqhJXqmDtqXw8JB2YA/exec";



  let currentINV = null;

  function showLoading(){ loadingOverlay.style.display="flex"; }
  function hideLoading(){ loadingOverlay.style.display="none"; }

  async function loadNextReceivingId() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=getlastreceivingid`);
      const data = await res.json();
      const lastId = data.lastId || null;

      const today = new Date();
      const yy = String(today.getFullYear()).slice(2);
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const prefix = `RCV${yy}${mm}`;

      if (!lastId || !lastId.startsWith(prefix)) {
        receivingId.value = prefix + "0000001";
        return;
      }

      const seq = parseInt(lastId.substring(7), 10) + 1;
      receivingId.value = prefix + String(seq).padStart(7,"0");
    } catch(e){
      console.error(e);
      const today = new Date();
      const yy = String(today.getFullYear()).slice(2);
      const mm = String(today.getMonth()+1).padStart(2,"0");
      receivingId.value = `RCV${yy}${mm}0000001`;
    }
  }

  async function loadInvList(){
    const res = await fetch(`${SCRIPT_URL}?action=getinvlist`);
    const invList = await res.json();

    invSelect.innerHTML = "<option value='' disabled selected>â€” Select INV â€”</option>";

    invList.forEach(inv => {
      const opt = document.createElement("option");
      opt.value = inv.invNumber;
      opt.textContent = inv.invNumber;
      invSelect.appendChild(opt);
    });

    new Choices(invSelect,{searchEnabled:true,itemSelectText:"",shouldSort:false});

    invSelect.addEventListener("change",()=>loadInvDetail(invSelect.value));
  }

  function renderSummary(h) {
    summarySupplier.textContent = h.supplier || "-";
    summaryDate.textContent = h.invoiceDate || "-";
    summaryStatus.textContent = h.status || "-";
    summaryTotalOrdered.textContent = h.totalOrdered ?? "-";
    summaryTotalReceived.textContent = h.totalReceived ?? "-";
    summaryTotalRemaining.textContent = h.totalRemaining ?? "-";
  }

  async function loadInvDetail(invNumber) {
    showLoading();
    try {
      const res = await fetch(`${SCRIPT_URL}?action=getinvdetail&invNumber=${encodeURIComponent(invNumber)}`);
      currentINV = await res.json();

      renderSummary(currentINV.header);
      renderLines(currentINV.lines);
    } catch(e){
      console.error(e);
      alert("Error loading invoice detail.");
    } finally {
      hideLoading();
    }
  }

  function renderLines(lines){
    tableBody.innerHTML = "";
    lines.forEach(ln=>{
      const tr=document.createElement("tr");

      tr.dataset.rowIndex = ln.rowIndex;

      const ord = ln.orderedQty || 0;
      const rec = ln.receivedToDate || 0;
      const rem = ln.remainingQty || 0;

      tr.innerHTML=`
        <td class="row-handle">â‹®â‹®</td>
        <td>${ln.poNumber}</td>
        <td>
          <div style="font-weight:600">${ln.kpc}</div>
          <div style="font-size:11px;color:#6b7280">${ln.description}</div>
        </td>
        <td><input class="table-input" value="${ord}" readonly></td>
        <td><input class="table-input" value="${rec}" readonly></td>
        <td><input class="table-input remaining" value="${rem}" readonly></td>
        <td><input type="number" class="table-input qty-receipt" value="${rem}" min="0"></td>
        <td><input class="table-input" value="m" readonly></td>
        <td class="delete-btn" onclick="this.closest('tr').remove()">ðŸ—‘</td>
      `;

      tableBody.appendChild(tr);
    });

    tableBody.querySelectorAll(".qty-receipt").forEach(input=>{
      input.addEventListener("input",e=>{
        const tr=e.target.closest("tr");
        const remaining=parseFloat(tr.querySelector(".remaining").value)||0;
        let val=parseFloat(e.target.value)||0;
        if(val<0) val=0;
        if(val>remaining) val=remaining;
        e.target.value=val;
      });
    });

    Sortable.create(tableBody,{handle:".row-handle",animation:150});
  }

  function reloadINV(){
    if(invSelect.value) loadInvDetail(invSelect.value);
  }

  function validateForm(){
    if(!receivingDate.value) return "Receiving Date required.";
    if(!invSelect.value) return "Inv Number required.";

    const rows = Array.from(document.querySelectorAll("#tableBody tr"));
    if(!rows.length) return "No line items found.";

    let hasQty=false;
    for(const r of rows){
      const qty=parseFloat(r.querySelector(".qty-receipt").value)||0;
      const remaining=parseFloat(r.querySelector(".remaining").value)||0;
      if(qty>0) hasQty=true;
      if(qty>remaining) return "Qty cannot exceed Remaining.";
    }
    if(!hasQty) return "At least one item must have Qty > 0.";

    return null;
  }

  function submitReceiving(){
    const err=validateForm();
    if(err){ alert(err); return; }

    showLoading();

    const rows = Array.from(document.querySelectorAll("#tableBody tr"));
    const payloadLines = rows.map(r=>({
      rowIndex: r.dataset.rowIndex,
      poNumber: r.children[1].textContent.trim(),
      kpc: r.children[2].children[0].textContent.trim(),
      description: r.children[2].children[1].textContent.trim(),
      orderedQty: r.children[3].children[0].value,
      receivedToDate: r.children[4].children[0].value,
      remainingQty: r.children[5].children[0].value,
      qtyThisReceipt: r.children[6].children[0].value,
      uom: "m"
    }));

    const payload = {
      receivingId: receivingId.value,
      receivingDate: receivingDate.value,
      invNumber: invSelect.value,
      header: currentINV ? currentINV.header : {},
      notes: notes.value,
      lines: payloadLines
    };

    fetch(SCRIPT_URL,{
      method:"POST",
      body:JSON.stringify(payload)
    })
      .then(res=>res.json())
      .then(r=>{
        hideLoading();
        if(r.status==="success"){
          alert("Receiving saved.\nReceiving ID: "+payload.receivingId);
          loadNextReceivingId();
          reloadINV();
        } else {
          alert("Error: "+(r.message || "Unknown error"));
        }
      })
      .catch(err=>{
        hideLoading();
        alert("Submit failed: "+err);
      });
  }

  window.addEventListener("DOMContentLoaded",async()=>{
    showLoading();

    const t=new Date();
    receivingDate.value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;

    try {
      await Promise.all([loadNextReceivingId(),loadInvList()]);
    } catch(e){
      console.error(e);
      alert("Error initializing page. Check SCRIPT_URL.");
    }
    hideLoading();
  });
</script>

</body>
</html>
