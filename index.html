<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Stok Persediaan</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        body { background-color: #f0f2f5; min-height: 100vh; padding: 20px; }
        .card-header-title { background-color: #3e8ed0; color: white; }
        .positive-val { color: #2ecc71; font-weight: bold; } /* Hijau untuk Masuk */
        .negative-val { color: #e74c3c; font-weight: bold; } /* Merah untuk Keluar */
        .table-container { max-height: 60vh; overflow-y: auto; }
        
        /* Loading Spinner */
        .loader-wrapper {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 99;
            justify-content: center; align-items: center;
        }
        .loader-wrapper.is-active { display: flex; }
    </style>
</head>
<body>

    <div class="loader-wrapper" id="loader">
        <div class="button is-loading is-large is-info is-outlined" style="border:none;">Sedang Mengambil Data...</div>
    </div>

    <div class="container">
        <h1 class="title has-text-centered mb-6">ðŸ“¦ Portal Kartu Stok</h1>

        <div class="box">
            <div class="field">
                <label class="label">Pilih Nama Barang (Item Name)</label>
                <div class="control">
                    <div class="select is-fullwidth is-medium">
                        <select id="itemSelect" onchange="renderCard()">
                            <option value="">-- Menunggu Data... --</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="stockCard" class="card" style="display:none;">
            <header class="card-header">
                <p class="card-header-title" id="cardTitle">Nama Barang</p>
            </header>
            <div class="card-content">
                <nav class="level is-mobile">
                    <div class="level-item has-text-centered">
                        <div>
                            <p class="heading">Total Masuk</p>
                            <p class="title is-4 has-text-success" id="sumIn">0</p>
                        </div>
                    </div>
                    <div class="level-item has-text-centered">
                        <div>
                            <p class="heading">Total Keluar</p>
                            <p class="title is-4 has-text-danger" id="sumOut">0</p>
                        </div>
                    </div>
                    <div class="level-item has-text-centered">
                        <div>
                            <p class="heading">Sisa Stok</p>
                            <p class="title is-4 has-text-info" id="sumBal">0</p>
                        </div>
                    </div>
                </nav>
                <hr>
                
                <div class="table-container">
                    <table class="table is-fullwidth is-striped is-hoverable">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Kontak</th>
                                <th class="has-text-right">Masuk</th>
                                <th class="has-text-right">Keluar</th>
                                <th class="has-text-right">Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        // Link API yang kamu berikan sudah saya masukkan di sini:
        const API_URL = "https://script.google.com/macros/s/AKfycby4xFw3kLd0H9wLqWyMfG71iTi9JsBae-k1FH26lhU4seBxtA1JqGsyd5P5ryVcS4AP/exec"; 

        let globalData = [];
        let groupedData = {};

        // 1. Fetch Data saat Web Dibuka
        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('loader');
            const select = document.getElementById('itemSelect');
            
            loader.classList.add('is-active');

            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                globalData = data;
                processDataForDropdown(data);
                
                loader.classList.remove('is-active');
            } catch (error) {
                console.error("Gagal mengambil data:", error);
                // Pesan error lebih jelas untuk user
                alert("Gagal mengambil data. Pastikan izin Deploy AppScript adalah 'Anyone' (Siapa Saja).");
                loader.classList.remove('is-active');
                select.innerHTML = '<option>Error Memuat Data</option>';
            }
        });

        // 2. Mengelompokkan Data untuk Dropdown
        function processDataForDropdown(data) {
            // Grouping by itemName
            groupedData = data.reduce((acc, curr) => {
                const key = curr.itemName;
                if (!acc[key]) acc[key] = [];
                acc[key].push(curr);
                return acc;
            }, {});

            // Isi Dropdown dan urutkan A-Z
            const select = document.getElementById('itemSelect');
            select.innerHTML = '<option value="">-- Pilih Barang --</option>';
            
            Object.keys(groupedData).sort().forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.text = key;
                select.appendChild(option);
            });
        }

        // 3. Render Kartu Stok saat Dropdown Dipilih
        function renderCard() {
            const selectedItem = document.getElementById('itemSelect').value;
            const cardArea = document.getElementById('stockCard');
            
            if (!selectedItem) {
                cardArea.style.display = 'none';
                return;
            }

            // Ambil transaksi barang tersebut
            let transactions = groupedData[selectedItem];

            // Sort berdasarkan Tanggal (Terlama ke Terbaru)
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            let runningBalance = 0;
            let totalIn = 0;
            let totalOut = 0;

            transactions.forEach(row => {
                // Parsing Data
                const qty = parseFloat(row.qty) || 0;
                const dateRaw = new Date(row.date);
                const dateStr = dateRaw.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' });
                
                // --- LOGIKA STOK (Masuk/Keluar) ---
                let inVal = 0;
                let outVal = 0;

                // Logika: Jika Status "Positive" DAN qty positif = MASUK
                // Jika tidak (Status Negative atau qty minus) = KELUAR
                if (row.status === 'Positive' && qty >= 0) {
                    inVal = qty;
                } else {
                    outVal = Math.abs(qty); 
                }

                // Update Saldo
                runningBalance = runningBalance + inVal - outVal;
                totalIn += inVal;
                totalOut += outVal;

                // Render Baris Tabel
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td><small>${row.contact}</small></td>
                    <td class="has-text-right positive-val">${inVal > 0 ? inVal.toLocaleString('id-ID') : '-'}</td>
                    <td class="has-text-right negative-val">${outVal > 0 ? outVal.toLocaleString('id-ID') : '-'}</td>
                    <td class="has-text-right"><strong>${runningBalance.toLocaleString('id-ID')}</strong></td>
                `;
                tbody.appendChild(tr);
            });

            // Update Header & Summary
            document.getElementById('cardTitle').innerText = selectedItem;
            document.getElementById('sumIn').innerText = totalIn.toLocaleString('id-ID');
            document.getElementById('sumOut').innerText = totalOut.toLocaleString('id-ID');
            document.getElementById('sumBal').innerText = runningBalance.toLocaleString('id-ID');

            cardArea.style.display = 'block';
        }
    </script>
</body>
</html>
