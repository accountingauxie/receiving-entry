<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory KPC FG - Auxilium Style</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root { 
    --primary-color: #116999; 
    --bg-color: #f8fafc; 
    --text-color: #333; 
    --border-color: #eaecf0;
  }
  body { 
    font-family: "Inter", sans-serif; 
    background: var(--bg-color); 
    color: var(--text-color); 
  }

  /* Navbar Style */
  .aux-navbar {
    background-color: #ffffff;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    position: sticky; top: 0; z-index: 50;
  }
   
  /* Table Style */
  .table-header { 
    background-color: #f8fafc; 
    color: #64748b; 
    font-size: 12px; 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: 0.05em; 
    cursor: pointer; 
    user-select: none;
    transition: background-color 0.2s;
  }
  .table-header:hover { background-color: #e2e8f0; color: #334155; }
  .table-row { border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
  .table-row:hover { background-color: #f8fafc; }
   
  /* Loading Spinner */
  #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 50000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
  .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #3b82f6; border-radius: 50%; width: 45px; height: 45px; animation: spin 0.8s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* Pill/Tabs */
  .filter-pill { cursor: pointer; padding: 6px 16px; border-radius: 9999px; font-size: 13px; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
  .pill-active { background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
  .pill-inactive { background-color: white; color: #64748b; border-color: #e2e8f0; }
  .pill-inactive:hover { background-color: #f1f5f9; color: #334155; }

  /* Custom Checkbox Style */
  .custom-checkbox {
      appearance: none;
      background-color: #fff;
      margin: 0;
      font: inherit;
      color: currentColor;
      width: 1.15em;
      height: 1.15em;
      border: 1px solid #cbd5e1;
      border-radius: 0.25em;
      display: grid;
      place-content: center;
      cursor: pointer;
  }
  .custom-checkbox::before {
      content: "";
      width: 0.65em;
      height: 0.65em;
      transform: scale(0);
      transition: 120ms transform ease-in-out;
      box-shadow: inset 1em 1em white;
      transform-origin: center;
      clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
  }
  .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
  .custom-checkbox:checked::before { transform: scale(1); }
</style>
</head>

<body>

  <div class="aux-navbar">
    <div class="flex items-center gap-3">
        <div class="font-bold text-xl text-slate-800 flex items-center gap-2">
            <i class="fas fa-layer-group text-blue-600"></i> KPC Inventory
        </div>
    </div>
    <div class="flex items-center gap-4">
        <div class="text-right hidden sm:block">
            <div class="text-xs text-slate-500">Data Source</div>
            <div class="text-sm font-semibold text-slate-800">Sheet: KPC FG</div>
        </div>
        <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm">
            AG
        </div>
    </div>
  </div>

  <div id="loading"><div class="spinner"></div></div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
      <div>
          <h1 class="text-2xl font-bold text-slate-900 tracking-tight">KPC Finished Goods</h1>
          <p class="text-sm text-slate-500 mt-1">Monitoring stok, nilai aset, dan penggunaan mesin.</p>
      </div>
      <div class="flex gap-3">
          <a href="#" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center">
              <i class="fas fa-arrow-left mr-2"></i> Kembali
          </a>
          <button onclick="fetchData()" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center">
              <i class="fas fa-sync-alt mr-2"></i> Refresh Data
          </button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden transition-all duration-300">
        <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Items (KPC)</div>
        <div class="flex items-baseline"><span class="text-3xl font-bold text-slate-800" id="stat-total-items">0</span></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden transition-all duration-300">
        <div class="absolute right-0 top-0 h-full w-1 bg-emerald-500"></div>
        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Quantity (KG)</div>
        <div class="flex items-baseline"><span class="text-3xl font-bold text-slate-800" id="stat-total-qty">0</span> <span class="ml-2 text-sm text-slate-400">kg</span></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden transition-all duration-300">
        <div class="absolute right-0 top-0 h-full w-1 bg-amber-500"></div>
        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Asset Value</div>
        <div class="flex items-baseline"><span class="text-xl font-bold text-slate-800" id="stat-total-value">Rp 0</span></div>
      </div>
    </div>

    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
        
        <div class="flex gap-2 overflow-x-auto pb-2 w-full lg:w-auto no-scrollbar" id="machine-filters">
            <button onclick="quickFilterMachine('All')" class="filter-pill pill-active" id="btn-All">All Machines</button>
        </div>

        <div class="flex items-center gap-2 w-full lg:w-auto">
            <button onclick="toggleFilterModal()" class="relative flex items-center justify-center px-4 py-2 border border-slate-300 rounded-lg bg-white text-slate-600 hover:bg-slate-50 hover:text-slate-800 transition shadow-sm">
                <i class="fas fa-filter mr-2"></i> Filter
                <span id="active-filter-badge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-white">0</span>
            </button>

            <div class="relative w-full lg:w-72">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-slate-400"></i></div>
                <input type="text" id="searchInput" onkeyup="renderTable()" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 sm:text-sm shadow-sm transition" placeholder="Cari KPC, Item...">
            </div>
        </div>
    </div>

    <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden min-h-[400px]">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th scope="col" onclick="handleSort('kpc')" class="px-6 py-3 text-left table-header">KPC Number <i id="sort-icon-kpc" class="fas fa-sort ml-1 text-slate-400"></i></th>
                        <th scope="col" onclick="handleSort('itemProduced')" class="px-6 py-3 text-left table-header">Item Name <i id="sort-icon-itemProduced" class="fas fa-sort ml-1 text-slate-400"></i></th>
                        <th scope="col" onclick="handleSort('machine')" class="px-6 py-3 text-left table-header">Machine <i id="sort-icon-machine" class="fas fa-sort ml-1 text-slate-400"></i></th>
                        <th scope="col" onclick="handleSort('qty')" class="px-6 py-3 text-right table-header">Qty (kg) <i id="sort-icon-qty" class="fas fa-sort ml-1 text-slate-400"></i></th>
                        <th scope="col" onclick="handleSort('price')" class="px-6 py-3 text-right table-header">Price (Unit) <i id="sort-icon-price" class="fas fa-sort ml-1 text-slate-400"></i></th>
                        <th scope="col" onclick="handleSort('itemCode')" class="px-6 py-3 text-left table-header">Xero Code <i id="sort-icon-itemCode" class="fas fa-sort ml-1 text-slate-400"></i></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-100" id="table-body">
                </tbody>
            </table>
        </div>
        <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
            <span class="text-xs text-slate-500" id="showing-info">Showing 0 entries</span>
        </div>
    </div>

  </div>

  <div id="filterModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900 bg-opacity-40 transition-opacity backdrop-blur-sm" onclick="toggleFilterModal()"></div>

    <div class="flex items-center justify-center min-h-screen p-4 text-center sm:p-0">
        <div class="relative bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:max-w-3xl w-full">
            
            <div class="bg-white px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-bold text-slate-900" id="modal-title"><i class="fas fa-sliders-h mr-2 text-blue-600"></i> Filter Data</h3>
                <button onclick="toggleFilterModal()" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="px-6 py-6 max-h-[70vh] overflow-y-auto bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Item Name</div>
                        <div class="space-y-2 max-h-60 overflow-y-auto pr-2" id="filter-container-itemProduced">
                            </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Machine</div>
                        <div class="space-y-2 max-h-60 overflow-y-auto pr-2" id="filter-container-machine">
                            </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Xero Code</div>
                        <div class="space-y-2 max-h-60 overflow-y-auto pr-2" id="filter-container-itemCode">
                           </div>
                    </div>

                </div>
            </div>

            <div class="bg-white px-6 py-4 border-t border-slate-100 flex justify-between items-center">
                <button onclick="resetFilters()" class="text-sm text-slate-500 hover:text-red-600 font-medium">Reset All</button>
                <div class="flex gap-3">
                    <button onclick="toggleFilterModal()" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 text-sm font-medium">Cancel</button>
                    <button onclick="applyAdvancedFilters()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md text-sm font-medium">Apply Filter</button>
                </div>
            </div>

        </div>
    </div>
  </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzEWjrouJixlNXuqm0zkI_zoGWinte7rQBbJ5T5cruHuwM-Bd5rJ_hBMMWsGT1Jw8JN/exec"; 

    let rawData = [];
    
    // State Variables
    let currentTabMachine = 'All'; // Quick filter (Tabs)
    let currentSort = { column: null, direction: 'asc' };
    
    // Advanced Filters State
    let activeFilters = {
        itemProduced: [],
        machine: [],
        itemCode: []
    };

    document.addEventListener('DOMContentLoaded', () => {
        feather.replace();
        fetchData();
    });

    function cleanNumber(val) {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        const cleanStr = String(val).replace(/,/g, '');
        return parseFloat(cleanStr) || 0;
    }

    async function fetchData() {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            if (!Array.isArray(data)) throw new Error("Format data salah");
            
            rawData = data;
            
            initTabFilters();     // Generate tab mesin
            populateFilterModal(); // Generate checkbox di modal
            renderTable();

        } catch (error) {
            console.error(error);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Gagal memuat data.' });
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // --- QUICK TAB FILTER ---
    function initTabFilters() {
        const machines = [...new Set(rawData.map(item => item.machine).filter(m => m))].sort();
        const container = document.getElementById('machine-filters');
        
        container.innerHTML = '<button onclick="quickFilterMachine(\'All\')" class="filter-pill pill-active" id="btn-All">All Machines</button>';

        machines.forEach(m => {
            const cleanId = m.replace(/[^a-zA-Z0-9]/g, '');
            const btn = document.createElement('button');
            btn.className = 'filter-pill pill-inactive whitespace-nowrap';
            btn.id = `btn-${cleanId}`;
            btn.textContent = m;
            btn.onclick = () => quickFilterMachine(m);
            container.appendChild(btn);
        });
    }

    function quickFilterMachine(machineName) {
        currentTabMachine = machineName;
        // Update UI Tabs
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.classList.remove('pill-active');
            btn.classList.add('pill-inactive');
        });
        const targetId = machineName === 'All' ? 'btn-All' : `btn-${machineName.replace(/[^a-zA-Z0-9]/g, '')}`;
        const activeBtn = document.getElementById(targetId);
        if(activeBtn) {
            activeBtn.classList.remove('pill-inactive');
            activeBtn.classList.add('pill-active');
        }
        renderTable();
    }

    // --- ADVANCED MODAL FILTER LOGIC ---
    
    function toggleFilterModal() {
        const modal = document.getElementById('filterModal');
        modal.classList.toggle('hidden');
    }

    function populateFilterModal() {
        // Helper untuk generate checkbox group
        const createCheckboxes = (key, containerId) => {
            const uniqueValues = [...new Set(rawData.map(d => d[key]).filter(v => v))].sort();
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            uniqueValues.forEach(val => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                // Cek apakah value ini sedang aktif di filter state
                const isChecked = activeFilters[key].includes(val) ? 'checked' : '';
                
                div.innerHTML = `
                    <input id="chk-${key}-${val}" type="checkbox" value="${val}" class="custom-checkbox text-blue-600 focus:ring-blue-500 rounded border-gray-300" ${isChecked}>
                    <label for="chk-${key}-${val}" class="ml-2 text-sm text-slate-600 cursor-pointer truncate" title="${val}">${val}</label>
                `;
                container.appendChild(div);
            });
        };

        createCheckboxes('itemProduced', 'filter-container-itemProduced');
        createCheckboxes('machine', 'filter-container-machine');
        createCheckboxes('itemCode', 'filter-container-itemCode');
    }

    function applyAdvancedFilters() {
        // Ambil nilai dari semua checkbox yang dicentang
        const getCheckedValues = (key, containerId) => {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        };

        activeFilters.itemProduced = getCheckedValues('itemProduced', 'filter-container-itemProduced');
        activeFilters.machine = getCheckedValues('machine', 'filter-container-machine');
        activeFilters.itemCode = getCheckedValues('itemCode', 'filter-container-itemCode');

        // Hitung total filter aktif untuk badge
        const totalActive = activeFilters.itemProduced.length + activeFilters.machine.length + activeFilters.itemCode.length;
        const badge = document.getElementById('active-filter-badge');
        
        if (totalActive > 0) {
            badge.innerText = totalActive;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }

        toggleFilterModal();
        renderTable();
    }

    function resetFilters() {
        activeFilters = { itemProduced: [], machine: [], itemCode: [] };
        document.getElementById('active-filter-badge').classList.add('hidden');
        
        // Uncheck semua box visual
        document.querySelectorAll('#filterModal input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        toggleFilterModal();
        renderTable();
    }


    // --- SORTING LOGIC ---
    function handleSort(column) {
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }
        updateSortIcons(column);
        renderTable();
    }

    function updateSortIcons(activeColumn) {
        document.querySelectorAll('[id^="sort-icon-"]').forEach(icon => {
            icon.className = 'fas fa-sort ml-1 text-slate-400';
        });
        const activeIcon = document.getElementById(`sort-icon-${activeColumn}`);
        if (activeIcon) {
            activeIcon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} ml-1 text-blue-600`;
        }
    }

    // --- RENDER & CALCULATION ---
    function updateStats(dataSet) {
        const totalItems = dataSet.length;
        const totalQty = dataSet.reduce((sum, item) => sum + cleanNumber(item.qty), 0);
        const totalValue = dataSet.reduce((sum, item) => sum + (cleanNumber(item.qty) * cleanNumber(item.price)), 0);

        document.getElementById('stat-total-items').innerText = new Intl.NumberFormat('id-ID').format(totalItems);
        document.getElementById('stat-total-qty').innerText = new Intl.NumberFormat('id-ID', { maximumFractionDigits: 2 }).format(totalQty);
        document.getElementById('stat-total-value').innerText = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalValue);
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        
        tbody.innerHTML = '';

        // --- FILTERING ---
        let filteredData = rawData.filter(item => {
            // 1. Search Text
            const searchString = `${item.kpc} ${item.coilName} ${item.itemProduced} ${item.itemCode} ${item.machine}`.toLowerCase();
            const matchSearch = searchString.includes(searchInput);

            // 2. Tab Machine Filter (Quick Filter)
            // Note: Jika di Advanced Filter Machine dipilih, kita abaikan Tab ini atau combine. 
            // Disini saya buat: Tab harus match, KECUALI user pakai Advanced Filter Machine.
            // Jika user pakai Advanced Filter Machine, Tab dianggap 'All' otomatis secara logika.
            let matchTab = true;
            if (activeFilters.machine.length === 0) {
                 matchTab = currentTabMachine === 'All' || item.machine === currentTabMachine;
            }

            // 3. Advanced Filters
            // Jika array kosong = tidak ada filter = true. Jika ada isi, item harus ada di list.
            const matchAdvItem = activeFilters.itemProduced.length === 0 || activeFilters.itemProduced.includes(item.itemProduced);
            const matchAdvMachine = activeFilters.machine.length === 0 || activeFilters.machine.includes(item.machine);
            const matchAdvCode = activeFilters.itemCode.length === 0 || activeFilters.itemCode.includes(item.itemCode);

            return matchSearch && matchTab && matchAdvItem && matchAdvMachine && matchAdvCode;
        });

        // --- SORTING ---
        if (currentSort.column) {
            filteredData.sort((a, b) => {
                let valA = a[currentSort.column];
                let valB = b[currentSort.column];
                if (currentSort.column === 'qty' || currentSort.column === 'price') {
                    valA = cleanNumber(valA);
                    valB = cleanNumber(valB);
                } else {
                    valA = (valA || '').toString().toLowerCase();
                    valB = (valB || '').toString().toLowerCase();
                }
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        updateStats(filteredData);
        document.getElementById('showing-info').innerText = `Showing ${filteredData.length} entries`;

        if (filteredData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">Tidak ada data ditemukan.</td></tr>`;
            return;
        }

        filteredData.forEach(row => {
            const fmtQty = new Intl.NumberFormat('id-ID').format(cleanNumber(row.qty));
            const fmtPrice = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(cleanNumber(row.price));

            const tr = document.createElement('tr');
            tr.className = 'table-row';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-bold text-slate-900">${row.kpc || '-'}</div>
                    <div class="text-xs text-slate-500">${row.coilName || ''}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-slate-900 font-medium">${row.itemProduced || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                        ${row.machine || 'N/A'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <div class="text-sm font-mono font-bold text-slate-700">${fmtQty}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <div class="text-sm text-slate-600">${fmtPrice}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col gap-1">
                        <span class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">ITEM: <span class="text-slate-600 font-mono font-normal normal-case">${row.itemCode || '-'}</span></span>
                        <span class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">XERO: <span class="text-slate-600 font-mono font-normal normal-case">${row.accountXero || '-'}</span></span>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
</script>

</body>
</html>
